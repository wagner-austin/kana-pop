(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function t(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(n){if(n.ep)return;n.ep=!0;const s=t(n);fetch(n.href,s)}})();function J(a){const e=window.devicePixelRatio||1,{clientWidth:t,clientHeight:i}=a;return a.width=Math.floor(t*e),a.height=Math.floor(i*e),{w:t,h:i,dpr:e}}class V{constructor(){this.listeners=new Set,this.watchedCanvases=new Map,this.mediaQuery=null,this.boundTrigger=this.trigger.bind(this),this.dprCallback=null,this.metrics={w:0,h:0,dpr:1}}subscribe(e){this.listeners.add(e),e(),this.listeners.size===1&&this.attachWindowListeners()}unsubscribe(e){this.listeners.delete(e),this.listeners.size===0&&this.detachWindowListeners()}watchCanvas(e){const t=()=>{const i=J(e);this.metrics=i};this.watchedCanvases.set(e,t),this.subscribe(t)}unwatchCanvas(e){const t=this.watchedCanvases.get(e);t&&(this.unsubscribe(t),this.watchedCanvases.delete(e))}trigger(){this.listeners.forEach(e=>e())}attachWindowListeners(){typeof window<"u"&&(window.addEventListener("resize",this.boundTrigger),this.addDprListener())}detachWindowListeners(){var e;typeof window<"u"&&window.removeEventListener("resize",this.boundTrigger),this.dprCallback&&((e=this.mediaQuery)==null||e.removeEventListener("change",this.dprCallback)),this.mediaQuery=null,this.dprCallback=null}addDprListener(){var e;typeof window>"u"||typeof window.matchMedia>"u"||(this.dprCallback&&((e=this.mediaQuery)==null||e.removeEventListener("change",this.dprCallback)),this.mediaQuery=matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`),this.dprCallback=()=>{this.boundTrigger(),this.addDprListener()},this.mediaQuery.addEventListener("change",this.dprCallback,{once:!0}))}get cssWidth(){return this.metrics.w}get cssHeight(){return this.metrics.h}get dpr(){return this.metrics.dpr}}const A=new V,Z=["#FFD1DC","#B5EAD7","#C7CEEA","#FFDAC1","#E2F0CB"],ee={colors:Z},te=1.2,ne=.5,S=ee.colors,U=S[2],q="#222",ie="Noto Sans JP, sans-serif",se=q,ae=.7,oe=.4,w=class w{constructor(e,t=w.bootLevel){this.scope=e,this.level=t}out(e,...t){}debug(...e){this.out("debug",...e)}info(...e){this.out("info",...e)}warn(...e){this.out("warn",...e)}error(...e){this.out("error",...e)}};w.bootLevel=(()=>{if(typeof globalThis>"u"||!("localStorage"in globalThis))return"info";const e=localStorage.getItem("logLevel");return e&&["debug","info","warn","error","off"].includes(e)?e:"info"})(),w.isDebug=w.bootLevel==="debug",w.levelOrder={debug:0,info:1,warn:2,error:3,off:4};let h=w;function re(){return{setLevel(a){localStorage.setItem("logLevel",a),location.reload()}}}window.logger=re();const ce=new h("SM");class le{constructor(){this.states=new Map}add(e,t){return this.states.set(e,t),this}change(e){var t,i,n,s;ce.info("→ change",{from:this.currentName,to:e}),(i=(t=this.current)==null?void 0:t.exit)==null||i.call(t),this.current=this.states.get(e),this.currentName=e,(s=(n=this.current)==null?void 0:n.enter)==null||s.call(n)}update(e){var t,i;(i=(t=this.current)==null?void 0:t.update)==null||i.call(t,e)}get currentStateName(){return this.currentName}}function y(a){const{clientWidth:e,clientHeight:t}=a;return{w:e,h:t}}function G(a){const e=window.devicePixelRatio||1;a.setTransform(1,0,0,1,0,0),a.scale(e,e)}function de(a,e){const t=()=>a.change("play");function i(){G(e);const{w:n,h:s}=y(e.canvas);e.fillStyle=U,e.fillRect(0,0,n,s),e.fillStyle=q,e.textAlign="center",e.font="32px sans-serif",e.fillText("Tap to Start",n/2,s/2)}return{enter(){A.subscribe(i),e.canvas.addEventListener("pointerdown",t),e.canvas.addEventListener("touchstart",t)},update(){i()},exit(){A.unsubscribe(i),e.canvas.removeEventListener("pointerdown",t),e.canvas.removeEventListener("touchstart",t)}}}function ue(){if(typeof navigator>"u")return!1;const a=typeof navigator>"u"?"":navigator.userAgent;return/iPad|iPhone|iPod/.test(a)&&!(typeof window<"u"&&window.MSStream)}function he(){if(typeof navigator>"u")return!1;const a=typeof navigator>"u"?"":navigator.userAgent;return/iPad/.test(a)||typeof navigator<"u"&&navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1}function R(){if(typeof navigator>"u")return!1;if(ue()||he())return!0;const a=typeof navigator>"u"?"":navigator.userAgent;return!!(/iPad|iPhone|iPod/.test(a)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>0)}const b=new h("Audio");class fe{constructor(){this.bank=new Map}async ensureContext(){const e=()=>{const t=globalThis,i=t.AudioContext??t.webkitAudioContext;if(!i)throw new Error("Web Audio API not supported");const n=new i;return b.info(`Created new AudioContext: ${n.state}`),n};if((!this.ctx||this.ctx.state==="closed")&&(this.ctx=e()),this.ctx.state==="suspended"||this.ctx.state==="interrupted"){b.info(`Attempting resume() from ${this.ctx.state}`);try{await this.ctx.resume()}catch(t){b.warn("resume() threw",t)}}if(this.ctx.state!=="running"){b.warn(`AudioContext stuck in '${this.ctx.state}', recreating…`);try{await this.ctx.close()}catch{}this.ctx=e(),await this.ctx.resume()}return this.ctx}async fetch(e){if(this.bank.has(e))return this.bank.get(e);try{const t=await(await fetch(e)).arrayBuffer(),n=await(await this.ensureContext()).decodeAudioData(t);return this.bank.set(e,n),n}catch(t){throw b.error(`decodeAudioData failed for ${e}`,t),t}}async play(e){const t=await this.ensureContext(),i=t.createBufferSource();i.buffer=e,i.connect(t.destination),i.start(),i.onended=()=>i.disconnect()}async resume(){try{const e=await this.ensureContext();if(R()){b.info("iOS/iPadOS detected, playing silent buffer to unlock audio");const t=e.sampleRate||44100,i=e.createBuffer(2,t*.5,t);for(let o=0;o<2;o++){const l=i.getChannelData(o);for(let c=0;c<l.length;c++)l[c]=0}const n=R()?.5:.1,s=e.createGain();s.gain.value=.001;const r=e.createBufferSource();r.buffer=i,r.connect(s),s.connect(e.destination),r.start(0),r.stop(e.currentTime+n),r.onended=()=>{r.disconnect(),s.disconnect()},b.info(`Silent buffer played (duration: ${n}s)`)}return e}catch(e){throw b.error("Resume failed",e),e}}}const ge="modulepreload",me=function(a){return"/kana-pop/"+a},N={},B=function(e,t,i){let n=Promise.resolve();if(t&&t.length>0){let r=function(c){return Promise.all(c.map(u=>Promise.resolve(u).then(f=>({status:"fulfilled",value:f}),f=>({status:"rejected",reason:f}))))};document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),l=(o==null?void 0:o.nonce)||(o==null?void 0:o.getAttribute("nonce"));n=r(t.map(c=>{if(c=me(c),c in N)return;N[c]=!0;const u=c.endsWith(".css"),f=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${f}`))return;const m=document.createElement("link");if(m.rel=u?"stylesheet":ge,u||(m.as="script"),m.crossOrigin="",m.href=c,l&&m.setAttribute("nonce",l),document.head.appendChild(m),u)return new Promise((X,K)=>{m.addEventListener("load",X),m.addEventListener("error",()=>K(new Error(`Unable to preload CSS for ${c}`)))})}))}function s(r){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=r,window.dispatchEvent(o),!o.defaultPrevented)throw r}return n.then(r=>{for(const o of r||[])o.status==="rejected"&&s(o.reason);return e().catch(s)})},Q=[{code:"ja",name:"Japanese · Kana",direction:"ltr"},{code:"ar",name:"Arabic",direction:"rtl"}],be=Object.freeze(Object.defineProperty({__proto__:null,default:Q},Symbol.toStringTag,{value:"Module"})),$=new h("Storage");class pe{constructor(){this.isNative=!1,this.storage=this.detectStorage()}detectStorage(){if(typeof window<"u"&&typeof localStorage=="object")try{const e="__storage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),$.debug("Using native localStorage"),this.isNative=!0,localStorage}catch(e){$.warn("localStorage detected but unavailable (Safari private mode?), using memory storage",e)}else $.info("No localStorage available (Node/test environment), using memory storage");return new Map}get(e){if(this.isNative)return this.storage.getItem(e);const t=this.storage;return t.has(e)?t.get(e):null}set(e,t){this.isNative?this.storage.setItem(e,t):this.storage.set(e,t)}remove(e){this.isNative?this.storage.removeItem(e):this.storage.delete(e)}clear(){this.isNative?this.storage.clear():this.storage.clear()}}const _=new pe,p=new h("Lang"),v=Q,we=Object.assign({"../data/lang/index.json":()=>B(()=>Promise.resolve().then(()=>be),void 0).then(a=>a.default),"../data/lang/ja.json":()=>B(()=>import("./ja-DEJkL8aw.js"),[]).then(a=>a.default)});class ye{constructor(){var n;const e=_.get("kanaPop.lang"),t=(n=navigator.language)==null?void 0:n.slice(0,2);this.defaultCode=e||t||"ja";let i=v.find(s=>s.code===this.defaultCode);i||(p.warn(`Default code '${this.defaultCode}' not in manifest. Falling back to first manifest entry or 'ja'.`),i=v.find(s=>s.code==="ja")||v[0]),i?this.lang={code:i.code,name:i.name,symbols:[],direction:i.direction}:(p.error("CRITICAL - Language manifest is empty or essential fallbacks are missing. App functionality will be severely impaired."),this.lang={code:this.defaultCode,name:"Error: Language Undefined",symbols:[],direction:"ltr"})}async load(e=this.defaultCode){const t=v.find(r=>r.code===e);if(!t){if(p.error(`Language code '${e}' not found in manifest. Attempting to fall back.`),e!==this.defaultCode&&v.find(o=>o.code===this.defaultCode))return p.warn(`Falling back to default language '${this.defaultCode}'.`),this.load(this.defaultCode);throw new Error(`LanguageService: Language code '${e}' (and default '${this.defaultCode}') not found in manifest.`)}if(e==="index")throw new Error("LanguageService: index.json is the manifest, not a language data file.");const i=`../data/lang/${e}.json`,n=we[i];if(!n)throw p.error(`No data file loader found for code '${e}' (path: '${i}'). Check glob pattern and file existence.`),new Error(`LanguageService: No data file loader for '${e}'.`);let s;try{s=await n()}catch(r){throw p.error(`Failed to load language data file for code '${e}' from '${i}'.`,r),new Error(`LanguageService: Failed to load data for '${e}'.`)}this.lang={symbols:s.symbols||[],code:t.code||s.code,name:t.name,direction:t.direction},s.code&&s.code!==t.code&&(p.warn(`Mismatch! Requested/Manifest code '${t.code}', but file contains code '${s.code}'. Prioritizing manifest code.`),this.lang.code=t.code),this.persistLang(this.lang.code)}get symbols(){return this.lang.symbols}get currentCode(){return this.lang.code}get direction(){return this.lang.direction}randomGlyph(e){const t=Object.values(e.glyphs);return t.length===0?(p.warn(`Symbol with roman='${e.roman}' (category: ${e.category}, lang: ${this.lang.code}) has no glyphs defined. Returning '?' as fallback.`),"?"):t[Math.floor(Math.random()*t.length)]}persistLang(e){_.set("kanaPop.lang",e)}}const g=new ye,d=new h("Sound"),P=class P{constructor(){this.bank=new fe,this.isGestureArmed=!1,this.ready=new Promise(e=>this.triggerReady=e),typeof document<"u"&&document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&(d.debug("Page became visible – poking AudioContext"),this.bank.ensureContext().catch(()=>{}))})}async armFirstGesture(e=window){if(this.isGestureArmed)return;this.isGestureArmed=!0,d.info("First gesture handler armed");const t=R(),i=[],n=(o,l)=>{o.addEventListener(l,r,{passive:!0}),i.push({target:o,type:l})},s=()=>{d.info("Trimming audio unlock listeners (keeping one for re-unlock)");let o=!1;i.forEach(({target:l,type:c})=>{if(!o&&l===window&&c==="pointerdown"){o=!0;return}l.removeEventListener(c,r)})},r=async()=>{d.info("User gesture detected, unlocking audio");let o=!1;try{await this.bank.resume(),d.info("Audio context unlocked successfully"),o=!0}catch(l){d.warn("AudioContext unlock failed, trying HTML Audio fallback",l);try{const c=new Audio(P.SILENT);c.autoplay=!0,c.muted=!1,c.volume=.001,c.setAttribute("playsinline",""),d.info("Playing fallback HTML audio");const u=c.play();if(u instanceof Promise){await u,d.info("Fallback audio played successfully");try{await this.bank.resume(),d.info("Audio context unlocked after HTML audio fallback"),o=!0}catch(f){d.warn("Audio context still locked after HTML audio fallback",f)}}else d.warn("Fallback audio play() returned no promise")}catch(c){d.error("All audio unlock attempts failed",c)}}this.triggerReady(),o?s():d.warn("Audio still locked – listeners stay armed for another try")};d.info("Registering audio unlock gesture handlers"),n(e,"pointerdown"),n(e,"touchstart"),n(e,"click"),t&&(d.info("Adding extra handlers for iOS/iPadOS"),n(document.body,"pointerdown"),n(document.body,"touchstart"),n(document.body,"click"),n(document,"pointerdown"),n(document,"touchstart"),n(document,"click"),n(window,"pointerdown"),n(window,"touchstart"),n(window,"click"))}async play(e){if(await this.ready,e.endsWith("fallback.mp3"))return;const t=W(`/kana-pop/audio/${e}`);try{const i=await this.bank.fetch(t);await this.bank.play(i)}catch(i){d.warn(`Web Audio playback failed for ${t}, using HTMLAudioElement fallback`,i),new Audio(t).play().catch(n=>{d.error(`HTMLAudioElement fallback also failed for ${t}`,n)})}}playRoman(e){var i;const t=(i=g.symbols.find(n=>n.roman===e))==null?void 0:i.audio;t&&this.play(`${g.currentCode}/${t}`)}async preloadAll(e){await this.ready,d.info(`Preloading ${e.length} audio files`),await Promise.all(e.map(t=>{if(t.endsWith("fallback.mp3"))return Promise.resolve();const i=W(`/kana-pop/audio/${t}`);return this.bank.fetch(i).catch(n=>{d.warn(`Failed to preload audio: ${t}`,n)})})),d.info("Audio preloading complete")}};P.SILENT="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAIlYAACJWAAABAAgAZGF0YQAAAAA=";let F=P;const j=new F;function W(a){return a.startsWith("data:")?a:`${a}?v=mbj4lngw`}const H=new h("Bubble");class ve{constructor(e,t,i,n,s,r){this.x=e,this.y=t,this.color=i,this.glyph=n,this.romaji=s,this.active=!0,this.speed=.2,this.showingRomaji=!1,this.lastSpoken=-1/0,this.r=r,H.debug("spawn",{x:this.x.toFixed(2),color:i,glyph:this.glyph})}handleClick(e){e-this.lastSpoken<oe||(this.lastSpoken=e,this.showingRomaji=!this.showingRomaji,j.playRoman(this.romaji),H.debug("toggle",{romaji:this.showingRomaji}))}step(e){this.y-=this.speed*e,this.y<-.05&&(this.active=!1)}contains(e,t,i,n){if(!this.active)return!1;const s=this.x*i,r=this.y*n,o=e-s,l=t-r;return o*o+l*l<=this.r*this.r}}function z(a,e){return Math.min(a,e)*.06}const Ae=new h("BubbleMgr"),Y=a=>Math.floor(Math.random()*a),Le=()=>S.length?S[Y(S.length)]??"#FFFFFF":"#FFFFFF";class ke{constructor(e){this.canvas=e,this.bubbles=[],this.spawnTimer=0,this.rPx=0;const{w:t,h:i}=y(e);this.rPx=z(t,i)}get entities(){return this.bubbles}update(e){this.spawnTimer-=e,this.spawnTimer<=0&&(this.spawn(),this.spawnTimer=te),this.bubbles.forEach(t=>t.step(e)),this.bubbles.some(t=>!t.active)&&(this.bubbles=this.bubbles.filter(t=>t.active))}handleResize(){const{w:e,h:t}=y(this.canvas);this.rPx=z(e,t),this.bubbles.forEach(i=>i.r=this.rPx)}hitTest(e,t){const{w:i,h:n}=y(this.canvas);for(let s=this.bubbles.length-1;s>=0;s--){const r=this.bubbles[s];if(r&&r.contains(e,t,i,n))return r}}clear(){this.bubbles=[]}spawn(){var o;if(!((o=g.symbols)!=null&&o.length))return;const e=g.symbols[Y(g.symbols.length)],t=g.randomGlyph(e),{w:i}=y(this.canvas),n=this.rPx/i,s=n+Math.random()*(1-2*n),r=1+n;this.bubbles.push(new ve(s,r,Le(),t,e.roman,this.rPx)),Ae.debug("spawn",{total:this.bubbles.length,roman:e.roman})}}const Se=new h("Pointer");class Ce{constructor(e,t){this.canvas=e,this.bubbles=t,this.bound=this.onDown.bind(this)}attach(){this.canvas.addEventListener("pointerdown",this.bound),this.canvas.addEventListener("touchstart",this.bound)}detach(){this.canvas.removeEventListener("pointerdown",this.bound),this.canvas.removeEventListener("touchstart",this.bound)}onDown(e){var r,o;const t=this.canvas.getBoundingClientRect(),i="clientX"in e?e.clientX:((r=e.touches[0])==null?void 0:r.clientX)??0,n="clientY"in e?e.clientY:((o=e.touches[0])==null?void 0:o.clientY)??0,s=this.bubbles.hitTest(i-t.left,n-t.top);s&&(s.handleClick(performance.now()/1e3),Se.debug("hit",{roman:s.romaji}))}}class Ee{constructor(){}update(e){}draw(e){const{w:t,h:i}=y(e.canvas);e.fillStyle=U,e.fillRect(0,0,t,i)}}class Pe{render(e,t,i,n){const s=t.x*i,r=t.y*n,o=t.r;e.save(),e.globalAlpha=ne,e.fillStyle=t.color,e.beginPath(),e.arc(s,r,o,0,Math.PI*2),e.fill(),e.restore();const l=t.showingRomaji?t.romaji:t.glyph,c=t.showingRomaji?.45:ae;e.fillStyle=se,e.textAlign="center",e.textBaseline="middle",e.font=`${Math.round(o*c)}px ${ie}`,e.fillText(l,s,r)}}const L=new h("Play");let k=0,x=0;function $e(a){const e=new ke(a.canvas),t=new Pe,i=new Ee;let n=!1;const s=()=>e.handleResize(),r=new Ce(a.canvas,e);return{update(o){if(!n)return;G(a);const{w:l,h:c}=y(a.canvas),u=o;if(o=Math.min(u,.1),k+=u,x++,k>=1){const f=Math.round(x/k);h.isDebug&&L.debug("fps",f),k=0,x=0}e.update(o),i.update(o),i.draw(a),e.entities.forEach(f=>t.render(a,f,l,c))},async enter(){L.info("Play screen entered"),await g.load("ja"),j.preloadAll(g.symbols.map(o=>`${g.currentCode}/${o.audio}`)).catch(o=>L.warn("audio preload",o)),n=!0,A.subscribe(s),s(),r.attach()},exit(){L.info("Play screen exited"),A.unsubscribe(s),r.detach(),e.clear()}}}const I=document.querySelector("#game");if(!I)throw new Error("#game canvas not found");const T=I.getContext("2d");if(!T)throw new Error("2-D context not available");function M(){document.documentElement.style.setProperty("--app-height",`${window.innerHeight}px`)}document.readyState==="loading"?window.addEventListener("DOMContentLoaded",M,{once:!0}):M();window.addEventListener("resize",M);j.armFirstGesture(window);A.watchCanvas(I);const C=new le;C.add("menu",de(C,T)).add("play",$e(T));C.change("menu");let E=0,O=performance.now();function D(a){const e=(a-O)/1e3;O=a,C.update(e),E=requestAnimationFrame(D)}E=requestAnimationFrame(D);document.addEventListener("visibilitychange",()=>{document.hidden?cancelAnimationFrame(E):(O=performance.now(),E=requestAnimationFrame(D))});
