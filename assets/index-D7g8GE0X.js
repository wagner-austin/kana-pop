(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function e(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(n){if(n.ep)return;n.ep=!0;const s=e(n);fetch(n.href,s)}})();function v(o){const{clientWidth:t,clientHeight:e}=o;return{w:t,h:e}}function Z(){return window.devicePixelRatio||1}function tt(o){const t=Z();o.setTransform(1,0,0,1,0,0),o.scale(t,t)}function ot(o){const t=Z(),{w:e,h:i}=v(o);return o.width=Math.round(e*t),o.height=Math.round(i*t),{w:e,h:i,dpr:t}}class rt{constructor(){this.listeners=new Set,this.watchedCanvases=new Map,this.mediaQuery=null,this.boundTrigger=this.trigger.bind(this),this.dprCallback=null,this.metrics={w:0,h:0,dpr:1}}subscribe(t){this.listeners.add(t),t(),this.listeners.size===1&&this.attachWindowListeners()}unsubscribe(t){this.listeners.delete(t),this.listeners.size===0&&this.detachWindowListeners()}watchCanvas(t){const e=()=>{const i=ot(t);this.metrics=i};this.watchedCanvases.set(t,e),this.subscribe(e)}unwatchCanvas(t){const e=this.watchedCanvases.get(t);e&&(this.unsubscribe(e),this.watchedCanvases.delete(t))}trigger(){this.listeners.forEach(t=>t())}attachWindowListeners(){typeof window<"u"&&(window.addEventListener("resize",this.boundTrigger),this.addDprListener())}detachWindowListeners(){var t;typeof window<"u"&&window.removeEventListener("resize",this.boundTrigger),this.dprCallback&&((t=this.mediaQuery)==null||t.removeEventListener("change",this.dprCallback)),this.mediaQuery=null,this.dprCallback=null}addDprListener(){var t;typeof window>"u"||typeof window.matchMedia>"u"||(this.dprCallback&&((t=this.mediaQuery)==null||t.removeEventListener("change",this.dprCallback)),this.mediaQuery=matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`),this.dprCallback=()=>{this.boundTrigger(),this.addDprListener()},this.mediaQuery.addEventListener("change",this.dprCallback,{once:!0}))}get cssWidth(){return this.metrics.w}get cssHeight(){return this.metrics.h}get dpr(){return this.metrics.dpr}}const E=new rt,lt=["#FFD1DC","#B5EAD7","#C7CEEA","#FFDAC1","#E2F0CB"],ct={colors:lt},dt=1.2,ut=.5,P=ct.colors,et=P[2],it="#222",ht="Noto Sans JP, sans-serif",ft=it,gt=.7,mt=.4,bt=50,pt=.85,j=.15,vt=.6,z=4,wt=250,G=1e3,B="__kanaPopDebug_",yt=40,w=class w{constructor(t,e=w.bootLevel){this.scope=t,this.level=e}out(t,...e){}debug(...t){this.out("debug",...t)}info(...t){this.out("info",...t)}warn(...t){this.out("warn",...t)}error(...t){this.out("error",...t)}};w.bootLevel=(()=>{if(typeof globalThis>"u"||!("localStorage"in globalThis))return"info";const t=localStorage.getItem("logLevel");return t&&["debug","info","warn","error","off"].includes(t)?t:"info"})(),w.isDebug=w.bootLevel==="debug",w.levelOrder={debug:0,info:1,warn:2,error:3,off:4};let f=w;function Et(){return{setLevel(o){localStorage.setItem("logLevel",o),location.reload()}}}window.logger=Et();const At=new f("SM");class St{constructor(){this.states=new Map}add(t,e){return this.states.set(t,e),this}change(t){var e,i,n,s;At.info("→ change",{from:this.currentName,to:t}),(i=(e=this.current)==null?void 0:e.exit)==null||i.call(e),this.current=this.states.get(t),this.currentName=t,(s=(n=this.current)==null?void 0:n.enter)==null||s.call(n)}update(t){var e,i;(i=(e=this.current)==null?void 0:e.update)==null||i.call(e,t)}get currentStateName(){return this.currentName}}function Pt(o,t){const e=()=>o.change("play");function i(){tt(t);const{w:n,h:s}=v(t.canvas);t.fillStyle=et,t.fillRect(0,0,n,s),t.fillStyle=it,t.textAlign="center",t.font="32px sans-serif",t.fillText("Tap to Start",n/2,s/2)}return{enter(){E.subscribe(i),t.canvas.addEventListener("pointerdown",e)},update(){i()},exit(){E.unsubscribe(i),t.canvas.removeEventListener("pointerdown",e)}}}function kt(){if(typeof navigator>"u")return!1;const o=typeof navigator>"u"?"":navigator.userAgent;return/iPad|iPhone|iPod/.test(o)&&!(typeof window<"u"&&window.MSStream)}function xt(){if(typeof navigator>"u")return!1;const o=typeof navigator>"u"?"":navigator.userAgent;return/iPad/.test(o)||typeof navigator<"u"&&navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1}function T(){if(typeof navigator>"u")return!1;if(kt()||xt())return!0;const o=typeof navigator>"u"?"":navigator.userAgent;return!!(/iPad|iPhone|iPod/.test(o)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>0)}const b=new f("Audio");class Dt{constructor(){this.bank=new Map}async ensureContext(){const t=()=>{const e=globalThis,i=e.AudioContext??e.webkitAudioContext;if(!i)throw new Error("Web Audio API not supported");const n=new i;return b.info(`Created new AudioContext: ${n.state}`),n};if((!this.ctx||this.ctx.state==="closed")&&(this.ctx=t()),this.ctx.state==="suspended"||this.ctx.state==="interrupted"){b.info(`Attempting resume() from ${this.ctx.state}`);try{await this.ctx.resume()}catch(e){b.warn("resume() threw",e)}}if(this.ctx.state!=="running"){b.warn(`AudioContext stuck in '${this.ctx.state}', recreating…`);try{await this.ctx.close()}catch{}this.ctx=t(),await this.ctx.resume()}return this.ctx}async fetch(t){if(this.bank.has(t))return this.bank.get(t);try{const e=await(await fetch(t)).arrayBuffer(),n=await(await this.ensureContext()).decodeAudioData(e);return this.bank.set(t,n),n}catch(e){throw b.error(`decodeAudioData failed for ${t}`,e),e}}async play(t){const e=await this.ensureContext(),i=e.createBufferSource();i.buffer=t,i.connect(e.destination),i.start(),i.onended=()=>i.disconnect()}async resume(){try{const t=await this.ensureContext();if(T()){b.info("iOS/iPadOS detected, playing silent buffer to unlock audio");const e=t.sampleRate||44100,i=t.createBuffer(2,e*.5,e);for(let a=0;a<2;a++){const c=i.getChannelData(a);for(let l=0;l<c.length;l++)c[l]=0}const n=T()?.5:.1,s=t.createGain();s.gain.value=.001;const r=t.createBufferSource();r.buffer=i,r.connect(s),s.connect(t.destination),r.start(0),r.stop(t.currentTime+n),r.onended=()=>{r.disconnect(),s.disconnect()},b.info(`Silent buffer played (duration: ${n}s)`)}return t}catch(t){throw b.error("Resume failed",t),t}}}const L=new f("Storage");class Ct{constructor(){this.isNative=!1,this.storage=this.detectStorage()}detectStorage(){if(typeof window<"u"&&typeof localStorage=="object")try{const t="__storage_test__";return localStorage.setItem(t,t),localStorage.removeItem(t),L.debug("Using native localStorage"),this.isNative=!0,localStorage}catch(t){L.warn("localStorage detected but unavailable (Safari private mode?), using memory storage",t)}else L.info("No localStorage available (Node/test environment), using memory storage");return new Map}get(t){if(this.isNative)return this.storage.getItem(t);const e=this.storage;return e.has(t)?e.get(t):null}set(t,e){this.isNative?this.storage.setItem(t,e):this.storage.set(t,e)}remove(t){this.isNative?this.storage.removeItem(t):this.storage.delete(t)}clear(){this.isNative?this.storage.clear():this.storage.clear()}}const W=new Ct,Lt="modulepreload",Mt=function(o){return"/kana-pop/"+o},q={},V=function(t,e,i){let n=Promise.resolve();if(e&&e.length>0){let r=function(l){return Promise.all(l.map(u=>Promise.resolve(u).then(g=>({status:"fulfilled",value:g}),g=>({status:"rejected",reason:g}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),c=(a==null?void 0:a.nonce)||(a==null?void 0:a.getAttribute("nonce"));n=r(e.map(l=>{if(l=Mt(l),l in q)return;q[l]=!0;const u=l.endsWith(".css"),g=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${g}`))return;const h=document.createElement("link");if(h.rel=u?"stylesheet":Lt,u||(h.as="script"),h.crossOrigin="",h.href=l,c&&h.setAttribute("nonce",c),document.head.appendChild(h),u)return new Promise((st,at)=>{h.addEventListener("load",st),h.addEventListener("error",()=>at(new Error(`Unable to preload CSS for ${l}`)))})}))}function s(r){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=r,window.dispatchEvent(a),!a.defaultPrevented)throw r}return n.then(r=>{for(const a of r||[])a.status==="rejected"&&s(a.reason);return t().catch(s)})},p=class p{static async manifest(){if(!this.manifestPromise){if(!p.loadManifest)throw new Error("Manifest loader not found. Check glob pattern and file existence.");this.manifestPromise=p.loadManifest()}return this.manifestPromise}static async language(t){const e=`../data/lang/${t}.json`,i=p.langFiles[e];if(!i)throw new Error(`No language data file for '${t}'`);return i()}};p.manifestPromise=null,p.langFiles=Object.assign({"../data/lang/ja.json":()=>V(()=>import("./ja-DEJkL8aw.js"),[]).then(t=>t.default)}),p.loadManifest=Object.assign({"../data/lang/index.json":()=>V(()=>import("./index-BJLXKDTG.js"),[]).then(t=>t.default)})["../data/lang/index.json"];let k=p;const X=new f("Lang");class Tt{constructor(){var i;const t=W.get("kanaPop.lang"),e=typeof navigator<"u"?(i=navigator.language)==null?void 0:i.slice(0,2):void 0;this.defaultCode=t||e||"ja",this.lang={code:this.defaultCode,name:"loading…",symbols:[],direction:"ltr"}}async load(t=this.defaultCode){const e=await k.manifest(),i=e.find(r=>r.code===t)??e.find(r=>r.code===this.defaultCode);if(!i)throw new Error("LanguageService: manifest empty");const n=await k.language(i.code);i.direction||X.warn(`'${i.code}' lacks "direction"; defaulting to 'ltr'`);const s=i.direction??"ltr";this.lang={code:i.code,name:i.name,symbols:n.symbols??[],direction:s},this.persistLang(this.lang.code)}get symbols(){return this.lang.symbols}get currentCode(){return this.lang.code}get direction(){return this.lang.direction}randomGlyph(t){const e=Object.values(t.glyphs);return e.length===0?(X.warn(`Symbol with roman='${t.roman}' (category: ${t.category}, lang: ${this.lang.code}) has no glyphs defined. Returning '?' as fallback.`),"?"):e[Math.floor(Math.random()*e.length)]}persistLang(t){W.set("kanaPop.lang",t)}}const m=new Tt,d=new f("Sound"),C=class C{constructor(){this.bank=new Dt,this.isGestureArmed=!1,this.ready=new Promise(t=>this.triggerReady=t),typeof document<"u"&&document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&(d.debug("Page became visible – poking AudioContext"),this.bank.ensureContext().catch(()=>{}))})}async armFirstGesture(t=window){if(this.isGestureArmed)return;this.isGestureArmed=!0,d.info("First gesture handler armed");const e=T(),i=[],n=(a,c)=>{a.addEventListener(c,r,{passive:!0}),i.push({target:a,type:c})},s=()=>{d.info("Trimming audio unlock listeners (keeping one for re-unlock)");let a=!1;i.forEach(({target:c,type:l})=>{if(!a&&c===window&&l==="pointerdown"){a=!0;return}c.removeEventListener(l,r)})},r=async()=>{d.info("User gesture detected, unlocking audio");let a=!1;try{await this.bank.resume(),d.info("Audio context unlocked successfully"),a=!0}catch(c){d.warn("AudioContext unlock failed, trying HTML Audio fallback",c);try{const l=new Audio(C.SILENT);l.autoplay=!0,l.muted=!1,l.volume=.001,l.setAttribute("playsinline",""),d.info("Playing fallback HTML audio");const u=l.play();if(u instanceof Promise){await u,d.info("Fallback audio played successfully");try{await this.bank.resume(),d.info("Audio context unlocked after HTML audio fallback"),a=!0}catch(g){d.warn("Audio context still locked after HTML audio fallback",g)}}else d.warn("Fallback audio play() returned no promise")}catch(l){d.error("All audio unlock attempts failed",l)}}this.triggerReady(),a?s():d.warn("Audio still locked – listeners stay armed for another try")};d.info("Registering audio unlock gesture handlers"),n(t,"pointerdown"),n(t,"touchstart"),n(t,"click"),e&&(d.info("Adding extra handlers for iOS/iPadOS"),n(document.body,"pointerdown"),n(document.body,"touchstart"),n(document.body,"click"),n(document,"pointerdown"),n(document,"touchstart"),n(document,"click"),n(window,"pointerdown"),n(window,"touchstart"),n(window,"click"))}async play(t){if(await this.ready,t.endsWith("fallback.mp3"))return;const e=Y(`/kana-pop/audio/${t}`);try{const i=await this.bank.fetch(e);await this.bank.play(i)}catch(i){d.warn(`Web Audio playback failed for ${e}, using HTMLAudioElement fallback`,i),new Audio(e).play().catch(n=>{d.error(`HTMLAudioElement fallback also failed for ${e}`,n)})}}playRoman(t){var i;const e=(i=m.symbols.find(n=>n.roman===t))==null?void 0:i.audio;e&&this.play(`${m.currentCode}/${e}`)}async preloadAll(t){await this.ready,d.info(`Preloading ${t.length} audio files`),await Promise.all(t.map(e=>{if(e.endsWith("fallback.mp3"))return Promise.resolve();const i=Y(`/kana-pop/audio/${e}`);return this.bank.fetch(i).catch(n=>{d.warn(`Failed to preload audio: ${e}`,n)})})),d.info("Audio preloading complete")}};C.SILENT="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAIlYAACJWAAABAAgAZGF0YQAAAAA=";let O=C;const N=new O;function Y(o){return o.startsWith("data:")?o:`${o}?v=mbjahyxq`}const y=new f("Haptics");class Ot{constructor(){if(this.enabled=!1,this.debugElement=null,this.lastVibration=0,this.isIOS=!1,this.patternArraysOkay=null,!(typeof window>"u"||typeof navigator>"u")){if(this.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,this.isIOS){y.info("iOS detected – Vibration API unsupported; Haptics disabled.");return}if(window.matchMedia("(prefers-reduced-motion: reduce)").matches){y.info("Haptics disabled due to reduced-motion preference.");return}if(typeof navigator.vibrate=="function"){this.enabled=!0,y.info("Haptic feedback enabled.");const t=()=>{if(this.lastVibration===0){if(this.isIOS)navigator.vibrate(100),this.updateDebugStatus("iOS vibration activated");else try{navigator.vibrate(100),this.updateDebugStatus("Android vibration activated (simple)")}catch{try{navigator.vibrate([100,50,100]),this.updateDebugStatus("Android vibration activated (pattern)")}catch(e){y.warn("Vibration activation failed:",e),this.updateDebugStatus("Activation failed")}}this.lastVibration=Date.now()-400}};document.addEventListener("touchstart",t,{once:!0}),document.addEventListener("click",t,{once:!0})}else y.info("Haptic feedback not supported on this device.")}}vibrate(t=50,e=2){if(!this.enabled)return!1;if(this.patternArraysOkay===null&&(this.patternArraysOkay=navigator.vibrate([1,1]),!this.patternArraysOkay))return this.updateDebugStatus("Array patterns rejected – collapsing to single pulses"),!1;const i=Date.now();if(i-this.lastVibration<200)return!1;try{let s=t;if(!Array.isArray(t)){const a=Math.max(t,50),c=yt;if(this.isIOS)s=e===3?a*2:a*1.5;else switch(e){case 1:s=a;break;case 2:s=Math.min(a*1.5,150);break;case 3:s=this.patternArraysOkay?[a,c,a]:a*2;break}}!this.patternArraysOkay&&Array.isArray(s)&&(s=Math.max(...s));const r=navigator.vibrate(s);return this.updateDebugStatus(r?`Vibrated: ${JSON.stringify(s)}`:"navigator.vibrate() returned false"),r&&(this.lastVibration=i),r}catch(s){return console.warn("Vibration failed:",s),this.updateDebugStatus(`Failed: ${s}`),!1}}isSupported(){return this.enabled}createDebugElement(){var e;if(typeof document>"u")return;const t=`${B}Haptics`;(e=document.getElementById(t))==null||e.remove(),this.debugElement=document.createElement("div"),this.debugElement.id=t,this.debugElement.style.position="fixed",this.debugElement.style.bottom="30px",this.debugElement.style.left="10px",this.debugElement.style.background="rgba(0,0,0,0.5)",this.debugElement.style.color="white",this.debugElement.style.padding="5px",this.debugElement.style.fontSize="12px",this.debugElement.style.zIndex="9999",this.debugElement.style.pointerEvents="none",document.body.appendChild(this.debugElement)}updateDebugStatus(t){this.debugElement&&(this.debugElement.textContent=`Haptics: ${t}`)}}const It=new Ot,Q=new f("Bubble");class Ft{constructor(t,e,i,n,s,r){this.x=t,this.y=e,this.color=i,this.glyph=n,this.romaji=s,this.active=!0,this.speed=.2,this.scale=1,this.flashTimer=0,this.showingRomaji=!1,this.lastSpoken=-1/0,this.r=r,Q.debug("spawn",{x:this.x.toFixed(2),color:i,glyph:this.glyph})}handleClick(t){t-this.lastSpoken<mt||(this.lastSpoken=t,this.showingRomaji=!this.showingRomaji,N.playRoman(this.romaji),It.vibrate(bt,2),this.scale=pt,this.flashTimer=j,Q.debug("toggle",{romaji:this.showingRomaji}))}step(t){this.y-=this.speed*t,this.y<-.05&&(this.active=!1),this.scale!==1&&(this.scale+=(1-this.scale)*10*t,Math.abs(this.scale-1)<.001&&(this.scale=1)),this.flashTimer>0&&(this.flashTimer-=t,this.flashTimer<0&&(this.flashTimer=0))}contains(t,e,i,n){if(!this.active)return!1;const s=this.x*i,r=this.y*n,a=t-s,c=e-r,l=a*a+c*c,u=this.r*this.scale;return l<=u*u}get flashAlpha(){return this.flashTimer>0?this.flashTimer/j:0}}function K(o,t){return Math.min(o,t)*.06}const $t=new f("BubbleMgr"),nt=o=>Math.floor(Math.random()*o),Rt=()=>P.length?P[nt(P.length)]??"#FFFFFF":"#FFFFFF";class _t{constructor(t){this.canvas=t,this.bubbles=[],this.spawnTimer=0,this.rPx=0;const{w:e,h:i}=v(t);this.rPx=K(e,i)}get entities(){return this.bubbles}update(t){this.spawnTimer-=t,this.spawnTimer<=0&&(this.spawn(),this.spawnTimer=dt),this.bubbles.forEach(e=>e.step(t)),this.bubbles.some(e=>!e.active)&&(this.bubbles=this.bubbles.filter(e=>e.active))}handleResize(){const{w:t,h:e}=v(this.canvas);this.rPx=K(t,e),this.bubbles.forEach(i=>i.r=this.rPx)}hitTest(t,e){const{w:i,h:n}=v(this.canvas);for(let s=this.bubbles.length-1;s>=0;s--){const r=this.bubbles[s];if(r&&r.contains(t,e,i,n))return r}}clear(){this.bubbles=[]}spawn(){var a;if(!((a=m.symbols)!=null&&a.length))return;const t=m.symbols[nt(m.symbols.length)],e=m.randomGlyph(t),{w:i}=v(this.canvas),n=this.rPx/i,s=n+Math.random()*(1-2*n),r=1+n;this.bubbles.push(new Ft(s,r,Rt(),e,t.roman,this.rPx)),$t.debug("spawn",{total:this.bubbles.length,roman:t.roman})}}const Bt=new f("Pointer");class Nt{constructor(t,e){this.canvas=t,this.bubbles=e,this.bound=this.onDown.bind(this)}attach(){this.canvas.addEventListener("pointerdown",this.bound)}detach(){this.canvas.removeEventListener("pointerdown",this.bound)}onDown(t){var r,a;const e=this.canvas.getBoundingClientRect(),i="clientX"in t?t.clientX:((r=t.touches[0])==null?void 0:r.clientX)??0,n="clientY"in t?t.clientY:((a=t.touches[0])==null?void 0:a.clientY)??0,s=this.bubbles.hitTest(i-e.left,n-e.top);s&&(s.handleClick(performance.now()/1e3),Bt.debug("hit",{roman:s.romaji}))}}class I{constructor(){this.active=!1,this.lastUpdate=0,this.hadMotionData=!1,this.debugElement=null,this.startedAt=0,this.listener=t=>{var a;const e=t.gamma??0,i=t.beta??0;(e!==0||i!==0)&&(this.hadMotionData=!0);const n=e/45,s=i/45;(a=this.cb)==null||a.call(this,{x:J(n),y:J(s)});const r=Date.now();this.debugElement&&r-this.lastUpdate>500&&(this.debugElement.textContent=`Motion: γ=${e.toFixed(1)}° β=${i.toFixed(1)}° (${n.toFixed(2)}, ${s.toFixed(2)})`,this.lastUpdate=r)}}async start(t){if(this.active)return;this.cb=t;const e=window.DeviceOrientationEvent;try{if(e&&typeof e.requestPermission=="function")try{if(await e.requestPermission()!=="granted"){console.warn("DeviceOrientationEvent permission denied by user."),this.updateDebugStatus("Permission denied");return}this.updateDebugStatus("Permission granted, initializing...")}catch(i){console.warn("Error requesting DeviceOrientationEvent permission:",i),this.updateDebugStatus(`Permission error: ${i}`);return}window.addEventListener("deviceorientation",this.listener,!0),this.active=!0,this.startedAt=Date.now(),setTimeout(()=>{this.active&&!this.hadMotionData?(console.warn("No motion data received after activation"),this.updateDebugStatus("No motion data received")):this.active&&this.updateDebugStatus("Motion active")},G)}catch(i){console.error("Unexpected error in motion initialization:",i),this.updateDebugStatus(`Init error: ${i}`);return}}stop(){this.active&&(window.removeEventListener("deviceorientation",this.listener,!0),this.active=!1,this.cb=void 0,this.debugElement&&this.debugElement.parentNode&&(this.debugElement.parentNode.removeChild(this.debugElement),this.debugElement=null))}isActive(){return this.active&&(this.hadMotionData||Date.now()-this.startedAt<G)}createDebugElement(){var e;if(typeof document>"u")return;const t=`${B}Motion`;(e=document.getElementById(t))==null||e.remove(),this.debugElement=document.createElement("div"),this.debugElement.id=t,this.debugElement.style.position="fixed",this.debugElement.style.bottom="10px",this.debugElement.style.left="10px",this.debugElement.style.background="rgba(0,0,0,0.5)",this.debugElement.style.color="white",this.debugElement.style.padding="5px",this.debugElement.style.fontSize="12px",this.debugElement.style.zIndex="9999",this.debugElement.style.pointerEvents="none",this.debugElement.textContent="Motion: Initializing...",document.body.appendChild(this.debugElement)}updateDebugStatus(t){this.debugElement&&(this.debugElement.textContent=`Motion: ${t}`)}}class F{constructor(){this.raf=0,this.t=0}start(t){this.cb=t;const e=()=>{var i;this.t+=.001,this.t>1&&(this.t-=1),(i=this.cb)==null||i.call(this,{x:0,y:Math.sin(this.t*Math.PI*2)}),this.raf=requestAnimationFrame(e)};this.raf=requestAnimationFrame(e)}stop(){this.raf&&(cancelAnimationFrame(this.raf),this.raf=0),this.cb=void 0}}function Ht(){return"DeviceOrientationEvent"in window?new I:new F}const J=o=>Math.max(-1,Math.min(1,o));class Ut{constructor(){this.logger=new f("BackgroundRenderer"),this.activeProviderFailed=!1,this.offset={x:0,y:0},this.MAX_SHIFT=50,this.debugElement=null,this._lastDebugUpdate=0,this.logger.debug("BackgroundRenderer instantiated"),this.motionProvider=Ht(),this.startMotionTracking()}getOffset(){return this.offset}createDebugElement(){var e;if(typeof document>"u")return;const t=`${B}Background`;(e=document.getElementById(t))==null||e.remove(),this.debugElement=document.createElement("div"),this.debugElement.id=t,this.debugElement.style.position="fixed",this.debugElement.style.bottom="50px",this.debugElement.style.left="10px",this.debugElement.style.background="rgba(0,0,0,0.5)",this.debugElement.style.color="white",this.debugElement.style.padding="5px",this.debugElement.style.fontSize="12px",this.debugElement.style.zIndex="9999",this.debugElement.style.pointerEvents="none",this.debugElement.textContent="Parallax: Initializing...",document.body.appendChild(this.debugElement)}async startMotionTracking(){const t=this.motionProvider;try{if(await t.start(e=>this.offset=e),t instanceof I)if(t.isActive()){this.logger.info("Gyro motion provider started successfully.");return}else this.logger.warn("GyroProvider did not become active (e.g., permission denied or no sensor). Attempting fallback."),this.activeProviderFailed=!0;else if(t instanceof F){this.logger.info("DummyScrollProvider started (was initial choice).");return}}catch(e){this.logger.error("Error starting initial motion provider:",e),this.activeProviderFailed=!0}this.activeProviderFailed&&t instanceof I&&(this.logger.info("Falling back to DummyScrollProvider for background motion."),t&&t.stop(),this.motionProvider=new F,this.motionProvider.start(e=>this.offset=e),this.logger.info("DummyScrollProvider started as fallback."))}update(t){if(this.debugElement){const e=Date.now();if(!this._lastDebugUpdate||e-this._lastDebugUpdate>wt){const i=this.offset.x*this.MAX_SHIFT,n=this.offset.y*this.MAX_SHIFT;this.debugElement.textContent=`Parallax: ${i.toFixed(1)}px, ${n.toFixed(1)}px`,this._lastDebugUpdate=e}}}draw(t){const{w:e,h:i}=v(t.canvas);t.fillStyle=et,t.fillRect(0,0,e,i)}dispose(){this.motionProvider&&(this.motionProvider.stop(),this.logger.debug("Motion provider stopped.")),this.debugElement&&this.debugElement.parentNode&&(this.debugElement.parentNode.removeChild(this.debugElement),this.debugElement=null,this.logger.debug("Debug display removed."))}}class jt{render(t,e,i,n,s){const r=((s==null?void 0:s.x)??0)*-20,a=((s==null?void 0:s.y)??0)*-20,c=e.x*i+r,l=e.y*n+a,u=e.r*e.scale;t.save(),t.globalAlpha=ut,t.fillStyle=e.color,t.beginPath(),t.arc(c,l,u,0,Math.PI*2),t.fill(),t.restore();const g=e.showingRomaji?e.romaji:e.glyph,h=e.showingRomaji?.45:gt;t.fillStyle=ft,t.textAlign="center",t.textBaseline="middle",t.font=`${Math.round(u*h)}px ${ht}`,t.fillText(g,c,l),e.flashAlpha>0&&(t.save(),t.globalAlpha=e.flashAlpha*vt,t.lineWidth=z,t.strokeStyle="#ffffff",t.beginPath(),t.arc(c,l,u+z*.5,0,Math.PI*2),t.stroke(),t.restore())}}const A=new f("Play");let S=0,M=0;function zt(o){const t=new _t(o.canvas),e=new jt,i=new Ut;let n=!1;const s=()=>t.handleResize(),r=new Nt(o.canvas,t);return{update(a){if(!n)return;tt(o);const{w:c,h:l}=v(o.canvas),u=a;if(a=Math.min(u,.1),S+=u,M++,S>=1){const h=Math.round(M/S);f.isDebug&&A.debug("fps",h),S=0,M=0}t.update(a),i.update(a),i.draw(o);const g=i.getOffset();t.entities.forEach(h=>e.render(o,h,c,l,g))},async enter(){A.info("Play screen entered"),await m.load("ja"),N.preloadAll(m.symbols.map(a=>`${m.currentCode}/${a.audio}`)).catch(a=>A.warn("audio preload",a)),n=!0,E.subscribe(s),s(),r.attach()},exit(){A.info("Play screen exited"),E.unsubscribe(s),r.detach(),t.clear(),i.dispose()}}}const H=document.querySelector("#game");if(!H)throw new Error("#game canvas not found");const $=H.getContext("2d");if(!$)throw new Error("2-D context not available");function R(){document.documentElement.style.setProperty("--app-height",`${window.innerHeight}px`)}document.readyState==="loading"?window.addEventListener("DOMContentLoaded",R,{once:!0}):R();window.addEventListener("resize",R);N.armFirstGesture(window);E.watchCanvas(H);const x=new St;x.add("menu",Pt(x,$)).add("play",zt($));x.change("menu");let D=0,_=performance.now();function U(o){const t=(o-_)/1e3;_=o,x.update(t),D=requestAnimationFrame(U)}D=requestAnimationFrame(U);document.addEventListener("visibilitychange",()=>{document.hidden?cancelAnimationFrame(D):(_=performance.now(),D=requestAnimationFrame(U))});
