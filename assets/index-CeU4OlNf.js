(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function t(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(s){if(s.ep)return;s.ep=!0;const r=t(s);fetch(s.href,r)}})();function Y(a){const e=window.devicePixelRatio||1,{clientWidth:t,clientHeight:n}=a;return a.width=Math.floor(t*e),a.height=Math.floor(n*e),{w:t,h:n,dpr:e}}class X{constructor(){this.listeners=new Set,this.watchedCanvases=new Map,this.mediaQuery=null,this.boundTrigger=this.trigger.bind(this),this.dprCallback=null,this.metrics={w:0,h:0,dpr:1}}subscribe(e){this.listeners.add(e),e(),this.listeners.size===1&&this.attachWindowListeners()}unsubscribe(e){this.listeners.delete(e),this.listeners.size===0&&this.detachWindowListeners()}watchCanvas(e){const t=()=>{const n=Y(e);this.metrics=n};this.watchedCanvases.set(e,t),this.subscribe(t)}unwatchCanvas(e){const t=this.watchedCanvases.get(e);t&&(this.unsubscribe(t),this.watchedCanvases.delete(e))}trigger(){this.listeners.forEach(e=>e())}attachWindowListeners(){window.addEventListener("resize",this.boundTrigger),this.addDprListener()}detachWindowListeners(){var e;window.removeEventListener("resize",this.boundTrigger),this.dprCallback&&((e=this.mediaQuery)==null||e.removeEventListener("change",this.dprCallback)),this.mediaQuery=null,this.dprCallback=null}addDprListener(){var e;this.dprCallback&&((e=this.mediaQuery)==null||e.removeEventListener("change",this.dprCallback)),this.mediaQuery=matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`),this.dprCallback=()=>{this.boundTrigger(),this.addDprListener()},this.mediaQuery.addEventListener("change",this.dprCallback,{once:!0})}get cssWidth(){return this.metrics.w}get cssHeight(){return this.metrics.h}get dpr(){return this.metrics.dpr}}const w=new X,K=["#FFD1DC","#B5EAD7","#C7CEEA","#FFDAC1","#E2F0CB"],J={colors:K},V=1.2,Z=.5,E=J.colors,I=E[2],_="#222";function T(){const a=w.cssWidth||window.innerWidth,e=w.cssHeight||window.innerHeight;return Math.min(a,e)*.06}const x="Noto Sans JP, sans-serif",H=_,ee=.7,b=class b{constructor(e,t=b.bootLevel){this.scope=e,this.level=t}out(e,...t){}debug(...e){this.out("debug",...e)}info(...e){this.out("info",...e)}warn(...e){this.out("warn",...e)}error(...e){this.out("error",...e)}};b.bootLevel=(()=>{const e=localStorage.getItem("logLevel");return e&&["debug","info","warn","error","off"].includes(e)?e:"info"})(),b.isDebug=b.bootLevel==="debug",b.levelOrder={debug:0,info:1,warn:2,error:3,off:4};let y=b;function te(){return{setLevel(a){localStorage.setItem("logLevel",a),location.reload()}}}window.logger=te();const ne=new y("SM");class se{constructor(){this.states=new Map}add(e,t){return this.states.set(e,t),this}change(e){var t,n,s,r;ne.info("→ change",{from:this.currentName,to:e}),(n=(t=this.current)==null?void 0:t.exit)==null||n.call(t),this.current=this.states.get(e),this.currentName=e,(r=(s=this.current)==null?void 0:s.enter)==null||r.call(s)}update(e){var t,n;(n=(t=this.current)==null?void 0:t.update)==null||n.call(t,e)}get currentStateName(){return this.currentName}}function v(a){const{clientWidth:e,clientHeight:t}=a;return{w:e,h:t}}function z(a){const e=window.devicePixelRatio||1;a.setTransform(1,0,0,1,0,0),a.scale(e,e)}function ae(a,e){const t=()=>a.change("play");function n(){z(e);const{w:s,h:r}=v(e.canvas);e.fillStyle=I,e.fillRect(0,0,s,r),e.fillStyle=_,e.textAlign="center",e.font="32px sans-serif",e.fillText("Tap to Start",s/2,r/2)}return{enter(){w.subscribe(n),e.canvas.addEventListener("pointerdown",t),e.canvas.addEventListener("touchstart",t)},update(){n()},exit(){w.unsubscribe(n),e.canvas.removeEventListener("pointerdown",t),e.canvas.removeEventListener("touchstart",t)}}}const O=new y("Bubble");class re{constructor(e,t,n,s,r){this.x=e,this.y=t,this.color=n,this.glyph=s,this.romaji=r,this.active=!0,this.speed=.2,O.debug("spawn",{x:this.x.toFixed(2),color:n,glyph:this.glyph})}pop(){O.info("pop!"),this.active=!1}step(e){this.y-=this.speed*e,this.y<-.05&&(this.active=!1)}contains(e,t,n,s){if(!this.active)return!1;const r=this.x*n,c=this.y*s,i=e-r,g=t-c,u=i*i+g*g,h=T();return u<=h*h}}class ie{constructor(){}update(e){}draw(e){const{w:t,h:n}=v(e.canvas);e.fillStyle=I,e.fillRect(0,0,t,n)}}class oe{render(e,t){const{w:n,h:s}=v(e.canvas),r=t.x*n,c=t.y*s,i=T();e.save(),e.globalAlpha=Z,e.fillStyle=t.color,e.beginPath(),e.arc(r,c,i,0,Math.PI*2),e.fill(),e.restore(),e.fillStyle=H,e.textAlign="center",e.textBaseline="middle",e.font=`${Math.round(i*ee)}px ${x}`,e.fillText(t.glyph,r,c)}}const le="modulepreload",ce=function(a){return"/kana-pop/"+a},B={},j=function(e,t,n){let s=Promise.resolve();if(t&&t.length>0){let c=function(u){return Promise.all(u.map(h=>Promise.resolve(h).then(l=>({status:"fulfilled",value:l}),l=>({status:"rejected",reason:l}))))};document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),g=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));s=c(t.map(u=>{if(u=ce(u),u in B)return;B[u]=!0;const h=u.endsWith(".css"),l=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${l}`))return;const d=document.createElement("link");if(d.rel=h?"stylesheet":le,h||(d.as="script"),d.crossOrigin="",d.href=u,g&&d.setAttribute("nonce",g),document.head.appendChild(d),h)return new Promise((o,m)=>{d.addEventListener("load",o),d.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${u}`)))})}))}function r(c){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=c,window.dispatchEvent(i),!i.defaultPrevented)throw c}return s.then(c=>{for(const i of c||[])i.status==="rejected"&&r(i.reason);return e().catch(r)})},U=[{code:"ja",name:"Japanese · Kana",direction:"ltr"},{code:"ar",name:"Arabic",direction:"rtl"}],de=Object.freeze(Object.defineProperty({__proto__:null,default:U},Symbol.toStringTag,{value:"Module"})),A=U,ue=Object.assign({"../data/lang/index.json":()=>j(()=>Promise.resolve().then(()=>de),void 0).then(a=>a.default),"../data/lang/ja.json":()=>j(()=>import("./ja-DEJkL8aw.js"),[]).then(a=>a.default)});class he{constructor(){var s;const e=localStorage.getItem("kanaPop.lang"),t=(s=navigator.language)==null?void 0:s.slice(0,2);this.defaultCode=e||t||"ja";let n=A.find(r=>r.code===this.defaultCode);n||(console.warn(`LanguageService: Default code '${this.defaultCode}' not in manifest. Falling back to first manifest entry or 'ja'.`),n=A.find(r=>r.code==="ja")||A[0]),n?this.lang={code:n.code,name:n.name,symbols:[],direction:n.direction}:(console.error("LanguageService: CRITICAL - Language manifest is empty or essential fallbacks are missing. App functionality will be severely impaired."),this.lang={code:this.defaultCode,name:"Error: Language Undefined",symbols:[],direction:"ltr"})}async load(e=this.defaultCode){const t=A.find(c=>c.code===e);if(!t){if(console.error(`LanguageService: Language code '${e}' not found in manifest. Attempting to fall back.`),e!==this.defaultCode&&A.find(i=>i.code===this.defaultCode))return console.warn(`LanguageService: Falling back to default language '${this.defaultCode}'.`),this.load(this.defaultCode);throw new Error(`LanguageService: Language code '${e}' (and default '${this.defaultCode}') not found in manifest.`)}if(e==="index")throw new Error("LanguageService: index.json is the manifest, not a language data file.");const n=`../data/lang/${e}.json`,s=ue[n];if(!s)throw console.error(`LanguageService: No data file loader found for code '${e}' (path: '${n}'). Check glob pattern and file existence.`),new Error(`LanguageService: No data file loader for '${e}'.`);let r;try{r=await s()}catch(c){throw console.error(`LanguageService: Failed to load language data file for code '${e}' from '${n}'.`,c),new Error(`LanguageService: Failed to load data for '${e}'.`)}this.lang={symbols:r.symbols||[],code:t.code||r.code,name:t.name,direction:t.direction},r.code&&r.code!==t.code&&(console.warn(`LanguageService: Mismatch! Requested/Manifest code '${t.code}', but file contains code '${r.code}'. Prioritizing manifest code.`),this.lang.code=t.code),localStorage.setItem("kanaPop.lang",this.lang.code)}get symbols(){return this.lang.symbols}get currentCode(){return this.lang.code}get direction(){return this.lang.direction}randomGlyph(e){const t=Object.values(e.glyphs);return t.length===0?(console.warn(`LanguageService: Symbol with roman='${e.roman}' (category: ${e.category}, lang: ${this.lang.code}) has no glyphs defined. Returning '?' as fallback.`),"?"):t[Math.floor(Math.random()*t.length)]}}const f=new he;class fe{constructor(){this.bank=new Map}async context(){if(!this.ctx){const e=globalThis,t=e.AudioContext??e.webkitAudioContext;if(!t)throw new Error("Web Audio API not supported");this.ctx=new t,this.ctx.onstatechange=()=>console.warn("[Audio] state →",this.ctx.state)}if(this.ctx.state!=="running")try{await this.ctx.resume()}catch(e){throw console.error("Error resuming AudioContext:",e),e}return this.ctx}async fetch(e){if(this.bank.has(e))return this.bank.get(e);const t=await(await fetch(e)).arrayBuffer(),n=await this.context();try{const s=await n.decodeAudioData(t);return this.bank.set(e,s),s}catch(s){throw console.error(`AudioBufferBank: decodeAudioData failed for ${e}`,s),s}}async play(e){const t=await this.context(),n=t.createBufferSource();n.buffer=e,n.connect(t.destination),n.start()}async resume(){await this.context()}}const k=class k{constructor(){this.bank=new fe,this.isGestureArmed=!1,this.ready=new Promise(e=>this.triggerReady=e)}async armFirstGesture(e=window){if(this.isGestureArmed)return;this.isGestureArmed=!0;const t=()=>{new Audio(k.SILENT).play().catch(s=>{console.warn("Silent audio playback for arming gesture failed:",s)}).finally(async()=>{await this.bank.resume(),this.triggerReady()})};["pointerdown","touchstart","mousedown","keydown"].forEach(n=>e.addEventListener(n,t,{once:!0,passive:!0}))}async play(e){if(await this.ready,e.endsWith("fallback.mp3"))return;const t=W(`/kana-pop/audio/${e}`);try{const n=await this.bank.fetch(t);await this.bank.play(n)}catch(n){console.warn(`SoundService: Web Audio playback failed for ${t}, falling back to HTMLAudioElement. Error:`,n),new Audio(t).play().catch(s=>{console.error(`SoundService: HTMLAudioElement fallback also failed for ${t}:`,s)})}}playRoman(e){var n;const t=(n=f.symbols.find(s=>s.roman===e))==null?void 0:n.audio;t&&this.play(`${f.currentCode}/${t}`)}async preloadAll(e){await this.ready,await Promise.all(e.map(t=>{if(t.endsWith("fallback.mp3"))return Promise.resolve();const n=W(`/kana-pop/audio/${t}`);return this.bank.fetch(n).catch(()=>{})}))}};k.SILENT="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAIlYAACJWAAABAAgAZGF0YQAAAAA=";let R=k;const M=new R;function W(a){return a.startsWith("data:")?a:`${a}?v=mbiypgp3`}class ge{constructor(e,t,n,s=.2,r=1){this.x=e,this.y=t,this.text=n,this.speed=s,this.ttl=r}step(e){this.ttl-=e,this.y-=this.speed*e}draw(e){if(this.ttl<=0)return;const{w:t,h:n}=v(e.canvas),s=T();e.save(),e.globalAlpha=Math.max(0,this.ttl),e.fillStyle=H,e.font=`${Math.round(s*.7)}px ${x}`,e.textAlign="center",e.textBaseline="middle",e.fillText(this.text,this.x*t,this.y*n),e.restore()}}const L=new y("Play");let C=0,P=0;const me=a=>Math.floor(Math.random()*a),pe=()=>E.length===0?"#FFFFFF":E[Math.floor(Math.random()*E.length)]??"#FFFFFF";function be(a){let e=[],t=a.canvas.clientWidth,n=a.canvas.clientHeight,s=0;const r=new oe,c=new ie;let i=[],g=!1;const u=()=>{const{w:l,h:d}=v(a.canvas);if(t===0||n===0){t=l,n=d;return}const o=l/t,m=d/n;if(!Number.isFinite(o)||o===0||!Number.isFinite(m)||m===0){t=l,n=d;return}t=l,n=d},h=l=>{const d=a.canvas.getBoundingClientRect(),o=l.clientX-d.left,m=l.clientY-d.top,{w:$,h:q}=v(a.canvas);for(let F=e.length-1;F>=0;F--){const p=e[F];if(p&&p.contains(o,m,$,q)){p.pop(),M.playRoman(p.romaji),i.push(new ge(p.x,p.y,p.romaji,p.speed));break}}};return{update(l){if(!g)return;z(a);const d=l;if(l=Math.min(d,.1),C+=d,P++,C>=1){const o=Math.round(P/C);y.isDebug&&L.debug("fps",o),C=0,P=0}if(s-=l,s<=0&&f.symbols&&f.symbols.length>0){const o=f.symbols[me(f.symbols.length)],m=f.randomGlyph(o),$=new re(Math.random(),1,pe(),m,o.roman);e.push($),L.debug("spawned bubble",e.length),s=V}e.some(o=>!o.active)&&(e=e.filter(o=>o.active)),i.some(o=>o.ttl<=0)&&(i=i.filter(o=>o.ttl>0)),c.update(l),e.forEach(o=>o.step(l)),i.forEach(o=>o.step(l)),c.draw(a),e.forEach(o=>r.render(a,o)),i.forEach(o=>o.draw(a))},async enter(){L.info("Play screen entered"),await f.load("ja"),M.preloadAll(f.symbols.map(l=>`${f.currentCode}/${l.audio}`)).catch(l=>L.warn("audio preload",l)),g=!0,w.subscribe(u),u(),a.canvas.addEventListener("pointerdown",h)},exit(){L.info("Play screen exited"),w.unsubscribe(u),a.canvas.removeEventListener("pointerdown",h),e=[],i=[]}}}const G=document.querySelector("#game"),D=G.getContext("2d");M.armFirstGesture(window);w.watchCanvas(G);const S=new se;S.add("menu",ae(S,D)).add("play",be(D));S.change("menu");let N=performance.now();function Q(a){const e=(a-N)/1e3;N=a,S.update(e),requestAnimationFrame(Q)}requestAnimationFrame(Q);
