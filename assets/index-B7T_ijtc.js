(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}})();function Y(i){const e=window.devicePixelRatio||1,{clientWidth:t,clientHeight:n}=i;return i.width=Math.floor(t*e),i.height=Math.floor(n*e),{w:t,h:n,dpr:e}}class X{constructor(){this.listeners=new Set,this.watchedCanvases=new Map,this.mediaQuery=null,this.boundTrigger=this.trigger.bind(this),this.dprCallback=null,this.metrics={w:0,h:0,dpr:1}}subscribe(e){this.listeners.add(e),e(),this.listeners.size===1&&this.attachWindowListeners()}unsubscribe(e){this.listeners.delete(e),this.listeners.size===0&&this.detachWindowListeners()}watchCanvas(e){const t=()=>{const n=Y(e);this.metrics=n};this.watchedCanvases.set(e,t),this.subscribe(t)}unwatchCanvas(e){const t=this.watchedCanvases.get(e);t&&(this.unsubscribe(t),this.watchedCanvases.delete(e))}trigger(){this.listeners.forEach(e=>e())}attachWindowListeners(){window.addEventListener("resize",this.boundTrigger),this.addDprListener()}detachWindowListeners(){var e;window.removeEventListener("resize",this.boundTrigger),this.dprCallback&&((e=this.mediaQuery)==null||e.removeEventListener("change",this.dprCallback)),this.mediaQuery=null,this.dprCallback=null}addDprListener(){var e;this.dprCallback&&((e=this.mediaQuery)==null||e.removeEventListener("change",this.dprCallback)),this.mediaQuery=matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`),this.dprCallback=()=>{this.boundTrigger(),this.addDprListener()},this.mediaQuery.addEventListener("change",this.dprCallback,{once:!0})}get cssWidth(){return this.metrics.w}get cssHeight(){return this.metrics.h}get dpr(){return this.metrics.dpr}}const b=new X,K=["#FFD1DC","#B5EAD7","#C7CEEA","#FFDAC1","#E2F0CB"],J={colors:K},V=1.2,Z=.5,E=J.colors,j=E[2],W="#222";function x(){const i=b.cssWidth||window.innerWidth,e=b.cssHeight||window.innerHeight;return Math.min(i,e)*.06}const _="Noto Sans JP, sans-serif",H=W,ee=.7,w=class w{constructor(e,t=w.bootLevel){this.scope=e,this.level=t}out(e,...t){}debug(...e){this.out("debug",...e)}info(...e){this.out("info",...e)}warn(...e){this.out("warn",...e)}error(...e){this.out("error",...e)}};w.bootLevel=(()=>{const e=localStorage.getItem("logLevel");return e&&["debug","info","warn","error","off"].includes(e)?e:"info"})(),w.isDebug=w.bootLevel==="debug",w.levelOrder={debug:0,info:1,warn:2,error:3,off:4};let y=w;function te(){return{setLevel(i){localStorage.setItem("logLevel",i),location.reload()}}}window.logger=te();const ne=new y("SM");class se{constructor(){this.states=new Map}add(e,t){return this.states.set(e,t),this}change(e){var t,n,s,a;ne.info("→ change",{from:this.currentName,to:e}),(n=(t=this.current)==null?void 0:t.exit)==null||n.call(t),this.current=this.states.get(e),this.currentName=e,(a=(s=this.current)==null?void 0:s.enter)==null||a.call(s)}update(e){var t,n;(n=(t=this.current)==null?void 0:t.update)==null||n.call(t,e)}get currentStateName(){return this.currentName}}function v(i){const{clientWidth:e,clientHeight:t}=i;return{w:e,h:t}}function z(i){const e=window.devicePixelRatio||1;i.setTransform(1,0,0,1,0,0),i.scale(e,e)}function ae(i,e){const t=()=>i.change("play");function n(){z(e);const{w:s,h:a}=v(e.canvas);e.fillStyle=j,e.fillRect(0,0,s,a),e.fillStyle=W,e.textAlign="center",e.font="32px sans-serif",e.fillText("Tap to Start",s/2,a/2)}return{enter(){b.subscribe(n),e.canvas.addEventListener("pointerdown",t),e.canvas.addEventListener("touchstart",t)},update(){n()},exit(){b.unsubscribe(n),e.canvas.removeEventListener("pointerdown",t),e.canvas.removeEventListener("touchstart",t)}}}const M=new y("Bubble");class ie{constructor(e,t,n,s,a){this.x=e,this.y=t,this.color=n,this.glyph=s,this.romaji=a,this.active=!0,this.speed=.2,M.debug("spawn",{x:this.x.toFixed(2),color:n,glyph:this.glyph})}pop(){M.info("pop!"),this.active=!1}step(e){this.y-=this.speed*e,this.y<-.05&&(this.active=!1)}contains(e,t,n,s){if(!this.active)return!1;const a=this.x*n,o=this.y*s,r=e-a,f=t-o,c=r*r+f*f,u=x();return c<=u*u}}class re{constructor(){}update(e){}draw(e){const{w:t,h:n}=v(e.canvas);e.fillStyle=j,e.fillRect(0,0,t,n)}}class oe{render(e,t){const{w:n,h:s}=v(e.canvas),a=t.x*n,o=t.y*s,r=x();e.save(),e.globalAlpha=Z,e.fillStyle=t.color,e.beginPath(),e.arc(a,o,r,0,Math.PI*2),e.fill(),e.restore(),e.fillStyle=H,e.textAlign="center",e.textBaseline="middle",e.font=`${Math.round(r*ee)}px ${_}`,e.fillText(t.glyph,a,o)}}const ce="modulepreload",le=function(i){return"/kana-pop/"+i},T={},I=function(e,t,n){let s=Promise.resolve();if(t&&t.length>0){let o=function(c){return Promise.all(c.map(u=>Promise.resolve(u).then(l=>({status:"fulfilled",value:l}),l=>({status:"rejected",reason:l}))))};document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),f=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));s=o(t.map(c=>{if(c=le(c),c in T)return;T[c]=!0;const u=c.endsWith(".css"),l=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${l}`))return;const h=document.createElement("link");if(h.rel=u?"stylesheet":ce,u||(h.as="script"),h.crossOrigin="",h.href=c,f&&h.setAttribute("nonce",f),document.head.appendChild(h),u)return new Promise((d,m)=>{h.addEventListener("load",d),h.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${c}`)))})}))}function a(o){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=o,window.dispatchEvent(r),!r.defaultPrevented)throw o}return s.then(o=>{for(const r of o||[])r.status==="rejected"&&a(r.reason);return e().catch(a)})},G=[{code:"ja",name:"Japanese · Kana",direction:"ltr"},{code:"ar",name:"Arabic",direction:"rtl"}],de=Object.freeze(Object.defineProperty({__proto__:null,default:G},Symbol.toStringTag,{value:"Module"})),A=G,ue=Object.assign({"../data/lang/index.json":()=>I(()=>Promise.resolve().then(()=>de),void 0).then(i=>i.default),"../data/lang/ja.json":()=>I(()=>import("./ja-DEJkL8aw.js"),[]).then(i=>i.default)});class he{constructor(){var s;const e=localStorage.getItem("kanaPop.lang"),t=(s=navigator.language)==null?void 0:s.slice(0,2);this.defaultCode=e||t||"ja";let n=A.find(a=>a.code===this.defaultCode);n||(console.warn(`LanguageService: Default code '${this.defaultCode}' not in manifest. Falling back to first manifest entry or 'ja'.`),n=A.find(a=>a.code==="ja")||A[0]),n?this.lang={code:n.code,name:n.name,symbols:[],direction:n.direction}:(console.error("LanguageService: CRITICAL - Language manifest is empty or essential fallbacks are missing. App functionality will be severely impaired."),this.lang={code:this.defaultCode,name:"Error: Language Undefined",symbols:[],direction:"ltr"})}async load(e=this.defaultCode){const t=A.find(o=>o.code===e);if(!t){if(console.error(`LanguageService: Language code '${e}' not found in manifest. Attempting to fall back.`),e!==this.defaultCode&&A.find(r=>r.code===this.defaultCode))return console.warn(`LanguageService: Falling back to default language '${this.defaultCode}'.`),this.load(this.defaultCode);throw new Error(`LanguageService: Language code '${e}' (and default '${this.defaultCode}') not found in manifest.`)}if(e==="index")throw new Error("LanguageService: index.json is the manifest, not a language data file.");const n=`../data/lang/${e}.json`,s=ue[n];if(!s)throw console.error(`LanguageService: No data file loader found for code '${e}' (path: '${n}'). Check glob pattern and file existence.`),new Error(`LanguageService: No data file loader for '${e}'.`);let a;try{a=await s()}catch(o){throw console.error(`LanguageService: Failed to load language data file for code '${e}' from '${n}'.`,o),new Error(`LanguageService: Failed to load data for '${e}'.`)}this.lang={symbols:a.symbols||[],code:t.code||a.code,name:t.name,direction:t.direction},a.code&&a.code!==t.code&&(console.warn(`LanguageService: Mismatch! Requested/Manifest code '${t.code}', but file contains code '${a.code}'. Prioritizing manifest code.`),this.lang.code=t.code),localStorage.setItem("kanaPop.lang",this.lang.code)}get symbols(){return this.lang.symbols}get currentCode(){return this.lang.code}get direction(){return this.lang.direction}randomGlyph(e){const t=Object.values(e.glyphs);return t.length===0?(console.warn(`LanguageService: Symbol with roman='${e.roman}' (category: ${e.category}, lang: ${this.lang.code}) has no glyphs defined. Returning '?' as fallback.`),"?"):t[Math.floor(Math.random()*t.length)]}}const g=new he;class fe{constructor(){this.bank=new Map;const e=navigator.userAgent;this.isIOS=/iPad|iPhone|iPod/.test(e)&&!window.MSStream,this.isSafari=/Safari/.test(e)&&!/Chrome/.test(e),this.isIPadOS=/iPad/.test(e)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1}async context(){if(!this.ctx){const e=globalThis,t=e.AudioContext??e.webkitAudioContext;if(!t)throw new Error("Web Audio API not supported");try{this.ctx=new t({latencyHint:"interactive"}),this.ctx.onstatechange=()=>console.warn("[Audio] state →",this.ctx.state)}catch(n){console.error("[Audio] Failed to create AudioContext:",n),this.ctx=new t,this.ctx.onstatechange=()=>console.warn("[Audio] state →",this.ctx.state)}}if(this.ctx.state==="suspended"){console.warn(`[Audio] Attempting to resume context from ${this.ctx.state} state...`);try{if(this.isIOS||this.isIPadOS){if(await this.ctx.resume(),this.ctx.state==="suspended"){console.warn("[Audio] First resume attempt didn't work, trying again...");for(let e of[100,300,500])if(await new Promise(t=>setTimeout(t,e)),console.warn(`[Audio] Resume attempt with delay ${e}ms...`),await this.ctx.resume(),this.ctx.state==="running"){console.warn(`[Audio] Context resumed after ${e}ms delay`);break}}this.isIPadOS&&this.isSafari&&this.ctx.state==="suspended"&&(console.warn("[Audio] iPadOS Safari detected, trying special handling..."),this.ctx.createGain().connect(this.ctx.destination),await this.ctx.resume())}else await this.ctx.resume();console.warn(`[Audio] Context resumed successfully: ${this.ctx.state}`)}catch(e){throw console.error("Error resuming AudioContext:",e),e}}return this.ctx}async fetch(e){if(this.bank.has(e))return this.bank.get(e);const t=await(await fetch(e)).arrayBuffer(),n=await this.context();try{const s=await n.decodeAudioData(t);return this.bank.set(e,s),s}catch(s){throw console.error(`AudioBufferBank: decodeAudioData failed for ${e}`,s),s}}async play(e){const t=await this.context(),n=t.createBufferSource();n.buffer=e,n.connect(t.destination),n.start()}async resume(){try{const e=await this.context();if(this.isIOS||this.isIPadOS){const t=e.sampleRate||44100,n=e.createBuffer(1,t*.1,t),s=this.isIPadOS&&this.isSafari?.05:.001,a=e.createGain();a.gain.value=.1;const o=e.createBufferSource();if(o.buffer=n,o.connect(a),a.connect(e.destination),o.start(0),o.stop(s),console.warn(`[Audio] iOS/iPadOS unlock attempt with silent buffer (duration: ${s}s)`),this.isIPadOS&&this.isSafari&&(await new Promise(r=>setTimeout(r,300)),e.state==="suspended")){console.warn("[Audio] iPad Safari still suspended, trying one more unlock attempt");const r=e.createBufferSource();r.buffer=n,r.connect(e.destination),r.start(0),await e.resume()}}return e}catch(e){throw console.error("[Audio] Resume failed:",e),e}}}const L=class L{constructor(){this.bank=new fe,this.isGestureArmed=!1,this.ready=new Promise(e=>this.triggerReady=e)}async armFirstGesture(e=window){if(this.isGestureArmed)return;this.isGestureArmed=!0,console.warn("SoundService: First gesture armed.");const t=navigator.userAgent,n=/iPad|iPhone|iPod/.test(t)&&!window.MSStream,s=/Safari/.test(t)&&!/Chrome/.test(t),a=/iPad/.test(t)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1;console.warn(`Device detected: ${n?"iOS":a?"iPadOS":"other"}, Browser: ${s?"Safari":"other"}`);const o=()=>{console.warn("User interaction detected, attempting to unlock audio...");const r=new Audio(L.SILENT);(n||a)&&(r.setAttribute("playsinline",""),r.setAttribute("autoplay",""),r.muted=!0,r.playbackRate=1,s&&(r.controls=!1,r.preload="auto"));const f=r.play();f instanceof Promise?f.then(()=>{console.warn("Silent audio played successfully")}).catch(c=>{if(console.warn("Silent audio playback for arming gesture failed:",c),a&&s){console.warn("iPad Safari detected, trying alternative audio unlock...");try{const u=new Audio;u.src=L.SILENT,u.setAttribute("playsinline",""),u.muted=!0,u.play().catch(l=>console.warn("Alternative unlock also failed:",l))}catch(u){console.warn("Alternative audio unlock approach failed:",u)}}}).finally(async()=>{try{await this.bank.resume(),console.warn("AudioContext resumed successfully in gesture handler"),this.triggerReady()}catch(c){console.error("Failed to resume audio context:",c)}}):(console.warn("Browser returned no promise from play() - older Safari?"),(async()=>{try{await this.bank.resume(),console.warn("AudioContext resumed successfully in gesture handler (non-promise path)"),this.triggerReady()}catch(c){console.error("Failed to resume audio context (non-promise path):",c)}})())};n||a?(["touchend","touchstart","pointerup","pointerdown","click"].forEach(c=>{e.addEventListener(c,o,{once:!0,passive:!0})}),a&&s&&(console.warn("iPadOS Safari detected, applying special handling"),["mousedown","keydown"].forEach(c=>{e.addEventListener(c,o,{once:!0,passive:!0})}),document.addEventListener("touchend",o,{once:!0,passive:!0}),document.body.addEventListener("touchstart",o,{once:!0,passive:!0})),(a&&s?[500,1e3,2e3]:[1e3]).forEach(c=>{setTimeout(()=>{if(!this.triggerReady)return;console.warn(`Adding backup audio unlock handler (delay: ${c}ms)`);const u=async()=>{try{await this.bank.resume(),this.triggerReady()}catch(l){console.error("Backup handler failed:",l)}};document.body.addEventListener("touchend",u,{once:!0}),a&&s&&document.addEventListener("click",u,{once:!0})},c)})):["pointerdown","touchstart","mousedown","keydown"].forEach(r=>e.addEventListener(r,o,{once:!0,passive:!0}))}async play(e){if(await this.ready,e.endsWith("fallback.mp3"))return;const t=B(`/kana-pop/audio/${e}`);try{const n=await this.bank.fetch(t);await this.bank.play(n)}catch(n){console.warn(`SoundService: Web Audio playback failed for ${t}, falling back to HTMLAudioElement. Error:`,n),new Audio(t).play().catch(s=>{console.error(`SoundService: HTMLAudioElement fallback also failed for ${t}:`,s)})}}playRoman(e){var n;const t=(n=g.symbols.find(s=>s.roman===e))==null?void 0:n.audio;t&&this.play(`${g.currentCode}/${t}`)}async preloadAll(e){await this.ready,await Promise.all(e.map(t=>{if(t.endsWith("fallback.mp3"))return Promise.resolve();const n=B(`/kana-pop/audio/${t}`);return this.bank.fetch(n).catch(()=>{})}))}};L.SILENT="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAIlYAACJWAAABAAgAZGF0YQAAAAA=";let O=L;const R=new O;function B(i){return i.startsWith("data:")?i:`${i}?v=mbizv04a`}class ge{constructor(e,t,n,s=.2,a=1){this.x=e,this.y=t,this.text=n,this.speed=s,this.ttl=a}step(e){this.ttl-=e,this.y-=this.speed*e}draw(e){if(this.ttl<=0)return;const{w:t,h:n}=v(e.canvas),s=x();e.save(),e.globalAlpha=Math.max(0,this.ttl),e.fillStyle=H,e.font=`${Math.round(s*.7)}px ${_}`,e.textAlign="center",e.textBaseline="middle",e.fillText(this.text,this.x*t,this.y*n),e.restore()}}const S=new y("Play");let k=0,F=0;const me=i=>Math.floor(Math.random()*i),pe=()=>E.length===0?"#FFFFFF":E[Math.floor(Math.random()*E.length)]??"#FFFFFF";function we(i){let e=[],t=i.canvas.clientWidth,n=i.canvas.clientHeight,s=0;const a=new oe,o=new re;let r=[],f=!1;const c=()=>{const{w:l,h}=v(i.canvas);if(t===0||n===0){t=l,n=h;return}const d=l/t,m=h/n;if(!Number.isFinite(d)||d===0||!Number.isFinite(m)||m===0){t=l,n=h;return}t=l,n=h},u=l=>{const h=i.canvas.getBoundingClientRect(),d=l.clientX-h.left,m=l.clientY-h.top,{w:C,h:q}=v(i.canvas);for(let $=e.length-1;$>=0;$--){const p=e[$];if(p&&p.contains(d,m,C,q)){p.pop(),R.playRoman(p.romaji),r.push(new ge(p.x,p.y,p.romaji,p.speed));break}}};return{update(l){if(!f)return;z(i);const h=l;if(l=Math.min(h,.1),k+=h,F++,k>=1){const d=Math.round(F/k);y.isDebug&&S.debug("fps",d),k=0,F=0}if(s-=l,s<=0&&g.symbols&&g.symbols.length>0){const d=g.symbols[me(g.symbols.length)],m=g.randomGlyph(d),C=new ie(Math.random(),1,pe(),m,d.roman);e.push(C),S.debug("spawned bubble",e.length),s=V}e.some(d=>!d.active)&&(e=e.filter(d=>d.active)),r.some(d=>d.ttl<=0)&&(r=r.filter(d=>d.ttl>0)),o.update(l),e.forEach(d=>d.step(l)),r.forEach(d=>d.step(l)),o.draw(i),e.forEach(d=>a.render(i,d)),r.forEach(d=>d.draw(i))},async enter(){S.info("Play screen entered"),await g.load("ja"),R.preloadAll(g.symbols.map(l=>`${g.currentCode}/${l.audio}`)).catch(l=>S.warn("audio preload",l)),f=!0,b.subscribe(c),c(),i.canvas.addEventListener("pointerdown",u)},exit(){S.info("Play screen exited"),b.unsubscribe(c),i.canvas.removeEventListener("pointerdown",u),e=[],r=[]}}}const U=document.querySelector("#game"),N=U.getContext("2d");R.armFirstGesture(window);b.watchCanvas(U);const P=new se;P.add("menu",ae(P,N)).add("play",we(N));P.change("menu");let D=performance.now();function Q(i){const e=(i-D)/1e3;D=i,P.update(e),requestAnimationFrame(Q)}requestAnimationFrame(Q);
