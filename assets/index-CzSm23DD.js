(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=e(i);fetch(i.href,a)}})();function y(o){const{clientWidth:t,clientHeight:e}=o;return{w:t,h:e}}function ut(){return window.devicePixelRatio||1}function X(o){const t=ut();o.setTransform(1,0,0,1,0,0),o.scale(t,t)}function At(o){const t=ut(),{w:e,h:s}=y(o);return o.width=Math.round(e*t),o.height=Math.round(s*t),{w:e,h:s,dpr:t}}class Et{constructor(){this.listeners=new Set,this.watchedCanvases=new Map,this.mediaQuery=null,this.boundTrigger=this.trigger.bind(this),this.dprCallback=null,this.metrics={w:0,h:0,dpr:1}}subscribe(t){this.listeners.add(t),t(),this.listeners.size===1&&this.attachWindowListeners()}unsubscribe(t){this.listeners.delete(t),this.listeners.size===0&&this.detachWindowListeners()}watchCanvas(t){const e=()=>{const s=At(t);this.metrics=s};this.watchedCanvases.set(t,e),this.subscribe(e)}unwatchCanvas(t){const e=this.watchedCanvases.get(t);e&&(this.unsubscribe(e),this.watchedCanvases.delete(t))}trigger(){this.listeners.forEach(t=>t())}attachWindowListeners(){typeof window<"u"&&(window.addEventListener("resize",this.boundTrigger),this.addDprListener())}detachWindowListeners(){var t;typeof window<"u"&&window.removeEventListener("resize",this.boundTrigger),this.dprCallback&&((t=this.mediaQuery)==null||t.removeEventListener("change",this.dprCallback)),this.mediaQuery=null,this.dprCallback=null}addDprListener(){var t;typeof window>"u"||typeof window.matchMedia>"u"||(this.dprCallback&&((t=this.mediaQuery)==null||t.removeEventListener("change",this.dprCallback)),this.mediaQuery=matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`),this.dprCallback=()=>{this.boundTrigger(),this.addDprListener()},this.mediaQuery.addEventListener("change",this.dprCallback,{once:!0}))}get cssWidth(){return this.metrics.w}get cssHeight(){return this.metrics.h}get dpr(){return this.metrics.dpr}}const T=new Et,Tt="/kana-pop/assets/background-D-U8xQFM.png",kt="/kana-pop/assets/background1-Bjf-n90B.png",xt="/kana-pop/assets/background-D-U8xQFM.png",Ct="/kana-pop/assets/background_vertical-3wb079fu.png",Pt="data:application/json;base64,WyIjRkZEMURDIiwgIiNCNUVBRDciLCAiI0M3Q0VFQSIsICIjRkZEQUMxIiwgIiNFMkYwQ0IiXQo=",Lt="data:application/json;base64,ewogICJuYW1lIjogIlBhc3RlbCBQb25kIiwKICAiYXNzZXRzIjogeyAicGFsZXR0ZSI6ICJwYWxldHRlLmpzb24iIH0sCiAgImVmZmVjdCI6IHsKICAgICJ0eXBlIjogImltYWdlIiwKICAgICJob3Jpem9udGFsIjogImJhY2tncm91bmRfaG9yaXpvbnRhbC5wbmciLAogICAgInZlcnRpY2FsIjogImJhY2tncm91bmRfdmVydGljYWwucG5nIgogIH0KfQo=",ft="Pastel Pond",gt={palette:"palette.json"},mt={type:"image",horizontal:"background_horizontal.png",vertical:"background_vertical.png"},_t={name:ft,assets:gt,effect:mt},It=Object.freeze(Object.defineProperty({__proto__:null,assets:gt,default:_t,effect:mt,name:ft},Symbol.toStringTag,{value:"Module"})),$t=["#FFD1DC","#B5EAD7","#C7CEEA","#FFDAC1","#E2F0CB"],Rt=Object.freeze(Object.defineProperty({__proto__:null,default:$t},Symbol.toStringTag,{value:"Module"})),Mt=1.2,Ot=.36,Bt=["#ffaaa5","#ffd3b6","#c7ceea","#e2f0cb","#b5ead7"];let pt=null;function Ht(o){pt=o}function jt(){return pt??Bt}const q="#222",zt="Noto Sans JP, sans-serif",Dt=q,Nt=.1,Ft=.85,Ut=.65,Wt=.4,B=50,tt=.08,et=.1,st=.14,P=.85,H=1.2,it=0,nt=.15,Vt=.6,j=4,Gt="__kanaPopDebug_",Qt=40,Yt=60,Xt=250,qt=!0,S=class S{constructor(t,e=S.bootLevel){this.scope=t,this.level=e}out(t,...e){}debug(...t){this.out("debug",...t)}info(...t){this.out("info",...t)}warn(...t){this.out("warn",...t)}error(...t){this.out("error",...t)}};S.bootLevel=(()=>{if(typeof globalThis>"u"||!("localStorage"in globalThis))return"info";const t=localStorage.getItem("logLevel");return t&&["debug","info","warn","error","off"].includes(t)?t:"info"})(),S.isDebug=S.bootLevel==="debug",S.levelOrder={debug:0,info:1,warn:2,error:3,off:4};let f=S;function Kt(){return{setLevel(o){localStorage.setItem("logLevel",o),location.reload()}}}typeof window<"u"&&(window.logger=Kt());const A=class A{constructor(t){this.ready=!1,this.imgHorizontal=null,this.imgVertical=null,this.loadedHorizontal=!1,this.loadedVertical=!1,typeof window<"u"?(this.imgHorizontal=new Image,this.imgHorizontal.onload=()=>{var e;A.log.debug(`Loaded horizontal image: ${(e=this.imgHorizontal)==null?void 0:e.src}`),this.loadedHorizontal=!0,this.updateReadyState()},this.imgHorizontal.onerror=()=>{var e;this.loadedHorizontal=!1,A.log.error(`Failed to load horizontal image: ${(e=this.imgHorizontal)==null?void 0:e.src}`),this.updateReadyState()},this.imgHorizontal.src=t.horizontal,this.imgVertical=new Image,this.imgVertical.onload=()=>{var e;A.log.debug(`Loaded vertical image: ${(e=this.imgVertical)==null?void 0:e.src}`),this.loadedVertical=!0,this.updateReadyState()},this.imgVertical.onerror=()=>{var e;this.loadedVertical=!1,A.log.error(`Failed to load vertical image: ${(e=this.imgVertical)==null?void 0:e.src}`),this.updateReadyState()},this.imgVertical.src=t.vertical):this.ready=!0}resize(){}updateReadyState(){this.ready=this.loadedHorizontal||this.loadedVertical}update(t,e){if(!this.ready)return!1;const s=e.canvas.width,i=e.canvas.height,a=s/i;let n=null;if(a>=1?n=this.loadedHorizontal?this.imgHorizontal:this.imgVertical:n=this.loadedVertical?this.imgVertical:this.imgHorizontal,!n||!n.complete||n.naturalWidth===0)return!1;const r=n.naturalWidth/n.naturalHeight;let l,c,d=0,u=0;return r>a?(c=i,l=c*r,d=(s-l)/2):(l=s,c=l/r,u=(i-c)/2),e.drawImage(n,d,u,l,c),!0}};A.log=new f("ImageEffect");let F=A;class Jt{constructor(t){this.vid=null,typeof document<"u"&&typeof window<"u"&&(this.vid=document.createElement("video"),this.vid.src=t,this.vid.autoplay=!0,this.vid.loop=!0,this.vid.muted=!0,this.vid.style.position="fixed",this.vid.style.top="0",this.vid.style.left="0",this.vid.style.width="100%",this.vid.style.height="100%",this.vid.style.objectFit="cover",this.vid.style.zIndex="-1",document.body.appendChild(this.vid))}resize(){}update(t,e){return!1}dispose(){this.vid&&this.vid.parentNode&&(this.vid.parentNode.removeChild(this.vid),this.vid=null)}}const E=new f("ShaderEffect");class Zt{constructor(t){this.container=null,this.shaderConfig=t,E.debug(`ShaderEffect created with config: ${this.shaderConfig}`)}mount(t){this.container=t;const e=document.createElement("div");e.style.width="100%",e.style.height="100%",e.style.backgroundColor="rgba(50, 0, 50, 0.8)",e.textContent=`Shader Effect: ${this.shaderConfig}`,e.style.color="white",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",this.container.appendChild(e),E.debug("ShaderEffect mounted. Config:",this.shaderConfig)}unmount(){if(this.container){for(;this.container.firstChild;)this.container.removeChild(this.container.firstChild);E.debug("ShaderEffect unmounted.")}this.container=null}resize(t,e,s){E.debug(`ShaderEffect resize called: ${t}x${e} @ ${s}x`)}update(t,e){return E.debug(`ShaderEffect update called with dt: ${t}`),!1}}class te{constructor(t){this.cls=t,document.body.classList.add(t)}resize(){}update(){return!1}dispose(){document.body.classList.remove(this.cls)}}const at=Object.assign({"../assets/themes/pastel-pond/background.png":Tt,"../assets/themes/pastel-pond/background1.png":kt,"../assets/themes/pastel-pond/background_horizontal.png":xt,"../assets/themes/pastel-pond/background_vertical.png":Ct,"../assets/themes/pastel-pond/palette.json":Pt,"../assets/themes/pastel-pond/theme.json":Lt}),rt=Object.assign({"../assets/themes/pastel-pond/theme.json":It}),ee=Object.assign({"../assets/themes/pastel-pond/palette.json":Rt});class se{async load(t){const e=`../${t.endsWith("/")?t:t+"/"}theme.json`.replace(/^\.\.\/\/+/,"../"),s=rt[e];if(!s)throw new Error(`Theme manifest not embedded for base '${t}'. Tried key '${e}'. Available MANIFESTS keys: ${Object.keys(rt).join(", ")}`);const i=s.assets.palette.startsWith("/")?s.assets.palette.substring(1):s.assets.palette,a=`../${t.endsWith("/")?t:t+"/"}${i}`.replace(/^\.\.\/\/+/,"../"),n=ee[a]??["#ffffff"],r=await this.makeEffect(s.effect,t);return this.current={name:s.name,palette:n,effect:r},Ht(n),this.current}get theme(){return this.current}async makeEffect(t,e){const s=e.replace(/^assets\/themes\//,"").replace(/\/$/,"");function i(a){const n=`../assets/themes/${s}/${a}`,r=at[n];if(r===void 0)throw console.error(`[ThemeService] Asset URL not found for key: ${n}`),console.error("[ThemeService] Attempted to load file:",a,"from theme folder:",s),console.error("[ThemeService] Available keys from glob:",Object.keys(at)),new Error(`Asset URL not found by viteAssetUrl: ${n}. Check theme.json and asset paths.`);return r}if(t.type==="image"){const a=i(t.horizontal),n=i(t.vertical);return new F({horizontal:a,vertical:n})}else if(t.type==="video"){const a=i(t.file);return new Jt(a)}else if(t.type==="script")try{const r=(await import(`/src/assets/themes/${s}/${t.file}`))[t.export];if(typeof r=="function")return new r(e);throw new Error(`Export "${t.export}" from script "${t.file}" is not a constructor.`)}catch(a){throw console.error(`Failed to load script effect "${t.file}":`,a),a}else{if(t.type==="shader")return new Zt(t.shader);if(t.type==="css")return new te(t.class);{const a=t;throw new Error(`ThemeService: unknown effect type: ${JSON.stringify(a)}`)}}}}const U=new se;class ie{constructor(t){this.canvas=t,this.time=0;const e=t.getContext("2d");if(!e)throw new Error("2-D context not available");this.ctx=e,T.watchCanvas(t),T.subscribe(()=>this.paint(0))}paint(t){var i,a,n;this.time+=t,X(this.ctx);const e=window.devicePixelRatio||1;if(this.ctx.save(),this.ctx.scale(1/e,1/e),!((a=(i=U.theme)==null?void 0:i.effect)==null?void 0:a.update(t,this.ctx))){const{w:r,h:l}=y(this.canvas);this.ctx.fillStyle=((n=U.theme)==null?void 0:n.palette[2])??"#c7ceea",this.ctx.fillRect(0,0,r,l)}this.ctx.restore()}}const ne=new f("SM");class ae{constructor(){this.states=new Map,this.stack=[]}add(t,e){return this.states.set(t,e),this}async change(t){var e,s;ne.info("→ change",{from:this.currentName,to:t}),(e=this.current)!=null&&e.exit&&this.current.exit(),this.current=this.states.get(t),this.currentName=t,(s=this.current)!=null&&s.enter&&await this.current.enter()}update(t){var e,s;(s=(e=this.current)==null?void 0:e.update)==null||s.call(e,t)}get currentStateName(){return this.currentName}async push(t){var e;this.current&&(this.stack.push(this.current),this.current.exit&&this.current.exit()),this.current=this.states.get(t),this.currentName=t,(e=this.current)!=null&&e.enter&&await this.current.enter()}async pop(){var t,e,s;this.stack.length&&((t=this.current)!=null&&t.exit&&this.current.exit(),this.current=this.stack.pop(),this.currentName=this.current?(e=[...this.states.entries()].find(([,i])=>i===this.current))==null?void 0:e[0]:void 0,(s=this.current)!=null&&s.enter&&await this.current.enter())}}class bt{constructor(t,e){this.resizeHandler=this.paint.bind(this),this.sm=t,this.ctx=e}async enter(){T.subscribe(this.resizeHandler),this.paint()}update(t){}exit(){T.unsubscribe(this.resizeHandler)}clear(){const{w:t,h:e}=y(this.ctx.canvas);return this.ctx.clearRect(0,0,t,e),X(this.ctx),{w:t,h:e}}}const re={pop:50,error:[50,100,50],success:[50,50,50,50,100],gameOver:[100,50,100,50,300]},z=new f("Storage");class oe{constructor(){this.isNative=!1,this.storage=this.detectStorage()}detectStorage(){if(typeof window<"u"&&typeof localStorage=="object")try{const t="__storage_test__";return localStorage.setItem(t,t),localStorage.removeItem(t),z.debug("Using native localStorage"),this.isNative=!0,localStorage}catch(t){z.warn("localStorage detected but unavailable (Safari private mode?), using memory storage",t)}else z.info("No localStorage available (Node/test environment), using memory storage");return new Map}get(t){if(this.isNative)return this.storage.getItem(t);const e=this.storage;return e.has(t)?e.get(t):null}set(t,e){this.isNative?this.storage.setItem(t,e):this.storage.set(t,e)}remove(t){this.isNative?this.storage.removeItem(t):this.storage.delete(t)}clear(){this.isNative?this.storage.clear():this.storage.clear()}}const k=new oe,b=new f("Haptics");class le{constructor(){if(this.enabled=k.get("kanaPop.haptics")!=="false"&&qt,this.debugElement=null,this.lastVibration=0,this.patternArraysOkay=null,!(typeof window>"u"||typeof navigator>"u")){if(window.matchMedia("(prefers-reduced-motion: reduce)").matches){b.info("Haptics disabled due to reduced-motion preference.");return}if(typeof navigator.vibrate=="function"){this.enabled=!0,b.info("Haptic feedback enabled.");const t=()=>{this.updateDebugStatus("Activation gesture received (resume only)")};window.addEventListener("pointerdown",t,{once:!0,passive:!0})}else b.info("Haptic feedback not supported on this device.")}}async vibrate(t=50,e=2){if(!this.enabled)return Promise.resolve(!1);if(this.patternArraysOkay===null)try{navigator.vibrate([1,1])?(navigator.vibrate(0),this.patternArraysOkay=!0,this.updateDebugStatus("Array patterns seem supported.")):(this.patternArraysOkay=!1,this.updateDebugStatus("Array patterns rejected (vibrate returned false)."))}catch(r){this.patternArraysOkay=!1,this.updateDebugStatus(`Array patterns rejected (vibrate threw error: ${r instanceof Error?r.message:String(r)}).`)}const s=Date.now(),i=Array.isArray(t),a=i?Xt:Yt;if(s-this.lastVibration<a)return this.updateDebugStatus(`Throttled (gap: ${a}ms)`),Promise.resolve(!1);let n;if(i)n=t.map(r=>Math.max(r,B)),!this.patternArraysOkay&&n.length>0&&(n=Math.max(...n,B),this.updateDebugStatus("Collapsed array to single max pulse for compatibility."));else{const r=Math.max(t,B),l=Qt;switch(e){case 1:n=r;break;case 2:n=Math.min(r*1.5,150);break;case 3:n=this.patternArraysOkay?[r,l,r]:r*2;break;default:return b.warn(`Invalid intensity: ${e} for numeric pattern.`),Promise.resolve(!1)}}try{return Array.isArray(n)&&n.length===0?(b.warn("Attempted to vibrate with an empty pattern array."),Promise.resolve(!1)):typeof n=="number"&&n===0&&t!==0?(b.warn("Calculated vibration duration is zero, skipping."),Promise.resolve(!1)):navigator.vibrate(n)?(this.lastVibration=s,this.updateDebugStatus(`Vibrated: ${JSON.stringify(n)}`),b.info("Vibrating with:",{originalPattern:t,intensity:e,actualVibration:n}),Promise.resolve(!0)):(this.updateDebugStatus("navigator.vibrate() returned false."),b.warn("navigator.vibrate() returned false for pattern:",n),Promise.resolve(!1))}catch(r){return b.warn("Vibration failed with error:",r),this.updateDebugStatus(`Failed: ${r instanceof Error?r.message:String(r)}`),Array.isArray(n)&&this.patternArraysOkay&&(this.patternArraysOkay=!1,this.updateDebugStatus("Error with array vibration, marked arrays as not okay for future.")),Promise.resolve(!1)}}isSupported(){return this.enabled}createDebugElement(){var e;if(typeof document>"u")return;const t=`${Gt}Haptics`;(e=document.getElementById(t))==null||e.remove(),this.debugElement=document.createElement("div"),this.debugElement.id=t,this.debugElement.style.position="fixed",this.debugElement.style.bottom="30px",this.debugElement.style.left="10px",this.debugElement.style.background="rgba(0,0,0,0.5)",this.debugElement.style.color="white",this.debugElement.style.padding="5px",this.debugElement.style.fontSize="12px",this.debugElement.style.zIndex="9999",this.debugElement.style.pointerEvents="none",document.body.appendChild(this.debugElement)}updateDebugStatus(t){this.debugElement&&(this.debugElement.textContent=`Haptics: ${t}`)}vibratePattern(t){const e=re[t];return typeof e=="number"?this.vibrate(e):this.vibrate([...e])}setEnabled(t){this.enabled=t,k.set("kanaPop.haptics",String(t)),t||navigator.vibrate(0)}isEnabled(){return this.enabled}}const W=new le;class ce{constructor(t){this.onClose=t,this.overlay=document.createElement("div"),this.overlay.style.cssText=`
      position:fixed;inset:0;background:rgba(0,0,0,.6);
      color:${q};display:flex;flex-direction:column;
      align-items:center;justify-content:center;
      font:18px sans-serif;z-index:50`,this.overlay.innerHTML=`
      <h2 style="margin:0 0 20px">Settings</h2>
      <label style="margin-bottom:15px;display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="hapticsToggle">
        Haptics
      </label>
      <button id="close">Close</button>`,this.overlay.querySelector("#close").addEventListener("click",()=>this.toggle());const e=this.overlay.querySelector("#hapticsToggle");e.addEventListener("change",()=>{W.setEnabled(e.checked)})}toggle(){document.body.contains(this.overlay)?this.hide():this.show()}show(){document.body.appendChild(this.overlay);const t=this.overlay.querySelector("#hapticsToggle");t.checked=W.isEnabled()}hide(){this.overlay.remove(),this.onClose()}}class he extends bt{constructor(){super(...arguments),this.settings=new ce(()=>{}),this.enter=async()=>{document.body.dataset.scene="home",await super.enter(),window.addEventListener("pointerdown",this.onTap)},this.exit=()=>{window.removeEventListener("pointerdown",this.onTap),this.settings.hide(),delete document.body.dataset.scene,super.exit()},this.onTap=t=>{const{w:e,h:s}=y(this.ctx.canvas),{offsetX:i,offsetY:a}=t;i>e-60&&a>s-60?this.settings.toggle():this.sm.change("play")}}paint(){const{w:t,h:e}=this.clear();this.ctx.fillStyle=q,this.ctx.textAlign="center",this.ctx.font="32px sans-serif",this.ctx.fillText("Tap to Start",t/2,e/2),this.ctx.font="20px sans-serif",this.ctx.fillText("⚙︎",t-30,e-30)}}function de(){if(typeof navigator>"u")return!1;const o=typeof navigator>"u"?"":navigator.userAgent;return/iPad|iPhone|iPod/.test(o)&&!(typeof window<"u"&&window.MSStream)}function ue(){if(typeof navigator>"u")return!1;const o=typeof navigator>"u"?"":navigator.userAgent;return/iPad/.test(o)||typeof navigator<"u"&&navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1}function V(){if(typeof navigator>"u")return!1;if(de()||ue())return!0;const o=typeof navigator>"u"?"":navigator.userAgent;return!!(/iPad|iPhone|iPod/.test(o)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>0)}const w=new f("Audio");class fe{constructor(){this.bank=new Map}async ensureContext(){const t=()=>{const e=globalThis,s=e.AudioContext??e.webkitAudioContext;if(!s)throw new Error("Web Audio API not supported");const i=new s;return w.info(`Created new AudioContext: ${i.state}`),i};if((!this.ctx||this.ctx.state==="closed")&&(this.ctx=t()),this.ctx.state==="suspended"||this.ctx.state==="interrupted"){w.info(`Attempting resume() from ${this.ctx.state}`);try{await this.ctx.resume()}catch(e){w.warn("resume() threw",e)}}if(this.ctx.state!=="running"){w.warn(`AudioContext stuck in '${this.ctx.state}', recreating…`);try{await this.ctx.close()}catch{}this.ctx=t(),await this.ctx.resume()}return this.ctx}async fetch(t){if(this.bank.has(t))return this.bank.get(t);try{const e=await(await fetch(t)).arrayBuffer(),i=await(await this.ensureContext()).decodeAudioData(e);return this.bank.set(t,i),i}catch(e){throw w.error(`decodeAudioData failed for ${t}`,e),e}}async play(t){const e=await this.ensureContext(),s=e.createBufferSource();s.buffer=t,s.connect(e.destination),s.start(),s.onended=()=>s.disconnect()}async resume(){try{const t=await this.ensureContext();if(V()){w.info("iOS/iPadOS detected, playing silent buffer to unlock audio");const e=t.sampleRate||44100,s=t.createBuffer(2,e*.5,e);for(let r=0;r<2;r++){const l=s.getChannelData(r);for(let c=0;c<l.length;c++)l[c]=0}const i=V()?.5:.1,a=t.createGain();a.gain.value=.001;const n=t.createBufferSource();n.buffer=s,n.connect(a),a.connect(t.destination),n.start(0),n.stop(t.currentTime+i),n.onended=()=>{n.disconnect(),a.disconnect()},w.info(`Silent buffer played (duration: ${i}s)`)}return t}catch(t){throw w.error("Resume failed",t),t}}}class ge{constructor(){this.tasks=[]}add(t){this.tasks.push(t)}async run(t,e=!0){if(this.tasks.length===0){t(1);return}if(e){let s=0;await Promise.all(this.tasks.map(i=>i().then(()=>{t(++s/this.tasks.length)})))}else for(let s=0;s<this.tasks.length;s++){const i=this.tasks[s];await i(),t((s+1)/this.tasks.length)}this.tasks=[]}}const K=new ge,me="modulepreload",pe=function(o){return"/kana-pop/"+o},ot={},lt=function(t,e,s){let i=Promise.resolve();if(e&&e.length>0){let n=function(c){return Promise.all(c.map(d=>Promise.resolve(d).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),l=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));i=n(e.map(c=>{if(c=pe(c),c in ot)return;ot[c]=!0;const d=c.endsWith(".css"),u=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${u}`))return;const g=document.createElement("link");if(g.rel=d?"stylesheet":me,d||(g.as="script"),g.crossOrigin="",g.href=c,l&&g.setAttribute("nonce",l),document.head.appendChild(g),d)return new Promise((M,O)=>{g.addEventListener("load",M),g.addEventListener("error",()=>O(new Error(`Unable to preload CSS for ${c}`)))})}))}function a(n){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=n,window.dispatchEvent(r),!r.defaultPrevented)throw n}return i.then(n=>{for(const r of n||[])r.status==="rejected"&&a(r.reason);return t().catch(a)})},v=class v{static async manifest(){if(!this.manifestPromise){if(!v.loadManifest)throw new Error("Manifest loader not found. Check glob pattern and file existence.");this.manifestPromise=v.loadManifest()}return this.manifestPromise}static async language(t){const e=`../data/lang/${t}.json`,s=v.langFiles[e];if(!s)throw new Error(`No language data file for '${t}'`);return s()}};v.manifestPromise=null,v.langFiles=Object.assign({"../data/lang/ja.json":()=>lt(()=>import("./ja-DEJkL8aw.js"),[]).then(t=>t.default)}),v.loadManifest=Object.assign({"../data/lang/index.json":()=>lt(()=>import("./index-BJLXKDTG.js"),[]).then(t=>t.default)})["../data/lang/index.json"];let I=v;const L=new f("Lang");class be{constructor(){var s;const t=k.get("kanaPop.lang"),e=typeof navigator<"u"?(s=navigator.language)==null?void 0:s.slice(0,2):void 0;this.defaultCode=t||e||"ja",this.lang={code:this.defaultCode,name:"loading…",symbols:[],direction:"ltr"},this.initialLoadPromise=new Promise(i=>{this.initialLoadResolve=i}),K.add(async()=>{L.info(`LanguageService: Starting initial load for language code '${this.defaultCode}'...`),await this.load(this.defaultCode),L.info("LanguageService: Initial load completed.")})}async load(t=this.defaultCode){const e=await I.manifest(),s=e.find(n=>n.code===t)??e.find(n=>n.code===this.defaultCode);if(!s)throw new Error("LanguageService: manifest empty");const i=await I.language(s.code);s.direction||L.warn(`'${s.code}' lacks "direction"; defaulting to 'ltr'`);const a=s.direction??"ltr";this.lang={code:s.code,name:s.name,symbols:i.symbols??[],direction:a},this.persistLang(this.lang.code),this.initialLoadResolve&&this.initialLoadResolve()}get symbols(){return this.lang.symbols}get currentCode(){return this.lang.code}get direction(){return this.lang.direction}randomGlyph(t){const e=Object.values(t.glyphs);return e.length===0?(L.warn(`Symbol with roman='${t.roman}' (category: ${t.category}, lang: ${this.lang.code}) has no glyphs defined. Returning '?' as fallback.`),"?"):e[Math.floor(Math.random()*e.length)]}persistLang(t){k.set("kanaPop.lang",t)}ready(){return this.initialLoadPromise}}const m=new be,h=new f("Sound"),$=class ${constructor(){this.bank=new fe,this.isGestureArmed=!1,this.assetLoadCompletedPromise=new Promise(t=>{this.assetLoadCompletedResolve=t}),K.add(async()=>{h.info("SoundService: Waiting for LanguageService to be ready..."),await m.ready(),h.info("SoundService: LanguageService is ready. Starting sound preload...");const t=m.symbols.map(e=>`${m.currentCode}/${e.audio}`);if(t.length>0)try{await this.preloadAll(t),h.info(`SoundService: Successfully preloaded ${t.length} sounds for language '${m.currentCode}'.`)}catch(e){h.error("SoundService: Error during sound preloading.",e)}else h.info(`SoundService: No sounds to preload for language '${m.currentCode}'.`);this.assetLoadCompletedResolve()}),this.ready=new Promise(t=>this.triggerReady=t),typeof document<"u"&&document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&(h.debug("Page became visible – poking AudioContext"),this.bank.ensureContext().catch(()=>{}))})}async armFirstGesture(t=window){if(this.isGestureArmed)return;this.isGestureArmed=!0,h.info("First gesture handler armed");const e=V(),s=[],i=(r,l)=>{r.addEventListener(l,n,{passive:!0}),s.push({target:r,type:l})},a=()=>{h.info("Trimming audio unlock listeners (keeping one for re-unlock)");let r=!1;s.forEach(({target:l,type:c})=>{if(!r&&l===window&&c==="pointerdown"){r=!0;return}l.removeEventListener(c,n)})},n=async()=>{h.info("User gesture detected, unlocking audio");let r=!1;try{await this.bank.resume(),h.info("Audio context unlocked successfully"),r=!0}catch(l){h.warn("AudioContext unlock failed, trying HTML Audio fallback",l);try{const c=new Audio($.SILENT);c.autoplay=!0,c.muted=!1,c.volume=.001,c.setAttribute("playsinline",""),h.info("Playing fallback HTML audio");const d=c.play();if(d instanceof Promise){await d,h.info("Fallback audio played successfully");try{await this.bank.resume(),h.info("Audio context unlocked after HTML audio fallback"),r=!0}catch(u){h.warn("Audio context still locked after HTML audio fallback",u)}}else h.warn("Fallback audio play() returned no promise")}catch(c){h.error("All audio unlock attempts failed",c)}}this.triggerReady(),r?a():h.warn("Audio still locked – listeners stay armed for another try")};h.info("Registering audio unlock gesture handlers"),i(t,"pointerdown"),i(t,"touchstart"),i(t,"click"),e&&(h.info("Adding extra handlers for iOS/iPadOS"),i(document.body,"pointerdown"),i(document.body,"touchstart"),i(document.body,"click"),i(document,"pointerdown"),i(document,"touchstart"),i(document,"click"),i(window,"pointerdown"),i(window,"touchstart"),i(window,"click"))}async play(t){if(await this.ready,t.endsWith("fallback.mp3"))return;const e=ct(`/kana-pop/audio/${t}`);try{const s=await this.bank.fetch(e);await this.bank.play(s)}catch(s){h.warn(`Web Audio playback failed for ${e}, using HTMLAudioElement fallback`,s),new Audio(e).play().catch(i=>{h.error(`HTMLAudioElement fallback also failed for ${e}`,i)})}}playRoman(t){var s;const e=(s=m.symbols.find(i=>i.roman===t))==null?void 0:s.audio;e&&this.play(`${m.currentCode}/${e}`)}async preloadAll(t){await this.ready,h.info(`Preloading ${t.length} audio files`),await Promise.all(t.map(e=>{if(e.endsWith("fallback.mp3"))return Promise.resolve();const s=ct(`/kana-pop/audio/${e}`);return this.bank.fetch(s).catch(i=>{h.warn(`Failed to preload audio: ${e}`,i)})})),h.info("Audio preloading complete")}assetsReady(){return this.assetLoadCompletedPromise}};$.SILENT="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAIlYAACJWAAABAAgAZGF0YQAAAAA=";let G=$;const yt=new G;function ct(o){return o.startsWith("data:")?o:`${o}?v=mbks8ngd`}const ht=new f("Bubble");class ye{constructor(t,e,s,i,a,n){this.x=t,this.y=e,this.color=s,this.glyph=i,this.romaji=a,this.active=!0,this.speed=.2,this._scale=1,this.animPhase="none",this.animTime=0,this.textScale=1,this.textOpacity=1,this.isTextTransitioning=!1,this.textTransitionTime=0,this.flashTimer=0,this.showingRomaji=!1,this.lastSpoken=-1/0,this.r=n,ht.debug("spawn",{x:this.x.toFixed(2),color:s,glyph:this.glyph})}handleClick(t){t-this.lastSpoken<Wt||(this.lastSpoken=t,W.vibratePattern("pop").catch(()=>{}),this.triggerTapAnimation(),this.startTextTransition(),yt.playRoman(this.romaji),this.flashTimer=it,ht.debug("toggle",{romaji:this.showingRomaji}))}triggerTapAnimation(){this.animPhase="squash",this.animTime=0,this.scale=1,this.textScale=P}startTextTransition(){this.isTextTransitioning=!0,this.textTransitionTime=nt,this.textOpacity=0}step(t){switch(this.y-=this.speed*t,this.y<-.05&&(this.active=!1),this.animPhase){case"squash":if(this.animTime+=t,this.animTime>=tt)this.animTime=0,this.animPhase="stretch",this.scale=P;else{const e=this.animTime/tt;this.scale=D(1,P,N(e))}break;case"stretch":if(this.animTime+=t,this.animTime>=et)this.animTime=0,this.animPhase="settle",this.scale=H;else{const e=this.animTime/et;this.scale=D(P,H,N(e))}break;case"settle":if(this.animTime+=t,this.animTime>=st)this.animTime=0,this.animPhase="none",this.scale=1;else{const e=this.animTime/st;this.scale=D(H,1,N(e))}break}this.flashTimer>0&&(this.flashTimer-=t,this.flashTimer<0&&(this.flashTimer=0)),this.isTextTransitioning?(this.textTransitionTime-=t,this.textTransitionTime<=0?(this.showingRomaji=!this.showingRomaji,this.isTextTransitioning=!1,this.textOpacity=1,this.textScale=1):this.textOpacity=Math.max(0,this.textTransitionTime/nt)):this.textScale<1&&(this.textScale=Math.min(1,this.textScale+t*5))}contains(t,e,s,i){if(!this.active)return!1;const a=this.x*s,n=this.y*i,r=t-a,l=e-n,c=r*r+l*l,d=this.r*this.scale;return c<=d*d}get flashAlpha(){return this.flashTimer>0?this.flashTimer/it:0}get currentTextOpacity(){return this.textOpacity}get currentTextScale(){return this.textScale}get scale(){return this._scale}set scale(t){this._scale=t}}function D(o,t,e){return o+(t-o)*e}function N(o){return o<1?1-(1-o)*(1-o):1}function dt(o,t){return Math.min(o,t)*Nt}const we=new f("BubbleMgr"),wt=o=>Math.floor(Math.random()*o),ve=()=>{const o=jt();return o.length===0?"#ffffff":o[wt(o.length)]??"#ffffff"};class Se{constructor(t){this.canvas=t,this.bubbles=[],this.spawnTimer=0,this.rPx=0;const{w:e,h:s}=y(t);this.rPx=dt(e,s)}get entities(){return this.bubbles}update(t){this.spawnTimer-=t,this.spawnTimer<=0&&(this.spawn(),this.spawnTimer=Mt),this.bubbles.forEach(e=>e.step(t)),this.bubbles.some(e=>!e.active)&&(this.bubbles=this.bubbles.filter(e=>e.active))}handleResize(){const{w:t,h:e}=y(this.canvas);this.rPx=dt(t,e),this.bubbles.forEach(s=>s.r=this.rPx)}hitTest(t,e){const{w:s,h:i}=y(this.canvas);for(let a=this.bubbles.length-1;a>=0;a--){const n=this.bubbles[a];if(n&&n.contains(t,e,s,i))return n}}clear(){this.bubbles=[]}spawn(){var r;if(!((r=m.symbols)!=null&&r.length))return;const t=m.symbols[wt(m.symbols.length)],e=m.randomGlyph(t),{w:s}=y(this.canvas),i=this.rPx/s,a=i+Math.random()*(1-2*i),n=1+i;this.bubbles.push(new ye(a,n,ve(),e,t.roman,this.rPx)),we.debug("spawn",{total:this.bubbles.length,roman:t.roman})}}class Ae{pastelDarken(t,e){const s=this.extractRGB(t),i=Math.floor(s.r*(1-e*.7)+30),a=Math.floor(s.g*(1-e)+20),n=Math.floor(s.b*(1-e*.5)+40);return`rgb(${Math.min(i,255)}, ${Math.min(a,255)}, ${Math.min(n,255)})`}pastelLighten(t,e){const s=this.extractRGB(t),i=Math.floor(s.r+(255-s.r)*e),a=Math.floor(s.g+(255-s.g)*e),n=Math.floor(s.b+(255-s.b)*e);return`rgb(${i}, ${a}, ${n})`}extractRGB(t){let e=100,s=100,i=100;if(t.startsWith("#")){const a=t.substring(1);e=parseInt(a.substring(0,2),16),s=parseInt(a.substring(2,4),16),i=parseInt(a.substring(4,6),16)}else if(t.startsWith("rgb")){const a=t.match(/\d+/g);a&&a.length>=3&&(e=parseInt(a[0]||"0"),s=parseInt(a[1]||"0"),i=parseInt(a[2]||"0"))}return{r:e,g:s,b:i}}render(t,e,s,i,a){const n=e.x*s,r=e.y*i,l=e.r*e.scale;t.save(),t.globalAlpha=Ot;const c=n-l*.3,d=r-l*.3,u=t.createRadialGradient(Number(c)||0,Number(d)||0,Math.max(1,l*.1),Number(n)||0,Number(r)||0,Math.max(1,l*1.2)),g=e.color||"#cccccc";u.addColorStop(0,"#ffffff"),u.addColorStop(.1,this.pastelLighten(g,.4)),u.addColorStop(.7,g);const M=this.pastelDarken(g,.15);u.addColorStop(.92,M),u.addColorStop(1,"rgba(0,0,0,0)"),t.fillStyle=u,t.beginPath(),t.arc(n,r,l,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(n,r,l*.96,0,Math.PI*2),t.shadowColor="rgba(255, 255, 255, 0.3)",t.shadowBlur=l*.15,t.shadowOffsetX=0,t.shadowOffsetY=0,t.fill(),t.beginPath(),t.globalAlpha=.3,t.fillStyle="#ffffff",t.arc(n-l*.43,r-l*.49,l*.2,0,Math.PI*2),t.fill(),t.beginPath(),t.globalAlpha=.25,t.arc(n-l*.1,r-l*.66,l*.1,0,Math.PI*2),t.fill(),t.restore();const O=e.showingRomaji?e.romaji:e.glyph,vt=e.showingRomaji?Ut:Ft,St=Math.round(e.r*e.currentTextScale*vt);t.save(),t.fillStyle=Dt,t.globalAlpha=e.currentTextOpacity,t.textAlign="center",t.textBaseline="middle",t.font=`${St}px ${zt}`,t.fillText(O,n,r),t.restore(),e.flashAlpha>0&&(t.save(),t.globalAlpha=e.flashAlpha*Vt,t.lineWidth=j,t.strokeStyle="#ffffff",t.shadowColor="rgba(255, 235, 245, 0.9)",t.shadowBlur=j*2.5,t.beginPath(),t.arc(n,r,l+j*.5,0,Math.PI*2),t.stroke(),t.restore())}}const Ee=new f("Pointer");class Te{constructor(t,e){this.canvas=t,this.bubbles=e,this.bound=this.onDown.bind(this)}attach(){this.canvas.addEventListener("pointerdown",this.bound)}detach(){this.canvas.removeEventListener("pointerdown",this.bound)}onDown(t){var n,r;const e=this.canvas.getBoundingClientRect(),s="clientX"in t?t.clientX:((n=t.touches[0])==null?void 0:n.clientX)??0,i="clientY"in t?t.clientY:((r=t.touches[0])==null?void 0:r.clientY)??0,a=this.bubbles.hitTest(s-e.left,i-e.top);a&&(a.handleClick(performance.now()/1e3),Ee.debug("hit",{roman:a.romaji}))}}class ke extends bt{constructor(){super(...arguments),this.bubbles=new Se(this.ctx.canvas),this.renderer=new Ae,this.input=new Te(this.ctx.canvas,this.bubbles)}async enter(){await super.enter(),this.bubbles.handleResize(),this.input.attach()}update(t){const{w:e,h:s}=y(this.ctx.canvas);this.ctx.clearRect(0,0,e,s),X(this.ctx),this.bubbles.update(t),this.bubbles.entities.forEach(i=>this.renderer.render(this.ctx,i,e,s))}exit(){this.input.detach(),this.bubbles.clear(),super.exit()}paint(){}}let p=null,_=null;const J=document.querySelector("#game");if(!J)throw new Error("#game canvas not found");const Q=J.getContext("2d");if(!Q)throw new Error("2-D context not available");const Z=document.createElement("canvas");Z.id="bg";document.body.prepend(Z);function Y(){document.documentElement.style.setProperty("--app-height",`${window.innerHeight}px`)}document.readyState==="loading"?window.addEventListener("DOMContentLoaded",Y,{once:!0}):Y();window.addEventListener("resize",Y);yt.armFirstGesture(window);T.watchCanvas(J);(async()=>{const o=k.get("kanaPop.theme")??"assets/themes/pastel-pond/";await U.load(o),p=new ae,p.add("home",new he(p,Q)).add("play",new ke(p,Q)),_=new ie(Z),await p.change("home"),K.run(()=>{}).catch(console.error),C=performance.now(),x=requestAnimationFrame(R)})();let x=0,C=performance.now();function R(o){const t=(o-C)/1e3;C=o,_==null||_.paint(t),p==null||p.update(t),x=requestAnimationFrame(R)}document.addEventListener("visibilitychange",()=>{document.hidden?cancelAnimationFrame(x):(C=performance.now(),x=requestAnimationFrame(R))});document.addEventListener("scenechange",o=>{const{nextScene:t}=o.detail;p&&p.change(t),C=performance.now(),x=requestAnimationFrame(R)});
