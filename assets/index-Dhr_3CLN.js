(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function t(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(n){if(n.ep)return;n.ep=!0;const s=t(n);fetch(n.href,s)}})();function ee(a){const e=window.devicePixelRatio||1,{clientWidth:t,clientHeight:i}=a;return a.width=Math.floor(t*e),a.height=Math.floor(i*e),{w:t,h:i,dpr:e}}class te{constructor(){this.listeners=new Set,this.watchedCanvases=new Map,this.mediaQuery=null,this.boundTrigger=this.trigger.bind(this),this.dprCallback=null,this.metrics={w:0,h:0,dpr:1}}subscribe(e){this.listeners.add(e),e(),this.listeners.size===1&&this.attachWindowListeners()}unsubscribe(e){this.listeners.delete(e),this.listeners.size===0&&this.detachWindowListeners()}watchCanvas(e){const t=()=>{const i=ee(e);this.metrics=i};this.watchedCanvases.set(e,t),this.subscribe(t)}unwatchCanvas(e){const t=this.watchedCanvases.get(e);t&&(this.unsubscribe(t),this.watchedCanvases.delete(e))}trigger(){this.listeners.forEach(e=>e())}attachWindowListeners(){window.addEventListener("resize",this.boundTrigger),this.addDprListener()}detachWindowListeners(){var e;window.removeEventListener("resize",this.boundTrigger),this.dprCallback&&((e=this.mediaQuery)==null||e.removeEventListener("change",this.dprCallback)),this.mediaQuery=null,this.dprCallback=null}addDprListener(){var e;this.dprCallback&&((e=this.mediaQuery)==null||e.removeEventListener("change",this.dprCallback)),this.mediaQuery=matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`),this.dprCallback=()=>{this.boundTrigger(),this.addDprListener()},this.mediaQuery.addEventListener("change",this.dprCallback,{once:!0})}get cssWidth(){return this.metrics.w}get cssHeight(){return this.metrics.h}get dpr(){return this.metrics.dpr}}const L=new te,ne=["#FFD1DC","#B5EAD7","#C7CEEA","#FFDAC1","#E2F0CB"],ie={colors:ne},ae=1.2,se=.5,P=ie.colors,G=P[2],q="#222";function B(){const a=L.cssWidth||window.innerWidth,e=L.cssHeight||window.innerHeight;return Math.min(a,e)*.06}const Q="Noto Sans JP, sans-serif",K=q,re=.7,A=class A{constructor(e,t=A.bootLevel){this.scope=e,this.level=t}out(e,...t){}debug(...e){this.out("debug",...e)}info(...e){this.out("info",...e)}warn(...e){this.out("warn",...e)}error(...e){this.out("error",...e)}};A.bootLevel=(()=>{const e=localStorage.getItem("logLevel");return e&&["debug","info","warn","error","off"].includes(e)?e:"info"})(),A.isDebug=A.bootLevel==="debug",A.levelOrder={debug:0,info:1,warn:2,error:3,off:4};let p=A;function oe(){return{setLevel(a){localStorage.setItem("logLevel",a),location.reload()}}}window.logger=oe();const le=new p("SM");class ce{constructor(){this.states=new Map}add(e,t){return this.states.set(e,t),this}change(e){var t,i,n,s;le.info("→ change",{from:this.currentName,to:e}),(i=(t=this.current)==null?void 0:t.exit)==null||i.call(t),this.current=this.states.get(e),this.currentName=e,(s=(n=this.current)==null?void 0:n.enter)==null||s.call(n)}update(e){var t,i;(i=(t=this.current)==null?void 0:t.update)==null||i.call(t,e)}get currentStateName(){return this.currentName}}function k(a){const{clientWidth:e,clientHeight:t}=a;return{w:e,h:t}}function Y(a){const e=window.devicePixelRatio||1;a.setTransform(1,0,0,1,0,0),a.scale(e,e)}function de(a,e){const t=()=>a.change("play");function i(){Y(e);const{w:n,h:s}=k(e.canvas);e.fillStyle=G,e.fillRect(0,0,n,s),e.fillStyle=q,e.textAlign="center",e.font="32px sans-serif",e.fillText("Tap to Start",n/2,s/2)}return{enter(){L.subscribe(i),e.canvas.addEventListener("pointerdown",t),e.canvas.addEventListener("touchstart",t)},update(){i()},exit(){L.unsubscribe(i),e.canvas.removeEventListener("pointerdown",t),e.canvas.removeEventListener("touchstart",t)}}}const _=new p("Bubble");class ue{constructor(e,t,i,n,s){this.x=e,this.y=t,this.color=i,this.glyph=n,this.romaji=s,this.active=!0,this.speed=.2,_.debug("spawn",{x:this.x.toFixed(2),color:i,glyph:this.glyph})}pop(){_.info("pop!"),this.active=!1}step(e){this.y-=this.speed*e,this.y<-.05&&(this.active=!1)}contains(e,t,i,n){if(!this.active)return!1;const s=this.x*i,o=this.y*n,r=e-s,f=t-o,l=r*r+f*f,g=B();return l<=g*g}}class he{constructor(){}update(e){}draw(e){const{w:t,h:i}=k(e.canvas);e.fillStyle=G,e.fillRect(0,0,t,i)}}class fe{render(e,t){const{w:i,h:n}=k(e.canvas),s=t.x*i,o=t.y*n,r=B();e.save(),e.globalAlpha=se,e.fillStyle=t.color,e.beginPath(),e.arc(s,o,r,0,Math.PI*2),e.fill(),e.restore(),e.fillStyle=K,e.textAlign="center",e.textBaseline="middle",e.font=`${Math.round(r*re)}px ${Q}`,e.fillText(t.glyph,s,o)}}const ge="modulepreload",me=function(a){return"/kana-pop/"+a},j={},D=function(e,t,i){let n=Promise.resolve();if(t&&t.length>0){let o=function(l){return Promise.all(l.map(g=>Promise.resolve(g).then(d=>({status:"fulfilled",value:d}),d=>({status:"rejected",reason:d}))))};document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),f=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));n=o(t.map(l=>{if(l=me(l),l in j)return;j[l]=!0;const g=l.endsWith(".css"),d=g?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${d}`))return;const u=document.createElement("link");if(u.rel=g?"stylesheet":ge,g||(u.as="script"),u.crossOrigin="",u.href=l,f&&u.setAttribute("nonce",f),document.head.appendChild(u),g)return new Promise((c,w)=>{u.addEventListener("load",c),u.addEventListener("error",()=>w(new Error(`Unable to preload CSS for ${l}`)))})}))}function s(o){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=o,window.dispatchEvent(r),!r.defaultPrevented)throw o}return n.then(o=>{for(const r of o||[])r.status==="rejected"&&s(r.reason);return e().catch(s)})},X=[{code:"ja",name:"Japanese · Kana",direction:"ltr"},{code:"ar",name:"Arabic",direction:"rtl"}],pe=Object.freeze(Object.defineProperty({__proto__:null,default:X},Symbol.toStringTag,{value:"Module"})),T=new p("Storage");class we{constructor(){this.isNative=!1,this.storage=this.detectStorage()}detectStorage(){if(typeof window<"u"&&typeof localStorage=="object")try{const e="__storage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),T.debug("Using native localStorage"),this.isNative=!0,localStorage}catch(e){T.warn("localStorage detected but unavailable (Safari private mode?), using memory storage",e)}else T.info("No localStorage available (Node/test environment), using memory storage");return new Map}get(e){if(this.isNative)return this.storage.getItem(e);const t=this.storage;return t.has(e)?t.get(e):null}set(e,t){this.isNative?this.storage.setItem(e,t):this.storage.set(e,t)}remove(e){this.isNative?this.storage.removeItem(e):this.storage.delete(e)}clear(){this.isNative?this.storage.clear():this.storage.clear()}}const W=new we,y=new p("Lang"),C=X,be=Object.assign({"../data/lang/index.json":()=>D(()=>Promise.resolve().then(()=>pe),void 0).then(a=>a.default),"../data/lang/ja.json":()=>D(()=>import("./ja-DEJkL8aw.js"),[]).then(a=>a.default)});class ye{constructor(){var n;const e=W.get("kanaPop.lang"),t=(n=navigator.language)==null?void 0:n.slice(0,2);this.defaultCode=e||t||"ja";let i=C.find(s=>s.code===this.defaultCode);i||(y.warn(`Default code '${this.defaultCode}' not in manifest. Falling back to first manifest entry or 'ja'.`),i=C.find(s=>s.code==="ja")||C[0]),i?this.lang={code:i.code,name:i.name,symbols:[],direction:i.direction}:(y.error("CRITICAL - Language manifest is empty or essential fallbacks are missing. App functionality will be severely impaired."),this.lang={code:this.defaultCode,name:"Error: Language Undefined",symbols:[],direction:"ltr"})}async load(e=this.defaultCode){const t=C.find(o=>o.code===e);if(!t){if(y.error(`Language code '${e}' not found in manifest. Attempting to fall back.`),e!==this.defaultCode&&C.find(r=>r.code===this.defaultCode))return y.warn(`Falling back to default language '${this.defaultCode}'.`),this.load(this.defaultCode);throw new Error(`LanguageService: Language code '${e}' (and default '${this.defaultCode}') not found in manifest.`)}if(e==="index")throw new Error("LanguageService: index.json is the manifest, not a language data file.");const i=`../data/lang/${e}.json`,n=be[i];if(!n)throw y.error(`No data file loader found for code '${e}' (path: '${i}'). Check glob pattern and file existence.`),new Error(`LanguageService: No data file loader for '${e}'.`);let s;try{s=await n()}catch(o){throw y.error(`Failed to load language data file for code '${e}' from '${i}'.`,o),new Error(`LanguageService: Failed to load data for '${e}'.`)}this.lang={symbols:s.symbols||[],code:t.code||s.code,name:t.name,direction:t.direction},s.code&&s.code!==t.code&&(y.warn(`Mismatch! Requested/Manifest code '${t.code}', but file contains code '${s.code}'. Prioritizing manifest code.`),this.lang.code=t.code),this.persistLang(this.lang.code)}get symbols(){return this.lang.symbols}get currentCode(){return this.lang.code}get direction(){return this.lang.direction}randomGlyph(e){const t=Object.values(e.glyphs);return t.length===0?(y.warn(`Symbol with roman='${e.roman}' (category: ${e.category}, lang: ${this.lang.code}) has no glyphs defined. Returning '?' as fallback.`),"?"):t[Math.floor(Math.random()*t.length)]}persistLang(e){W.set("kanaPop.lang",e)}}const m=new ye;function ve(){if(typeof navigator>"u")return!1;const a=navigator.userAgent;return/iPad|iPhone|iPod/.test(a)&&!window.MSStream}function Ae(){if(typeof navigator>"u")return!1;const a=navigator.userAgent;return/iPad/.test(a)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1}function x(){if(typeof navigator>"u")return!1;if(ve()||Ae())return!0;const a=navigator.userAgent;return!!(/iPad|iPhone|iPod/.test(a)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>0)}const v=new p("Audio");class Le{constructor(){this.bank=new Map}async ensureContext(){if(!this.ctx){const e=globalThis,t=e.AudioContext??e.webkitAudioContext;if(!t)throw new Error("Web Audio API not supported");this.ctx=new t,v.info(`Created new AudioContext: ${this.ctx.state}`)}if(this.ctx.state==="suspended"){v.info(`Attempting to resume AudioContext from ${this.ctx.state} state`);try{await this.ctx.resume(),v.info(`AudioContext resumed: ${this.ctx.state}`)}catch(e){throw v.error("Failed to resume AudioContext",e),e}}return this.ctx}async fetch(e){if(this.bank.has(e))return this.bank.get(e);try{const t=await(await fetch(e)).arrayBuffer(),n=await(await this.ensureContext()).decodeAudioData(t);return this.bank.set(e,n),n}catch(t){throw v.error(`decodeAudioData failed for ${e}`,t),t}}async play(e){const t=await this.ensureContext(),i=t.createBufferSource();i.buffer=e,i.connect(t.destination),i.start(),i.onended=()=>i.disconnect()}async resume(){try{const e=await this.ensureContext();if(x()){v.info("iOS/iPadOS detected, playing silent buffer to unlock audio");const t=e.sampleRate||44100,i=e.createBuffer(2,t*.5,t);for(let r=0;r<2;r++){const f=i.getChannelData(r);for(let l=0;l<f.length;l++)f[l]=0}const n=x()?.5:.1,s=e.createGain();s.gain.value=.001;const o=e.createBufferSource();o.buffer=i,o.connect(s),s.connect(e.destination),o.start(0),o.stop(e.currentTime+n),o.onended=()=>{o.disconnect(),s.disconnect()},v.info(`Silent buffer played (duration: ${n}s)`)}return e}catch(e){throw v.error("Resume failed",e),e}}}const h=new p("Sound"),F=class F{constructor(){this.bank=new Le,this.isGestureArmed=!1,this.ready=new Promise(e=>this.triggerReady=e)}async armFirstGesture(e=window){if(this.isGestureArmed)return;this.isGestureArmed=!0,h.info("First gesture handler armed");const t=x(),i=[],n=(r,f)=>{r.addEventListener(f,o,{passive:!0}),i.push({target:r,type:f})},s=()=>{h.info("Cleaning up audio unlock event listeners"),i.forEach(({target:r,type:f})=>{r.removeEventListener(f,o)})},o=async()=>{h.info("User gesture detected, unlocking audio");let r=!1;try{await this.bank.resume(),h.info("Audio context unlocked successfully"),r=!0}catch(f){h.warn("AudioContext unlock failed, trying HTML Audio fallback",f);try{const l=new Audio(F.SILENT);l.autoplay=!0,l.muted=!1,l.volume=.001,l.setAttribute("playsinline",""),h.info("Playing fallback HTML audio");const g=l.play();if(g instanceof Promise){await g,h.info("Fallback audio played successfully");try{await this.bank.resume(),h.info("Audio context unlocked after HTML audio fallback"),r=!0}catch(d){h.warn("Audio context still locked after HTML audio fallback",d)}}else h.warn("Fallback audio play() returned no promise")}catch(l){h.error("All audio unlock attempts failed",l)}}this.triggerReady(),r||!t?s():h.warn("Audio unlock not confirmed. Keeping event listeners for another attempt.")};h.info("Registering audio unlock gesture handlers"),n(e,"pointerdown"),n(e,"touchstart"),n(e,"click"),t&&(h.info("Adding extra handlers for iOS/iPadOS"),n(document.body,"pointerdown"),n(document.body,"touchstart"),n(document.body,"click"),n(document,"pointerdown"),n(document,"touchstart"),n(document,"click"),n(window,"pointerdown"),n(window,"touchstart"),n(window,"click"))}async play(e){if(await this.ready,e.endsWith("fallback.mp3"))return;const t=H(`/kana-pop/audio/${e}`);try{const i=await this.bank.fetch(t);await this.bank.play(i)}catch(i){h.warn(`Web Audio playback failed for ${t}, using HTMLAudioElement fallback`,i),new Audio(t).play().catch(n=>{h.error(`HTMLAudioElement fallback also failed for ${t}`,n)})}}playRoman(e){var i;const t=(i=m.symbols.find(n=>n.roman===e))==null?void 0:i.audio;t&&this.play(`${m.currentCode}/${t}`)}async preloadAll(e){await this.ready,h.info(`Preloading ${e.length} audio files`),await Promise.all(e.map(t=>{if(t.endsWith("fallback.mp3"))return Promise.resolve();const i=H(`/kana-pop/audio/${t}`);return this.bank.fetch(i).catch(n=>{h.warn(`Failed to preload audio: ${t}`,n)})})),h.info("Audio preloading complete")}};F.SILENT="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAIlYAACJWAAABAAgAZGF0YQAAAAA=";let N=F;const I=new N;function H(a){return a.startsWith("data:")?a:`${a}?v=mbj0scxc`}class ke{constructor(e,t,i,n=.2,s=1){this.x=e,this.y=t,this.text=i,this.speed=n,this.ttl=s}step(e){this.ttl-=e,this.y-=this.speed*e}draw(e){if(this.ttl<=0)return;const{w:t,h:i}=k(e.canvas),n=B();e.save(),e.globalAlpha=Math.max(0,this.ttl),e.fillStyle=K,e.font=`${Math.round(n*.7)}px ${Q}`,e.textAlign="center",e.textBaseline="middle",e.fillText(this.text,this.x*t,this.y*i),e.restore()}}const S=new p("Play");let E=0,O=0;const Ce=a=>Math.floor(Math.random()*a),Se=()=>P.length===0?"#FFFFFF":P[Math.floor(Math.random()*P.length)]??"#FFFFFF";function Ee(a){let e=[],t=a.canvas.clientWidth,i=a.canvas.clientHeight,n=0;const s=new fe,o=new he;let r=[],f=!1;const l=()=>{const{w:d,h:u}=k(a.canvas);if(t===0||i===0){t=d,i=u;return}const c=d/t,w=u/i;if(!Number.isFinite(c)||c===0||!Number.isFinite(w)||w===0){t=d,i=u;return}t=d,i=u},g=d=>{const u=a.canvas.getBoundingClientRect(),c=d.clientX-u.left,w=d.clientY-u.top,{w:R,h:Z}=k(a.canvas);for(let M=e.length-1;M>=0;M--){const b=e[M];if(b&&b.contains(c,w,R,Z)){b.pop(),I.playRoman(b.romaji),r.push(new ke(b.x,b.y,b.romaji,b.speed));break}}};return{update(d){if(!f)return;Y(a);const u=d;if(d=Math.min(u,.1),E+=u,O++,E>=1){const c=Math.round(O/E);p.isDebug&&S.debug("fps",c),E=0,O=0}if(n-=d,n<=0&&m.symbols&&m.symbols.length>0){const c=m.symbols[Ce(m.symbols.length)],w=m.randomGlyph(c),R=new ue(Math.random(),1,Se(),w,c.roman);e.push(R),S.debug("spawned bubble",e.length),n=ae}e.some(c=>!c.active)&&(e=e.filter(c=>c.active)),r.some(c=>c.ttl<=0)&&(r=r.filter(c=>c.ttl>0)),o.update(d),e.forEach(c=>c.step(d)),r.forEach(c=>c.step(d)),o.draw(a),e.forEach(c=>s.render(a,c)),r.forEach(c=>c.draw(a))},async enter(){S.info("Play screen entered"),await m.load("ja"),I.preloadAll(m.symbols.map(d=>`${m.currentCode}/${d.audio}`)).catch(d=>S.warn("audio preload",d)),f=!0,L.subscribe(l),l(),a.canvas.addEventListener("pointerdown",g)},exit(){S.info("Play screen exited"),L.unsubscribe(l),a.canvas.removeEventListener("pointerdown",g),e=[],r=[]}}}const J=document.querySelector("#game"),U=J.getContext("2d");I.armFirstGesture(window);L.watchCanvas(J);const $=new ce;$.add("menu",de($,U)).add("play",Ee(U));$.change("menu");let z=performance.now();function V(a){const e=(a-z)/1e3;z=a,$.update(e),requestAnimationFrame(V)}requestAnimationFrame(V);
