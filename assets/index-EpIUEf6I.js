(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();function w(o){const{clientWidth:t,clientHeight:e}=o;return{w:t,h:e}}function Ct(){return window.devicePixelRatio||1}function rt(o){const t=Ct();o.setTransform(1,0,0,1,0,0),o.scale(t,t)}function Dt(o){const t=Ct(),{w:e,h:s}=w(o);return o.width=Math.round(e*t),o.height=Math.round(s*t),{w:e,h:s,dpr:t}}class jt{constructor(){this.listeners=new Set,this.watchedCanvases=new Map,this.mediaQuery=null,this.boundTrigger=this.trigger.bind(this),this.dprCallback=null,this.metrics={w:0,h:0,dpr:1}}subscribe(t){this.listeners.add(t),t(),this.listeners.size===1&&this.attachWindowListeners()}unsubscribe(t){this.listeners.delete(t),this.listeners.size===0&&this.detachWindowListeners()}watchCanvas(t){const e=()=>{const s=Dt(t);this.metrics=s};this.watchedCanvases.set(t,e),this.subscribe(e)}unwatchCanvas(t){const e=this.watchedCanvases.get(t);e&&(this.unsubscribe(e),this.watchedCanvases.delete(t))}trigger(){this.listeners.forEach(t=>t())}attachWindowListeners(){typeof window<"u"&&(window.addEventListener("resize",this.boundTrigger),this.addDprListener())}detachWindowListeners(){var t;typeof window<"u"&&window.removeEventListener("resize",this.boundTrigger),this.dprCallback&&((t=this.mediaQuery)==null||t.removeEventListener("change",this.dprCallback)),this.mediaQuery=null,this.dprCallback=null}addDprListener(){var t;typeof window>"u"||typeof window.matchMedia>"u"||(this.dprCallback&&((t=this.mediaQuery)==null||t.removeEventListener("change",this.dprCallback)),this.mediaQuery=matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`),this.dprCallback=()=>{this.boundTrigger(),this.addDprListener()},this.mediaQuery.addEventListener("change",this.dprCallback,{once:!0}))}get cssWidth(){return this.metrics.w}get cssHeight(){return this.metrics.h}get dpr(){return this.metrics.dpr}}const _=new jt,Ht="/kana-pop/assets/background-D-U8xQFM.png",Ft="/kana-pop/assets/background1-Bjf-n90B.png",zt="/kana-pop/assets/background-D-U8xQFM.png",Nt="/kana-pop/assets/background_vertical-3wb079fu.png",Ut="data:application/json;base64,WyIjRkZEMURDIiwgIiNCNUVBRDciLCAiI0M3Q0VFQSIsICIjRkZEQUMxIiwgIiNFMkYwQ0IiXQo=",Wt="data:application/json;base64,ewogICJuYW1lIjogIlBhc3RlbCBQb25kIiwKICAiYXNzZXRzIjogeyAicGFsZXR0ZSI6ICJwYWxldHRlLmpzb24iIH0sCiAgImVmZmVjdCI6IHsKICAgICJ0eXBlIjogImltYWdlIiwKICAgICJob3Jpem9udGFsIjogImJhY2tncm91bmRfaG9yaXpvbnRhbC5wbmciLAogICAgInZlcnRpY2FsIjogImJhY2tncm91bmRfdmVydGljYWwucG5nIgogIH0KfQo=",Pt="Pastel Pond",Lt={palette:"palette.json"},_t={type:"image",horizontal:"background_horizontal.png",vertical:"background_vertical.png"},Vt={name:Pt,assets:Lt,effect:_t},Gt=Object.freeze(Object.defineProperty({__proto__:null,assets:Lt,default:Vt,effect:_t,name:Pt},Symbol.toStringTag,{value:"Module"})),Yt=["#FFD1DC","#B5EAD7","#C7CEEA","#FFDAC1","#E2F0CB"],Xt=Object.freeze(Object.defineProperty({__proto__:null,default:Yt},Symbol.toStringTag,{value:"Module"})),Qt=2,qt=.11,Y=3,Jt=5,Kt=5,Zt=1,te=.14,ee=.4,se=.36,ie=["#ffaaa5","#ffd3b6","#c7ceea","#e2f0cb","#b5ead7"];let It=null;function ne(o){o&&o.length>0&&(It=o)}function $t(){return It??ie}const V="#222",ae="Noto Sans JP, sans-serif",re=V,Mt=.11,oe=.85,ce=.65,le=.2,X=50,ut=.08,ft=.1,pt=.14,j=.85,Q=1.2,gt=0,mt=.15,he=.6,q=4,de="__kanaPopDebug_",ue=40,fe=60,pe=250,ge=!0,bt="sfx/Pop/",H=["pop1.mp3","pop2.mp3","pop3.mp3","pop4.mp3","pop5.mp3"],me={debug:V,info:"#2b90d9",warn:"#f6a800",error:"#e54242"},be=typeof window<"u"&&window.location.search.includes("debug"),E=class E{constructor(t,e=E.bootLevel){this.scope=t,this.level=e}out(t,...e){if(!be||this.level==="off"||E.levelOrder[t]<E.levelOrder[this.level])return;const s=new Date().toISOString().split("T"),i=s.length>1&&s[1]?s[1].slice(0,8):"00:00:00";console.log(`%c${i} %c${this.scope} %c${t.toUpperCase()}`,"color:#999;font-size:0.8em","color:#fff;background:#555;padding:0 4px;border-radius:2px",`color:${me[t]};font-weight:bold`,...e)}debug(...t){this.out("debug",...t)}info(...t){this.out("info",...t)}warn(...t){this.out("warn",...t)}error(...t){this.out("error",...t)}};E.bootLevel=(()=>{if(typeof globalThis>"u"||!("localStorage"in globalThis))return"info";const t=localStorage.getItem("logLevel");return t&&["debug","info","warn","error","off"].includes(t)?t:"info"})(),E.isDebug=E.bootLevel==="debug",E.levelOrder={debug:0,info:1,warn:2,error:3,off:4};let m=E;function ye(){return{setLevel(o){localStorage.setItem("logLevel",o),location.reload()}}}typeof window<"u"&&(window.logger=ye());const T=class T{constructor(t){this.ready=!1,this.imgHorizontal=null,this.imgVertical=null,this.loadedHorizontal=!1,this.loadedVertical=!1,typeof window<"u"?(this.imgHorizontal=new Image,this.imgHorizontal.onload=()=>{var e;T.log.debug(`Loaded horizontal image: ${(e=this.imgHorizontal)==null?void 0:e.src}`),this.loadedHorizontal=!0,this.updateReadyState()},this.imgHorizontal.onerror=()=>{var e;this.loadedHorizontal=!1,T.log.error(`Failed to load horizontal image: ${(e=this.imgHorizontal)==null?void 0:e.src}`),this.updateReadyState()},this.imgHorizontal.src=t.horizontal,this.imgVertical=new Image,this.imgVertical.onload=()=>{var e;T.log.debug(`Loaded vertical image: ${(e=this.imgVertical)==null?void 0:e.src}`),this.loadedVertical=!0,this.updateReadyState()},this.imgVertical.onerror=()=>{var e;this.loadedVertical=!1,T.log.error(`Failed to load vertical image: ${(e=this.imgVertical)==null?void 0:e.src}`),this.updateReadyState()},this.imgVertical.src=t.vertical):this.ready=!0}resize(){}updateReadyState(){this.ready=this.loadedHorizontal||this.loadedVertical}update(t,e){if(!this.ready)return!1;const s=e.canvas.width,i=e.canvas.height,n=s/i;let a=null;if(n>=1?a=this.loadedHorizontal?this.imgHorizontal:this.imgVertical:a=this.loadedVertical?this.imgVertical:this.imgHorizontal,!a||!a.complete||a.naturalWidth===0)return!1;const r=a.naturalWidth/a.naturalHeight;let c,l,f=0,u=0;return r>n?(l=i,c=l*r,f=(s-c)/2):(c=s,l=c/r,u=(i-l)/2),e.drawImage(a,f,u,c,l),!0}};T.log=new m("ImageEffect");let tt=T;class we{constructor(t){this.vid=null,typeof document<"u"&&typeof window<"u"&&(this.vid=document.createElement("video"),this.vid.src=t,this.vid.autoplay=!0,this.vid.loop=!0,this.vid.muted=!0,this.vid.style.position="fixed",this.vid.style.top="0",this.vid.style.left="0",this.vid.style.width="100%",this.vid.style.height="100%",this.vid.style.objectFit="cover",this.vid.style.zIndex="-1",document.body.appendChild(this.vid))}resize(){}update(t,e){return!1}dispose(){this.vid&&this.vid.parentNode&&(this.vid.parentNode.removeChild(this.vid),this.vid=null)}}const P=new m("ShaderEffect");class ve{constructor(t){this.container=null,this.shaderConfig=t,P.debug(`ShaderEffect created with config: ${this.shaderConfig}`)}mount(t){this.container=t;const e=document.createElement("div");e.style.width="100%",e.style.height="100%",e.style.backgroundColor="rgba(50, 0, 50, 0.8)",e.textContent=`Shader Effect: ${this.shaderConfig}`,e.style.color="white",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",this.container.appendChild(e),P.debug("ShaderEffect mounted. Config:",this.shaderConfig)}unmount(){if(this.container){for(;this.container.firstChild;)this.container.removeChild(this.container.firstChild);P.debug("ShaderEffect unmounted.")}this.container=null}resize(t,e,s){P.debug(`ShaderEffect resize called: ${t}x${e} @ ${s}x`)}update(t,e){return P.debug(`ShaderEffect update called with dt: ${t}`),!1}}class xe{constructor(t){this.cls=t,document.body.classList.add(t)}resize(){}update(){return!1}dispose(){document.body.classList.remove(this.cls)}}const yt=Object.assign({"../assets/themes/pastel-pond/background.png":Ht,"../assets/themes/pastel-pond/background1.png":Ft,"../assets/themes/pastel-pond/background_horizontal.png":zt,"../assets/themes/pastel-pond/background_vertical.png":Nt,"../assets/themes/pastel-pond/palette.json":Ut,"../assets/themes/pastel-pond/theme.json":Wt}),wt=Object.assign({"../assets/themes/pastel-pond/theme.json":Gt}),Se=Object.assign({"../assets/themes/pastel-pond/palette.json":Xt});class Ee{async load(t){const e=`../${t.endsWith("/")?t:t+"/"}theme.json`.replace(/^\.\.\/\/+/,"../"),s=wt[e];if(!s)throw new Error(`Theme manifest not embedded for base '${t}'. Tried key '${e}'. Available MANIFESTS keys: ${Object.keys(wt).join(", ")}`);const i=s.assets.palette.startsWith("/")?s.assets.palette.substring(1):s.assets.palette,n=`../${t.endsWith("/")?t:t+"/"}${i}`.replace(/^\.\.\/\/+/,"../"),a=Se[n]??["#ffffff"],r=await this.makeEffect(s.effect,t);return this.current={name:s.name,palette:a,effect:r},ne(a),this.current}get theme(){return this.current}async makeEffect(t,e){const s=e.replace(/^assets\/themes\//,"").replace(/\/$/,"");function i(n){const a=`../assets/themes/${s}/${n}`,r=yt[a];if(r===void 0)throw console.error(`[ThemeService] Asset URL not found for key: ${a}`),console.error("[ThemeService] Attempted to load file:",n,"from theme folder:",s),console.error("[ThemeService] Available keys from glob:",Object.keys(yt)),new Error(`Asset URL not found by viteAssetUrl: ${a}. Check theme.json and asset paths.`);return r}if(t.type==="image"){const n=i(t.horizontal),a=i(t.vertical);return new tt({horizontal:n,vertical:a})}else if(t.type==="video"){const n=i(t.file);return new we(n)}else if(t.type==="script")try{const r=(await import(`/src/assets/themes/${s}/${t.file}`))[t.export];if(typeof r=="function")return new r(e);throw new Error(`Export "${t.export}" from script "${t.file}" is not a constructor.`)}catch(n){throw console.error(`Failed to load script effect "${t.file}":`,n),n}else{if(t.type==="shader")return new ve(t.shader);if(t.type==="css")return new xe(t.class);{const n=t;throw new Error(`ThemeService: unknown effect type: ${JSON.stringify(n)}`)}}}}const et=new Ee;class ke{constructor(t){this.canvas=t,this.time=0;const e=t.getContext("2d");if(!e)throw new Error("2-D context not available");this.ctx=e,_.watchCanvas(t),_.subscribe(()=>this.paint(0))}paint(t){var i,n,a;this.time+=t,rt(this.ctx);const e=window.devicePixelRatio||1;if(this.ctx.save(),this.ctx.scale(1/e,1/e),!((n=(i=et.theme)==null?void 0:i.effect)==null?void 0:n.update(t,this.ctx))){const{w:r,h:c}=w(this.canvas);this.ctx.fillStyle=((a=et.theme)==null?void 0:a.palette[2])??"#c7ceea",this.ctx.fillRect(0,0,r,c)}this.ctx.restore()}}const Ae=new m("SM");class Te{constructor(){this.states=new Map,this.stack=[]}add(t,e){return this.states.set(t,e),this}async change(t){var e,s;Ae.info("→ change",{from:this.currentName,to:t}),(e=this.current)!=null&&e.exit&&this.current.exit(),this.current=this.states.get(t),this.currentName=t,(s=this.current)!=null&&s.enter&&await this.current.enter()}update(t){var e,s;(s=(e=this.current)==null?void 0:e.update)==null||s.call(e,t)}get currentStateName(){return this.currentName}async push(t){var e;this.current&&(this.stack.push(this.current),this.current.exit&&this.current.exit()),this.current=this.states.get(t),this.currentName=t,(e=this.current)!=null&&e.enter&&await this.current.enter()}async pop(){var t,e,s;this.stack.length&&((t=this.current)!=null&&t.exit&&this.current.exit(),this.current=this.stack.pop(),this.currentName=this.current?(e=[...this.states.entries()].find(([,i])=>i===this.current))==null?void 0:e[0]:void 0,(s=this.current)!=null&&s.enter&&await this.current.enter())}}class Rt{constructor(t,e){this.resizeHandler=this.paint.bind(this),this.sm=t,this.ctx=e}async enter(){_.subscribe(this.resizeHandler),this.paint()}update(t){}exit(){_.unsubscribe(this.resizeHandler)}clear(){const{w:t,h:e}=w(this.ctx.canvas);return this.ctx.clearRect(0,0,t,e),rt(this.ctx),{w:t,h:e}}}const Ce={pop:50,error:[50,100,50],success:[50,50,50,50,100],gameOver:[100,50,100,50,300]},J=new m("Storage");class Pe{constructor(){this.isNative=!1,this.storage=this.detectStorage()}detectStorage(){if(typeof window<"u"&&typeof localStorage=="object")try{const t="__storage_test__";return localStorage.setItem(t,t),localStorage.removeItem(t),J.debug("Using native localStorage"),this.isNative=!0,localStorage}catch(t){J.warn("localStorage detected but unavailable (Safari private mode?), using memory storage",t)}else J.info("No localStorage available (Node/test environment), using memory storage");return new Map}get(t){if(this.isNative)return this.storage.getItem(t);const e=this.storage;return e.has(t)?e.get(t):null}set(t,e){this.isNative?this.storage.setItem(t,e):this.storage.set(t,e)}remove(t){this.isNative?this.storage.removeItem(t):this.storage.delete(t)}clear(){this.isNative?this.storage.clear():this.storage.clear()}}const I=new Pe,S=new m("Haptics");class Le{constructor(){if(this.enabled=I.get("kanaPop.haptics")!=="false"&&ge,this.debugElement=null,this.lastVibration=0,this.patternArraysOkay=null,!(typeof window>"u"||typeof navigator>"u")){if(window.matchMedia("(prefers-reduced-motion: reduce)").matches){S.info("Haptics disabled due to reduced-motion preference.");return}if(typeof navigator.vibrate=="function"){this.enabled=!0,S.info("Haptic feedback enabled.");const t=()=>{this.updateDebugStatus("Activation gesture received (resume only)")};window.addEventListener("pointerdown",t,{once:!0,passive:!0})}else S.info("Haptic feedback not supported on this device.")}}async vibrate(t=50,e=2){if(!this.enabled)return Promise.resolve(!1);if(this.patternArraysOkay===null)try{navigator.vibrate([1,1])?(navigator.vibrate(0),this.patternArraysOkay=!0,this.updateDebugStatus("Array patterns seem supported.")):(this.patternArraysOkay=!1,this.updateDebugStatus("Array patterns rejected (vibrate returned false)."))}catch(r){this.patternArraysOkay=!1,this.updateDebugStatus(`Array patterns rejected (vibrate threw error: ${r instanceof Error?r.message:String(r)}).`)}const s=Date.now(),i=Array.isArray(t),n=i?pe:fe;if(s-this.lastVibration<n)return this.updateDebugStatus(`Throttled (gap: ${n}ms)`),Promise.resolve(!1);let a;if(i)a=t.map(r=>Math.max(r,X)),!this.patternArraysOkay&&a.length>0&&(a=Math.max(...a,X),this.updateDebugStatus("Collapsed array to single max pulse for compatibility."));else{const r=Math.max(t,X),c=ue;switch(e){case 1:a=r;break;case 2:a=Math.min(r*1.5,150);break;case 3:a=this.patternArraysOkay?[r,c,r]:r*2;break;default:return S.warn(`Invalid intensity: ${e} for numeric pattern.`),Promise.resolve(!1)}}try{return Array.isArray(a)&&a.length===0?(S.warn("Attempted to vibrate with an empty pattern array."),Promise.resolve(!1)):typeof a=="number"&&a===0&&t!==0?(S.warn("Calculated vibration duration is zero, skipping."),Promise.resolve(!1)):navigator.vibrate(a)?(this.lastVibration=s,this.updateDebugStatus(`Vibrated: ${JSON.stringify(a)}`),S.info("Vibrating with:",{originalPattern:t,intensity:e,actualVibration:a}),Promise.resolve(!0)):(this.updateDebugStatus("navigator.vibrate() returned false."),S.warn("navigator.vibrate() returned false for pattern:",a),Promise.resolve(!1))}catch(r){return S.warn("Vibration failed with error:",r),this.updateDebugStatus(`Failed: ${r instanceof Error?r.message:String(r)}`),Array.isArray(a)&&this.patternArraysOkay&&(this.patternArraysOkay=!1,this.updateDebugStatus("Error with array vibration, marked arrays as not okay for future.")),Promise.resolve(!1)}}isSupported(){return this.enabled}createDebugElement(){var e;if(typeof document>"u")return;const t=`${de}Haptics`;(e=document.getElementById(t))==null||e.remove(),this.debugElement=document.createElement("div"),this.debugElement.id=t,this.debugElement.style.position="fixed",this.debugElement.style.bottom="30px",this.debugElement.style.left="10px",this.debugElement.style.background="rgba(0,0,0,0.5)",this.debugElement.style.color="white",this.debugElement.style.padding="5px",this.debugElement.style.fontSize="12px",this.debugElement.style.zIndex="9999",this.debugElement.style.pointerEvents="none",document.body.appendChild(this.debugElement)}updateDebugStatus(t){this.debugElement&&(this.debugElement.textContent=`Haptics: ${t}`)}vibratePattern(t){const e=Ce[t];return typeof e=="number"?this.vibrate(e):this.vibrate([...e])}setEnabled(t){this.enabled=t,I.set("kanaPop.haptics",String(t)),t||navigator.vibrate(0)}isEnabled(){return this.enabled}}const N=new Le;class _e{constructor(t){this.onClose=t,this.overlay=document.createElement("div"),this.overlay.style.cssText=`
      position:fixed;inset:0;background:rgba(0,0,0,.6);
      color:${V};display:flex;flex-direction:column;
      align-items:center;justify-content:center;
      font:18px sans-serif;z-index:50`,this.overlay.innerHTML=`
      <h2 style="margin:0 0 20px">Settings</h2>
      <label style="margin-bottom:15px;display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="hapticsToggle">
        Haptics
      </label>
      <button id="close">Close</button>`,this.overlay.querySelector("#close").addEventListener("click",()=>this.toggle());const e=this.overlay.querySelector("#hapticsToggle");e.addEventListener("change",()=>{N.setEnabled(e.checked)})}toggle(){document.body.contains(this.overlay)?this.hide():this.show()}show(){document.body.appendChild(this.overlay);const t=this.overlay.querySelector("#hapticsToggle");t.checked=N.isEnabled()}hide(){this.overlay.remove(),this.onClose()}}class Ie extends Rt{constructor(){super(...arguments),this.settings=new _e(()=>{}),this.enter=async()=>{document.body.dataset.scene="home",await super.enter(),window.addEventListener("pointerdown",this.onTap)},this.exit=()=>{window.removeEventListener("pointerdown",this.onTap),this.settings.hide(),delete document.body.dataset.scene,super.exit()},this.onTap=t=>{const{w:e,h:s}=w(this.ctx.canvas),{offsetX:i,offsetY:n}=t;i>e-60&&n>s-60?this.settings.toggle():this.sm.change("play")}}paint(){const{w:t,h:e}=this.clear();this.ctx.fillStyle=V,this.ctx.textAlign="center",this.ctx.font="32px sans-serif",this.ctx.fillText("Tap to Start",t/2,e/2),this.ctx.font="20px sans-serif",this.ctx.fillText("⚙︎",t-30,e-30)}}function $e(){if(typeof navigator>"u")return!1;const o=typeof navigator>"u"?"":navigator.userAgent;return/iPad|iPhone|iPod/.test(o)&&!(typeof window<"u"&&window.MSStream)}function Me(){if(typeof navigator>"u")return!1;const o=typeof navigator>"u"?"":navigator.userAgent;return/iPad/.test(o)||typeof navigator<"u"&&navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1}function st(){if(typeof navigator>"u")return!1;if($e()||Me())return!0;const o=typeof navigator>"u"?"":navigator.userAgent;return!!(/iPad|iPhone|iPod/.test(o)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>0)}const k=new m("Audio");class Re{constructor(){this.bank=new Map}async ensureContext(){const t=()=>{const e=globalThis,s=e.AudioContext??e.webkitAudioContext;if(!s)throw new Error("Web Audio API not supported");const i=new s;return k.info(`Created new AudioContext: ${i.state}`),i};if((!this.ctx||this.ctx.state==="closed")&&(this.ctx=t()),this.ctx.state==="suspended"||this.ctx.state==="interrupted"){k.info(`Attempting resume() from ${this.ctx.state}`);try{await this.ctx.resume()}catch(e){k.warn("resume() threw",e)}}if(this.ctx.state!=="running"){k.warn(`AudioContext stuck in '${this.ctx.state}', recreating…`);try{await this.ctx.close()}catch{}this.ctx=t(),await this.ctx.resume()}return this.ctx}async fetch(t){var e;if(this.bank.has(t))return this.bank.get(t);try{const s=await fetch(t,{cache:"force-cache"});if(!s.ok)throw new Error(`HTTP ${s.status} ${s.statusText}`);const i=((e=s.headers.get("content-type"))==null?void 0:e.toLowerCase())??"";if(!i.startsWith("audio/"))throw new Error(`Non-audio response (${i||"no Content-Type"})`);const n=await s.arrayBuffer(),r=await(await this.ensureContext()).decodeAudioData(n);return this.bank.set(t,r),r}catch(s){throw k.error(`AudioBufferBank.fetch failed for ${t}`,s),s}}async play(t){const e=await this.ensureContext(),s=e.createBufferSource();s.buffer=t,s.connect(e.destination),s.start(),s.onended=()=>s.disconnect()}async resume(){try{const t=await this.ensureContext();if(st()){k.info("iOS/iPadOS detected, playing silent buffer to unlock audio");const e=t.sampleRate||44100,s=t.createBuffer(2,e*.5,e);for(let r=0;r<2;r++){const c=s.getChannelData(r);for(let l=0;l<c.length;l++)c[l]=0}const i=st()?.5:.1,n=t.createGain();n.gain.value=.001;const a=t.createBufferSource();a.buffer=s,a.connect(n),n.connect(t.destination),a.start(0),a.stop(t.currentTime+i),a.onended=()=>{a.disconnect(),n.disconnect()},k.info(`Silent buffer played (duration: ${i}s)`)}return t}catch(t){throw k.error("Resume failed",t),t}}}class Be{constructor(){this.tasks=[]}add(t){this.tasks.push(t)}async run(t,e=!0){if(this.tasks.length===0){t(1);return}if(e){let s=0;await Promise.all(this.tasks.map(i=>i().then(()=>{t(++s/this.tasks.length)})))}else for(let s=0;s<this.tasks.length;s++){const i=this.tasks[s];await i(),t((s+1)/this.tasks.length)}this.tasks=[]}}const ot=new Be,Oe="modulepreload",De=function(o){return"/kana-pop/"+o},vt={},xt=function(t,e,s){let i=Promise.resolve();if(e&&e.length>0){let a=function(l){return Promise.all(l.map(f=>Promise.resolve(f).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),c=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));i=a(e.map(l=>{if(l=De(l),l in vt)return;vt[l]=!0;const f=l.endsWith(".css"),u=f?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${u}`))return;const p=document.createElement("link");if(p.rel=f?"stylesheet":Oe,f||(p.as="script"),p.crossOrigin="",p.href=l,c&&p.setAttribute("nonce",c),document.head.appendChild(p),f)return new Promise((v,h)=>{p.addEventListener("load",v),p.addEventListener("error",()=>h(new Error(`Unable to preload CSS for ${l}`)))})}))}function n(a){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=a,window.dispatchEvent(r),!r.defaultPrevented)throw a}return i.then(a=>{for(const r of a||[])r.status==="rejected"&&n(r.reason);return t().catch(n)})},A=class A{static async manifest(){if(!this.manifestPromise){if(!A.loadManifest)throw new Error("Manifest loader not found. Check glob pattern and file existence.");this.manifestPromise=A.loadManifest()}return this.manifestPromise}static async language(t){const e=`../data/lang/${t}.json`,s=A.langFiles[e];if(!s)throw new Error(`No language data file for '${t}'`);return s()}};A.manifestPromise=null,A.langFiles=Object.assign({"../data/lang/ja.json":()=>xt(()=>import("./ja-DEJkL8aw.js"),[]).then(t=>t.default)}),A.loadManifest=Object.assign({"../data/lang/index.json":()=>xt(()=>import("./index-BJLXKDTG.js"),[]).then(t=>t.default)})["../data/lang/index.json"];let U=A;const L=new m("Lang");class je{constructor(){var s;const t=I.get("kanaPop.lang"),e=typeof navigator<"u"?(s=navigator.language)==null?void 0:s.slice(0,2):void 0;this.defaultCode=t||e||"ja",this.lang={code:this.defaultCode,name:"loading…",symbols:[],direction:"ltr"},this.initialLoadPromise=new Promise(i=>{this.initialLoadResolve=i}),ot.add(async()=>{L.info(`LanguageService: Starting initial load for language code '${this.defaultCode}'...`),await this.load(this.defaultCode),L.info("LanguageService: Initial load completed.")})}async load(t=this.defaultCode){const e=await U.manifest();let s=e.find(a=>a.code===t);if(s||(L.warn(`Language code '${t}' not found in manifest; falling back to '${this.defaultCode}'.`),s=e.find(a=>a.code===this.defaultCode)??e[0]),!s)throw new Error("LanguageService: manifest empty");const i=await U.language(s.code);s.direction||L.warn(`'${s.code}' lacks "direction"; defaulting to 'ltr'`);const n=s.direction??"ltr";this.lang={code:s.code,name:s.name,symbols:i.symbols??[],direction:n},this.persistLang(this.lang.code),this.initialLoadResolve&&this.initialLoadResolve()}get symbols(){return this.lang.symbols}get currentCode(){return this.lang.code}get direction(){return this.lang.direction}randomGlyph(t){const e=Object.values(t.glyphs);return e.length===0?(L.warn(`Symbol with roman='${t.roman}' (category: ${t.category}, lang: ${this.lang.code}) has no glyphs defined. Returning '?' as fallback.`),"?"):e[Math.floor(Math.random()*e.length)]}persistLang(t){I.set("kanaPop.lang",t)}ready(){return this.initialLoadPromise}}const g=new je,d=new m("Sound"),W=class W{constructor(){this.bank=new Re,this.isGestureArmed=!1,this.assetLoadCompletedPromise=new Promise(t=>{this.assetLoadCompletedResolve=t}),ot.add(async()=>{d.info("SoundService: Waiting for LanguageService to be ready..."),await g.ready(),d.info("SoundService: LanguageService is ready. Starting sound preload...");const t=g.symbols.map(i=>`${g.currentCode}/${i.audio}`),e=H.map(i=>`${bt}${i}`),s=[...t,...e];if(s.length>0)try{await this.preloadAll(s),d.info(`SoundService: Successfully preloaded ${s.length} sounds for language '${g.currentCode}'.`)}catch(i){d.error("SoundService: Error during sound preloading.",i)}else d.info(`SoundService: No sounds to preload for language '${g.currentCode}'.`);this.assetLoadCompletedResolve()}),this.ready=new Promise(t=>this.triggerReady=t),typeof document<"u"&&document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&(d.debug("Page became visible – poking AudioContext"),this.bank.ensureContext().catch(()=>{}))})}async armFirstGesture(t=window){if(this.isGestureArmed)return;this.isGestureArmed=!0,d.info("First gesture handler armed");const e=st(),s=[],i=(r,c)=>{r.addEventListener(c,a,{passive:!0}),s.push({target:r,type:c})},n=()=>{d.info("Trimming audio unlock listeners (keeping one for re-unlock)");let r=!1;s.forEach(({target:c,type:l})=>{if(!r&&c===window&&l==="pointerdown"){r=!0;return}c.removeEventListener(l,a)})},a=async()=>{d.info("User gesture detected, unlocking audio");let r=!1;try{await this.bank.resume(),d.info("Audio context unlocked successfully"),r=!0}catch(c){d.warn("AudioContext unlock failed, trying HTML Audio fallback",c);try{const l=new Audio(W.SILENT);l.autoplay=!0,l.muted=!1,l.volume=.001,l.setAttribute("playsinline",""),d.info("Playing fallback HTML audio");const f=l.play();if(f instanceof Promise){await f,d.info("Fallback audio played successfully");try{await this.bank.resume(),d.info("Audio context unlocked after HTML audio fallback"),r=!0}catch(u){d.warn("Audio context still locked after HTML audio fallback",u)}}else d.warn("Fallback audio play() returned no promise")}catch(l){d.error("All audio unlock attempts failed",l)}}this.triggerReady(),r?n():d.warn("Audio still locked – listeners stay armed for another try")};d.info("Registering audio unlock gesture handlers"),i(t,"pointerdown"),i(t,"touchstart"),i(t,"click"),e&&(d.info("Adding extra handlers for iOS/iPadOS"),i(document.body,"pointerdown"),i(document.body,"touchstart"),i(document.body,"click"),i(document,"pointerdown"),i(document,"touchstart"),i(document,"click"),i(window,"pointerdown"),i(window,"touchstart"),i(window,"click"))}async play(t){if(await this.ready,t.endsWith("fallback.mp3"))return;const e=St(`/kana-pop/audio/${t}`);try{const s=await this.bank.fetch(e);await this.bank.play(s)}catch(s){d.warn(`Web Audio playback failed for ${e}, using HTMLAudioElement fallback`,s),new Audio(e).play().catch(i=>{d.error(`HTMLAudioElement fallback also failed for ${e}`,i)})}}playRoman(t){var s;const e=(s=g.symbols.find(i=>i.roman===t))==null?void 0:s.audio;e&&this.play(`${g.currentCode}/${e}`)}playPop(){const t=H[Math.floor(Math.random()*H.length)]??H[0];this.play(`${bt}${t}`)}async preloadAll(t){await this.ready,d.info(`Preloading ${t.length} audio files`),await Promise.all(t.map(e=>{if(e.endsWith("fallback.mp3"))return Promise.resolve();const s=St(`/kana-pop/audio/${e}`);return this.bank.fetch(s).catch(i=>{d.warn(`Failed to preload audio: ${e}`,i)})})),d.info("Audio preloading complete")}assetsReady(){return this.assetLoadCompletedPromise}};W.SILENT="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAIlYAACJWAAABAAgAZGF0YQAAAAA=";let it=W;const $=new it;function St(o){return o.startsWith("data:")?o:`${o}?v=mbvgyjzh`}const Et=new m("Bubble");class Bt{constructor(t,e,s,i,n,a){this.x=t,this.y=e,this.color=s,this.glyph=i,this.romaji=n,this.active=!0,this.speed=qt,this._scale=1,this.animPhase="none",this.animTime=0,this.textScale=1,this.textOpacity=1,this.isTextTransitioning=!1,this.textTransitionTime=0,this.flashTimer=0,this.showingRomaji=!1,this.lastSpoken=-1/0,this.r=a,Et.debug("spawn",{x:this.x.toFixed(2),color:s,glyph:this.glyph})}handleClick(t){t-this.lastSpoken<le||(this.lastSpoken=t,N.vibratePattern("pop").catch(()=>{}),this.triggerTapAnimation(),this.startTextTransition(),$.playRoman(this.romaji),this.flashTimer=gt,Et.debug("toggle",{romaji:this.showingRomaji}))}triggerTapAnimation(){this.animPhase="squash",this.animTime=0,this.scale=1,this.textScale=j}startTextTransition(){this.isTextTransitioning=!0,this.textTransitionTime=mt,this.textOpacity=0}step(t){switch(this.y+=this.speed*t*-1,this.y<-.05&&(this.active=!1),this.animPhase){case"squash":if(this.animTime+=t,this.animTime>=ut)this.animTime=0,this.animPhase="stretch",this.scale=j;else{const s=this.animTime/ut;this.scale=K(1,j,Z(s))}break;case"stretch":if(this.animTime+=t,this.animTime>=ft)this.animTime=0,this.animPhase="settle",this.scale=Q;else{const s=this.animTime/ft;this.scale=K(j,Q,Z(s))}break;case"settle":if(this.animTime+=t,this.animTime>=pt)this.animTime=0,this.animPhase="none",this.scale=1;else{const s=this.animTime/pt;this.scale=K(Q,1,Z(s))}break}this.flashTimer>0&&(this.flashTimer-=t,this.flashTimer<0&&(this.flashTimer=0)),this.isTextTransitioning?(this.textTransitionTime-=t,this.textTransitionTime<=0?(this.showingRomaji=!this.showingRomaji,this.isTextTransitioning=!1,this.textOpacity=1,this.textScale=1):this.textOpacity=Math.max(0,this.textTransitionTime/mt)):this.textScale<1&&(this.textScale=Math.min(1,this.textScale+t*5))}contains(t,e,s,i){if(!this.active)return!1;const n=this.x*s,a=this.y*i,r=t-n,c=e-a,l=r*r+c*c,f=this.r*this.scale;return l<=f*f}get flashAlpha(){return this.flashTimer>0?this.flashTimer/gt:0}get currentTextOpacity(){return this.textOpacity}get currentTextScale(){return this.textScale}get scale(){return this._scale}set scale(t){this._scale=t}}function K(o,t,e){return o+(t-o)*e}function Z(o){return o<1?1-(1-o)*(1-o):1}function kt(o,t){return Math.min(o,t)*Mt}const At=new m("BubbleMgr"),Ot=o=>Math.floor(Math.random()*o),He=()=>{const o=$t();if(o.length===0)return"#FFD1DC";const t=Ot(o.length);return o[t]??o[0]??"#FFD1DC"};class Fe{constructor(t){this.canvas=t,this.bubbles=[],this.spawnTimer=0,this.rPx=0,this.difficulty=1;const{w:e,h:s}=w(t);this.rPx=kt(e,s)}get entities(){return this.bubbles}setDifficulty(t){const e=Math.min(this.difficulty,Y),s=Math.min(t,Y);s!==e&&At.info(`Level up: speed multiplier ${e.toFixed(2)} → ${s.toFixed(2)}`);const i=s/e;this.difficulty=t,this.bubbles.forEach(n=>n.speed*=i)}update(t){for(this.spawnTimer-=t;this.spawnTimer<=0;){const e=Math.min(1+Math.floor(this.difficulty),Zt);for(let s=0;s<e;s++)this.spawn();this.spawnTimer+=Qt/this.difficulty}this.bubbles.forEach(e=>e.step(t)),this.bubbles.some(e=>!e.active)&&(this.bubbles=this.bubbles.filter(e=>e.active))}handleResize(){const{w:t,h:e}=w(this.canvas);this.rPx=kt(t,e),this.bubbles.forEach(s=>s.r=this.rPx)}hitTest(t,e){const{w:s,h:i}=w(this.canvas);for(let n=this.bubbles.length-1;n>=0;n--){const a=this.bubbles[n];if(a&&a.contains(t,e,s,i))return a}}clear(){this.bubbles=[]}spawn(t){var u;if(!((u=g.symbols)!=null&&u.length))return;const e=t??g.symbols[Ot(g.symbols.length)],s=g.randomGlyph(e),{w:i}=w(this.canvas),n=this.rPx/i,a=n+Math.random()*(1-2*n),r=1+n,c=new Bt(a,r,He(),s,e.roman,this.rPx),l=Math.min(this.difficulty,Y),f=1+(Math.random()*2-1)*te;c.speed*=l*f,Math.random()<ee&&(c.showingRomaji=!0),this.bubbles.push(c),At.debug("spawn",{total:this.bubbles.length,roman:e.roman})}guarantee(t){this.spawn(t)}}class ze{pastelDarken(t,e,s=1){const i=this.extractRGB(t),n=Math.floor(i.r*(1-e*.7)+30),a=Math.floor(i.g*(1-e)+20),r=Math.floor(i.b*(1-e*.5)+40);return`rgba(${Math.min(n,255)}, ${Math.min(a,255)}, ${Math.min(r,255)}, ${s})`}pastelLighten(t,e,s=1){const i=this.extractRGB(t),n=Math.floor(i.r+(255-i.r)*e),a=Math.floor(i.g+(255-i.g)*e),r=Math.floor(i.b+(255-i.b)*e);return`rgba(${n}, ${a}, ${r}, ${s})`}extractRGB(t){let e=100,s=100,i=100;if(t.startsWith("#")){const n=t.substring(1);e=parseInt(n.substring(0,2),16),s=parseInt(n.substring(2,4),16),i=parseInt(n.substring(4,6),16)}else if(t.startsWith("rgb")){const n=t.match(/\d+/g);n&&n.length>=3&&(e=parseInt(n[0]||"0"),s=parseInt(n[1]||"0"),i=parseInt(n[2]||"0"))}return{r:e,g:s,b:i,toRGBA:n=>`rgba(${e}, ${s}, ${i}, ${n})`}}render(t,e,s,i,n){const a=e.x*s,r=e.y*i,c=e.r*e.scale;t.save();const l=a-c*.3,f=r-c*.3,u=t.createRadialGradient(Number(l)||0,Number(f)||0,Math.max(1,c*.1),Number(a)||0,Number(r)||0,Math.max(1,c*1.2)),p=e.color||"#cccccc",v=se;let h=p;!p.startsWith("#")&&!p.startsWith("rgb")&&(h="#"+p),u.addColorStop(0,`rgba(255, 255, 255, ${v})`),u.addColorStop(.1,this.pastelLighten(h,.4,v)),u.addColorStop(.7,this.extractRGB(h).toRGBA(v));const b=this.pastelDarken(h,.15,v);u.addColorStop(.92,b),u.addColorStop(1,"rgba(0,0,0,0)"),t.fillStyle=u,t.beginPath(),t.arc(a,r,c,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(a,r,c*.96,0,Math.PI*2),t.shadowColor="rgba(255, 255, 255, 0.3)",t.shadowBlur=c*.15,t.shadowOffsetX=0,t.shadowOffsetY=0,t.fill(),t.beginPath(),t.fillStyle="rgba(255, 255, 255, 0.2)",t.arc(a-c*.43,r-c*.49,c*.2,0,Math.PI*2),t.fill(),t.beginPath(),t.fillStyle="rgba(255, 255, 255, 0.25)",t.arc(a-c*.1,r-c*.66,c*.1,0,Math.PI*2),t.fill(),t.restore();const C=e.showingRomaji?e.romaji:e.glyph,B=e.showingRomaji?ce:oe,O=Math.round(e.r*e.currentTextScale*B);t.save();const D=this.extractRGB(re);if(t.fillStyle=`rgba(${D.r}, ${D.g}, ${D.b}, ${e.currentTextOpacity})`,t.textAlign="center",t.textBaseline="middle",t.font=`${O}px ${ae}`,t.fillText(C,a,r),t.restore(),e.flashAlpha>0){t.save();const ht=e.flashAlpha*he;t.lineWidth=q,t.strokeStyle=`rgba(255, 255, 255, ${ht})`,t.shadowColor="rgba(255, 235, 245, 0.9)",t.shadowBlur=q*2.5,t.beginPath(),t.arc(a,r,c+q*.5,0,Math.PI*2),t.stroke(),t.restore()}}}const Tt=new m("Indicator");class Ne extends Bt{constructor(t,e,s,i,n,a,r){super(t,e,s,i,a,r),this.hira=i,this.kata=n,this.mode=0,this.speed=0,this.showingRomaji=!0,this.glyph=this.hira}handleClick(t){Tt.info(`Indicator cycle tap. Mode was ${this.mode}`),N.vibratePattern("pop").catch(()=>{}),this.triggerTapAnimation(),this.mode=(this.mode+1)%3,this.mode===0?this.showingRomaji=!0:(this.showingRomaji=!1,this.glyph=this.mode===1?this.hira:this.kata),$.playRoman(this.romaji),this.flashTimer=.15,Tt.info(`Indicator now showing ${this.mode===0?"romaji":this.mode===1?"hiragana":"katakana"}`)}step(t){const e=this.y;super.step(t),this.y=e}}const Ue=new m("Pointer");class We{constructor(t,e,s,i){this.canvas=t,this.bubbles=e,this.onTap=s,this.extraTarget=i,this.bound=this.onDown.bind(this)}attach(){this.canvas.addEventListener("pointerdown",this.bound)}detach(){this.canvas.removeEventListener("pointerdown",this.bound)}onDown(t){var a,r;const e=this.canvas.getBoundingClientRect(),s="clientX"in t?t.clientX:((a=t.touches[0])==null?void 0:a.clientX)??0,i="clientY"in t?t.clientY:((r=t.touches[0])==null?void 0:r.clientY)??0;let n=null;if(this.extraTarget){const c=this.extraTarget();c&&c.contains(s-e.left,i-e.top,e.width,e.height)&&(n=c)}n||(n=this.bubbles.hitTest(s-e.left,i-e.top)??null),n&&(n.handleClick(performance.now()/1e3),Ue.debug("hit",{roman:n.romaji}),this.onTap(n))}}class Ve{constructor(){this.el=document.createElement("div"),this.el.style.cssText=`
      position:fixed;top:12px;right:12px;z-index:40;
      padding:8px 18px;border-radius:28px;
      background:rgba(0,0,0,.7);color:#fff;
      font:700 32px/1 'Noto Sans JP',sans-serif;
      display:flex;align-items:center;gap:10px;
      pointer-events:none;user-select:none;transition:opacity .2s ease`,this.el.innerHTML='🔥 <span id="cnt">0</span>',this.el.style.opacity="0"}mount(){document.body.contains(this.el)||document.body.appendChild(this.el)}unmount(){this.el.parentElement&&this.el.parentElement.removeChild(this.el)}set(t){const e=this.el.querySelector("#cnt");e.textContent=String(t),t>0?(this.el.style.opacity="1",this.el.animate([{transform:"scale(1.2)"},{transform:"scale(1)"}],{duration:150,easing:"ease-out"})):this.el.style.opacity="0"}}const F=new m("Play");class Ge extends Rt{constructor(){super(...arguments),this.bubbles=new Fe(this.ctx.canvas),this.renderer=new ze,this.indicator=null,this.streak=0,this.difficulty=1,this.streakUI=new Ve,this.onBubbleTap=t=>{this.indicator&&t!==this.indicator&&(t.romaji===this.indicator.romaji?(this.streak++,F.info(`correct tap: ${t.romaji} streak=${this.streak}`),this.updateDifficulty(),this.streakUI.set(this.streak),$.playPop(),this.spawnIndicator()):(F.warn(`wrong tap: got ${t.romaji} expected ${this.indicator.romaji}`),this.streak=0,this.updateDifficulty(),this.streakUI.set(this.streak),this.indicator.flashTimer=.15))},this.input=new We(this.ctx.canvas,this.bubbles,this.onBubbleTap,()=>this.indicator)}async enter(){await super.enter(),this.bubbles.handleResize(),this.spawnIndicator(),F.info("gameplay start: first indicator spawned"),this.input.attach(),this.streakUI.mount()}update(t){var i;const{w:e,h:s}=w(this.ctx.canvas);if(this.ctx.clearRect(0,0,e,s),rt(this.ctx),this.bubbles.update(t),this.indicator){const n=this.indicator.romaji;if(!this.bubbles.entities.some(a=>a.romaji===n)){const a=(i=g.symbols)==null?void 0:i.find(r=>r.roman===n);a&&this.bubbles.guarantee(a)}}this.indicator&&this.indicator.step(t),this.bubbles.entities.forEach(n=>this.renderer.render(this.ctx,n,e,s)),this.indicator&&this.renderer.render(this.ctx,this.indicator,e,s)}exit(){this.input.detach(),this.bubbles.clear(),this.indicator=null,this.streakUI.unmount(),super.exit()}paint(){}spawnIndicator(){if(!g.symbols||!g.symbols.length)return;const{w:t,h:e}=w(this.ctx.canvas),s=g.symbols[Math.floor(Math.random()*g.symbols.length)];F.debug(`spawnIndicator: target ${s.roman}`);const i=Math.min(t,e)*Mt,n=$t(),a=n[Math.floor(Math.random()*n.length)]??"#FFD1DC",r=s.glyphs.hiragana,c=s.glyphs.katakana,l=i/e+.02;this.indicator=new Ne(.5,l,a,r,c,s.roman,i),this.bubbles.guarantee(s),$.playRoman(s.roman),this.streakUI.set(this.streak)}updateDifficulty(){this.difficulty=Math.min(1+this.streak/Kt,Jt),this.bubbles.setDifficulty(this.difficulty)}}if(typeof window<"u"&&window.location.search.includes("debug")){const o=document.createElement("button"),t=document.createElement("pre");o.textContent="🚦",o.title="Show / hide debug console",o.style.cssText="position:fixed;bottom:16px;left:16px;width:44px;height:44px;z-index:99998;font-size:24px;background:#000C;color:#0F0;border-radius:22px;border:1px solid #0F0;cursor:pointer;user-select:none",t.style.cssText="position:fixed;bottom:72px;left:16px;max-width:90vw;max-height:70vh;width:60vw;height:40vh;resize:both;z-index:99999;background:#000C;color:#0F0;margin:0;padding:0;font:12px/1.4 monospace;overflow:auto;white-space:pre-wrap;box-sizing:border-box;display:none;border:1px solid #0F0;border-radius:4px;";const e=document.createElement("div");e.style.cssText="position:sticky;top:0;left:0;right:0;height:20px;background:#030;color:#9f9;padding:2px 6px;font-weight:bold;cursor:move;border-bottom:1px solid #0F0;user-select:none;touch-action:none",e.textContent="Debug log",t.append(e);const s=document.createElement("span");s.textContent=`🚦 kana-pop live debug console (first error wins)

`,t.append(s);let i=0,n=0,a=!1,r=!1;const c=()=>{a=!1};e.addEventListener("pointerdown",h=>{h.stopPropagation(),a=!0,r=!1,i=h.clientX-t.offsetLeft,n=h.clientY-t.offsetTop,e.setPointerCapture(h.pointerId)}),e.addEventListener("pointermove",h=>{h.stopPropagation(),a&&(r=!0,t.style.left=`${h.clientX-i}px`,t.style.bottom="auto",t.style.top=`${h.clientY-n}px`)}),e.addEventListener("pointerup",h=>{c(),r||(l=!l,u(),h.stopPropagation(),h.preventDefault())}),e.addEventListener("pointercancel",c),document.addEventListener("DOMContentLoaded",()=>{document.body.append(o,t)},{once:!0});let l=!1;const f=["Bubble","Indicator","Streak","Level","Pointer","spawn","Tap","correct","wrong","miss","SM","BubbleMgr"],u=()=>{e.textContent=l?"Debug log - ALL":"Debug log - GAMEPLAY"};u(),o.addEventListener("click",h=>{if(h.shiftKey){l=!l,u(),h.stopPropagation(),h.preventDefault();return}h.stopPropagation(),h.preventDefault(),t.style.display=t.style.display==="none"?"block":"none"}),o.addEventListener("pointerdown",h=>h.stopPropagation()),t.addEventListener("pointerdown",h=>h.stopPropagation());const p=h=>{s.textContent+=h+`
`,t.scrollTop=t.scrollHeight},v=(h,b)=>{const C=b instanceof Error&&b.stack?b.stack:typeof b=="string"?b:JSON.stringify(b,null,2);p(`🛑 ${h}: ${C}`),t.style.display="block"};window.addEventListener("error",h=>v("error",h.error??h.message)),window.addEventListener("unhandledrejection",h=>v("promise",h.reason)),["log","info","warn","error"].forEach(h=>{const b=console[h];console[h]=(...C)=>{b.apply(console,C);const B=C.map(x=>{if(typeof x!="string")return typeof x=="object"?JSON.stringify(x,null,2):String(x);let dt=x.startsWith("%c")?x.replace(/%c/g,""):x;return/^(?:color|background|font|padding|border)/i.test(dt.trim())?null:dt.trim()}).filter(Boolean);if(B.length===0)return;const O=B.join(" ");if(!(l||f.some(x=>O.includes(x))))return;p(`${h==="error"?"🛑":h==="warn"?"⚠️":"🔹"} ${O}`)}})}let y=null,z=null,M=0,R=performance.now();const ct=document.querySelector("#game");if(!ct)throw new Error("#game canvas not found");const nt=ct.getContext("2d");if(!nt)throw new Error("2-D context not available");const lt=document.createElement("canvas");lt.id="bg";document.body.prepend(lt);function at(){document.documentElement.style.setProperty("--app-height",`${window.innerHeight}px`)}document.readyState==="loading"?window.addEventListener("DOMContentLoaded",at,{once:!0}):at();window.addEventListener("resize",at);$.armFirstGesture(window);_.watchCanvas(ct);(async()=>{const o=I.get("kanaPop.theme")??"assets/themes/pastel-pond/";await et.load(o),y=new Te,y.add("home",new Ie(y,nt)).add("play",new Ge(y,nt)),z=new ke(lt),await y.change("home"),ot.run(()=>{}).catch(console.error),R=performance.now(),M=requestAnimationFrame(G)})();function G(o){const t=(o-R)/1e3;R=o,z==null||z.paint(t),y==null||y.update(t),M=requestAnimationFrame(G)}document.addEventListener("visibilitychange",()=>{document.hidden?cancelAnimationFrame(M):(R=performance.now(),M=requestAnimationFrame(G))});document.addEventListener("scenechange",o=>{const{nextScene:t}=o.detail;y&&y.change(t),R=performance.now(),M=requestAnimationFrame(G)});
