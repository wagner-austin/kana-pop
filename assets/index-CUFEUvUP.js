(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function e(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=e(s);fetch(s.href,o)}})();function b(r){const{clientWidth:t,clientHeight:e}=r;return{w:t,h:e}}function dt(){return window.devicePixelRatio||1}function _(r){const t=dt();r.setTransform(1,0,0,1,0,0),r.scale(t,t)}function vt(r){const t=dt(),{w:e,h:i}=b(r);return r.width=Math.round(e*t),r.height=Math.round(i*t),{w:e,h:i,dpr:t}}class St{constructor(){this.listeners=new Set,this.watchedCanvases=new Map,this.mediaQuery=null,this.boundTrigger=this.trigger.bind(this),this.dprCallback=null,this.metrics={w:0,h:0,dpr:1}}subscribe(t){this.listeners.add(t),t(),this.listeners.size===1&&this.attachWindowListeners()}unsubscribe(t){this.listeners.delete(t),this.listeners.size===0&&this.detachWindowListeners()}watchCanvas(t){const e=()=>{const i=vt(t);this.metrics=i};this.watchedCanvases.set(t,e),this.subscribe(e)}unwatchCanvas(t){const e=this.watchedCanvases.get(t);e&&(this.unsubscribe(e),this.watchedCanvases.delete(t))}trigger(){this.listeners.forEach(t=>t())}attachWindowListeners(){typeof window<"u"&&(window.addEventListener("resize",this.boundTrigger),this.addDprListener())}detachWindowListeners(){var t;typeof window<"u"&&window.removeEventListener("resize",this.boundTrigger),this.dprCallback&&((t=this.mediaQuery)==null||t.removeEventListener("change",this.dprCallback)),this.mediaQuery=null,this.dprCallback=null}addDprListener(){var t;typeof window>"u"||typeof window.matchMedia>"u"||(this.dprCallback&&((t=this.mediaQuery)==null||t.removeEventListener("change",this.dprCallback)),this.mediaQuery=matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`),this.dprCallback=()=>{this.boundTrigger(),this.addDprListener()},this.mediaQuery.addEventListener("change",this.dprCallback,{once:!0}))}get cssWidth(){return this.metrics.w}get cssHeight(){return this.metrics.h}get dpr(){return this.metrics.dpr}}const I=new St,ht="Pastel Pond",ut={palette:"palette.json",background:"background.jpg"},gt={type:"image",file:"background.png"},Ct={name:ht,assets:ut,effect:gt},At=Object.freeze(Object.defineProperty({__proto__:null,assets:ut,default:Ct,effect:gt,name:ht},Symbol.toStringTag,{value:"Module"})),It=["#FFD1DC","#B5EAD7","#C7CEEA","#FFDAC1","#E2F0CB"],Lt=Object.freeze(Object.defineProperty({__proto__:null,default:It},Symbol.toStringTag,{value:"Module"})),kt="data:video/mp2t;base64,aW1wb3J0IFJlc2l6ZVNlcnZpY2UgZnJvbSAnLi9zZXJ2aWNlcy9SZXNpemVTZXJ2aWNlJzsKaW1wb3J0IEJhY2tncm91bmRNYW5hZ2VyIGZyb20gJy4vY29yZS9CYWNrZ3JvdW5kTWFuYWdlcic7CmltcG9ydCBTdGF0ZU1hY2hpbmUgZnJvbSAnLi9jb3JlL1N0YXRlTWFjaGluZSc7CmltcG9ydCBIb21lU2NlbmUgZnJvbSAnLi9zY2VuZXMvSG9tZVNjZW5lJzsKaW1wb3J0IFBsYXlTY2VuZSBmcm9tICcuL3NjZW5lcy9QbGF5U2NlbmUnOwppbXBvcnQgVGhlbWUgZnJvbSAnLi9zZXJ2aWNlcy9UaGVtZVNlcnZpY2UnOwppbXBvcnQgTG9hZGVyIGZyb20gJy4vc2VydmljZXMvQXNzZXRMb2FkZXInOwppbXBvcnQgU3RvcmFnZSBmcm9tICcuL3V0aWxzL1N0b3JhZ2VTZXJ2aWNlJzsKaW1wb3J0IFNvdW5kIGZyb20gJy4vc2VydmljZXMvU291bmRTZXJ2aWNlJzsKCmxldCBzbTogU3RhdGVNYWNoaW5lIHwgbnVsbCA9IG51bGw7CmxldCBiZzogQmFja2dyb3VuZE1hbmFnZXIgfCBudWxsID0gbnVsbDsKCi8vIEdldCBjYW52YXMgcmVmZXJlbmNlcyBmaXJzdCBidXQgZG9uJ3Qgc3RhcnQgcmVuZGVyaW5nIHlldApjb25zdCBjYW52YXMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yPEhUTUxDYW52YXNFbGVtZW50PignI2dhbWUnKTsKaWYgKCFjYW52YXMpIHRocm93IG5ldyBFcnJvcignI2dhbWUgY2FudmFzIG5vdCBmb3VuZCcpOwpjb25zdCBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKTsKaWYgKCFjdHgpIHRocm93IG5ldyBFcnJvcignMi1EIGNvbnRleHQgbm90IGF2YWlsYWJsZScpOwoKLy8gQ3JlYXRlIGJhY2tncm91bmQgY2FudmFzIGJ1dCBkb24ndCBzdGFydCByZW5kZXJpbmcgeWV0CmNvbnN0IGJnQ2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CmJnQ2FudmFzLmlkID0gJ2JnJzsKZG9jdW1lbnQuYm9keS5wcmVwZW5kKGJnQ2FudmFzKTsKCi8qIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogKiAgUG9seWZpbGw6IGtlZXAgQ1NTIHZhciAtLWFwcC1oZWlnaHQgZXF1YWwgdG8gd2luZG93LmlubmVySGVpZ2h0LgogKiAgTmVlZGVkIGZvciBvbGRlciBtb2JpbGUgYnJvd3NlcnMgdGhhdCBtaXMtcmVwb3J0IDEwMHZoLgogKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCmZ1bmN0aW9uIHNldEFwcEhlaWdodCgpIHsKICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc3R5bGUuc2V0UHJvcGVydHkoJy0tYXBwLWhlaWdodCcsIGAke3dpbmRvdy5pbm5lckhlaWdodH1weGApOwp9CmlmIChkb2N1bWVudC5yZWFkeVN0YXRlID09PSAnbG9hZGluZycpIHsKICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIHNldEFwcEhlaWdodCwgeyBvbmNlOiB0cnVlIH0pOwp9IGVsc2Ugc2V0QXBwSGVpZ2h0KCk7CndpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdyZXNpemUnLCBzZXRBcHBIZWlnaHQpOyAvLyBvcmllbnRhdGlvbmNoYW5nZSDihpIgcmVzaXplCgovLyBBdHRhY2ggaW1tZWRpYXRlbHksIHNvIHRoZSAqdmVyeSBmaXJzdCogdGFwIGNvdW50cwpTb3VuZC5hcm1GaXJzdEdlc3R1cmUod2luZG93KTsKUmVzaXplU2VydmljZS53YXRjaENhbnZhcyhjYW52YXMpOwoKKGFzeW5jICgpID0+IHsKICAvLyBMb2FkIGFsbCByZXNvdXJjZXMgYW5kIGluaXRpYWxpemUgZXZlcnl0aGluZyBiZWZvcmUgc3RhcnRpbmcgYW55IHJlbmRlcmluZwogIC8qIDEgLSB0aGVtZSBmaXJzdCAqLwogIGNvbnN0IHRoZW1lUGF0aCA9IFN0b3JhZ2UuZ2V0KCdrYW5hUG9wLnRoZW1lJykgPz8gJ2Fzc2V0cy90aGVtZXMvcGFzdGVsLXBvbmQvJzsKICBhd2FpdCBUaGVtZS5sb2FkKHRoZW1lUGF0aCk7CgogIC8qIDIgLSBpbml0aWFsaXplIHNjZW5lcyAqLwogIHNtID0gbmV3IFN0YXRlTWFjaGluZSgpOwogIHNtLmFkZCgnaG9tZScsIG5ldyBIb21lU2NlbmUoc20sIGN0eCkpLmFkZCgncGxheScsIG5ldyBQbGF5U2NlbmUoc20sIGN0eCkpOwoKICAvKiAzIC0gaW5pdGlhbGl6ZSBiYWNrZ3JvdW5kIG1hbmFnZXIgT05MWSBhZnRlciB0aGVtZSBpcyBsb2FkZWQgKi8KICBiZyA9IG5ldyBCYWNrZ3JvdW5kTWFuYWdlcihiZ0NhbnZhcyk7CgogIC8qIDQgLSBjaGFuZ2UgdG8gaG9tZSBzY2VuZSAqLwogIGF3YWl0IHNtLmNoYW5nZSgnaG9tZScpOyAvLyBkcmF3IOKAnFRhcCB0byBTdGFydOKAnSBpbW1lZGlhdGVseQoKICAvKiA1IC0ga2ljayBvZmYgKG5vbi1ibG9ja2luZykgYXNzZXQgbG9hZCAqLwogIExvYWRlci5ydW4oKCkgPT4ge30pLmNhdGNoKGNvbnNvbGUuZXJyb3IpOyAvLyBubyB2aXN1YWwgcHJvZ3Jlc3MgYmFyCgogIC8qIDYgLSBOT1cgc3RhcnQgdGhlIGdhbWUgbG9vcCAtIGV2ZXJ5dGhpbmcgaXMgcmVhZHkgKi8KICBsYXN0ID0gcGVyZm9ybWFuY2Uubm93KCk7CiAgcmFmID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGxvb3ApOwp9KSgpOwoKbGV0IHJhZiA9IDA7CmxldCBsYXN0ID0gcGVyZm9ybWFuY2Uubm93KCk7CmZ1bmN0aW9uIGxvb3Aobm93OiBudW1iZXIpIHsKICBjb25zdCBkdCA9IChub3cgLSBsYXN0KSAvIDEwMDA7CiAgbGFzdCA9IG5vdzsKICBiZz8ucGFpbnQoZHQpOyAvLyDikaAgZHJhdyBiYWNrZ3JvdW5kIGZpcnN0CiAgc20/LnVwZGF0ZShkdCk7IC8vIOKRoSBhY3RpdmUgc2NlbmUgcGFpbnRzIG9uICNnYW1lIGNhbnZhcwogIHJhZiA9IHJlcXVlc3RBbmltYXRpb25GcmFtZShsb29wKTsKfQoKLy8gU3VzcGVuZCB3aGVuIHBhZ2UgaXMgaGlkZGVuIChzYXZlcyBiYXR0ZXJ5IG9uIGlPUykKZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndmlzaWJpbGl0eWNoYW5nZScsICgpID0+IHsKICBpZiAoZG9jdW1lbnQuaGlkZGVuKSBjYW5jZWxBbmltYXRpb25GcmFtZShyYWYpOwogIGVsc2UgewogICAgbGFzdCA9IHBlcmZvcm1hbmNlLm5vdygpOwogICAgcmFmID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGxvb3ApOwogIH0KfSk7Cgpkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdzY2VuZWNoYW5nZScsIChlKSA9PiB7CiAgY29uc3QgeyBuZXh0U2NlbmUgfSA9IChlIGFzIEN1c3RvbUV2ZW50KS5kZXRhaWw7CiAgaWYgKHNtKSB7CiAgICBzbS5jaGFuZ2UobmV4dFNjZW5lKTsKICB9CiAgbGFzdCA9IHBlcmZvcm1hbmNlLm5vdygpOyAvLyByZXNldCBsYXN0IHRvIGF2b2lkIGEgZ2lhbnQgZHQKICByYWYgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUobG9vcCk7Cn0pOwo=",Et=1.2,Tt=.5,xt=["#ffaaa5","#ffd3b6","#c7ceea","#e2f0cb","#b5ead7"];let mt=null;function Zt(r){mt=r}function Wt(){return mt??xt}const M="#222",Gt="Noto Sans JP, sans-serif",Bt=M,Nt=.08,Ft=.8,Pt=.55,Rt=.4,N=50,D=.08,Q=.1,q=.14,T=.85,F=1.2,tt=0,et=.15,Vt=.6,it=4,Ht="__kanaPopDebug_",zt=40,Yt=60,Ot=250,$t=!0,C=class C{constructor(t,e=C.bootLevel){this.scope=t,this.level=e}out(t,...e){}debug(...t){this.out("debug",...t)}info(...t){this.out("info",...t)}warn(...t){this.out("warn",...t)}error(...t){this.out("error",...t)}};C.bootLevel=(()=>{if(typeof globalThis>"u"||!("localStorage"in globalThis))return"info";const t=localStorage.getItem("logLevel");return t&&["debug","info","warn","error","off"].includes(t)?t:"info"})(),C.isDebug=C.bootLevel==="debug",C.levelOrder={debug:0,info:1,warn:2,error:3,off:4};let u=C;function Xt(){return{setLevel(r){localStorage.setItem("logLevel",r),location.reload()}}}typeof window<"u"&&(window.logger=Xt());const v=class v{constructor(t){if(this.ready=!1,this.imgHorizontal=null,this.imgVertical=null,this.loadedHorizontal=!1,this.loadedVertical=!1,typeof window<"u"){const e=t.lastIndexOf("/"),i=e!==-1?t.substring(0,e+1):"",s=e!==-1?t.substring(e+1):t,o=s.includes("horizontal"),n=s.includes("vertical");if(this.imgHorizontal=new Image,this.imgHorizontal.onload=()=>{var a;v.log.debug(`Loaded horizontal: ${(a=this.imgHorizontal)==null?void 0:a.src}`),this.loadedHorizontal=!0,this.updateReadyState()},this.imgHorizontal.onerror=()=>{var a;this.loadedHorizontal=!1,v.log.error(`Failed to load horizontal image: ${(a=this.imgHorizontal)==null?void 0:a.src}`),this.updateReadyState()},this.imgVertical=new Image,this.imgVertical.onload=()=>{var a;v.log.debug(`Loaded vertical: ${(a=this.imgVertical)==null?void 0:a.src}`),this.loadedVertical=!0,this.updateReadyState()},this.imgVertical.onerror=()=>{var a;this.loadedVertical=!1,v.log.error(`Failed to load vertical image: ${(a=this.imgVertical)==null?void 0:a.src}`),this.updateReadyState()},o)this.imgHorizontal.src=t,this.imgVertical.src=t.replace("horizontal","vertical");else if(n)this.imgVertical.src=t,this.imgHorizontal.src=t.replace("vertical","horizontal");else if(window.location.hostname==="wagner-austin.github.io"||window.location.hostname.includes("github.io")){const a="/kana-pop/",c=i.startsWith("/")?`${a}${i.substring(1)}`:`${a}${i}`;this.imgHorizontal.src=`${c}background_horizontal.png`,this.imgVertical.src=`${c}background_vertical.png`}else this.imgHorizontal.src=`${i}background_horizontal.png`,this.imgVertical.src=`${i}background_vertical.png`;v.log.debug(`Loading images from: ${this.imgHorizontal.src} and ${this.imgVertical.src}`)}else this.ready=!0}resize(){}updateReadyState(){this.ready=this.loadedHorizontal||this.loadedVertical}update(t,e){if(!this.ready)return!1;const i=e.canvas.width,s=e.canvas.height,o=i/s;let n=null;if(o>=1?n=this.loadedHorizontal?this.imgHorizontal:this.imgVertical:n=this.loadedVertical?this.imgVertical:this.imgHorizontal,!n||!n.complete||n.naturalWidth===0)return!1;const a=n.naturalWidth/n.naturalHeight;let c,l,h=0,g=0;return a>o?(l=s,c=l*a,h=(i-c)/2):(c=i,l=c/a,g=(s-l)/2),e.drawImage(n,h,g,c,l),!0}};v.log=new u("ImageEffect");let H=v;class Ut{constructor(t){this.cls=t,document.body.classList.add(t)}resize(){}update(){return!1}dispose(){document.body.classList.remove(this.cls)}}class st{constructor(t){this.vid=null,typeof document<"u"&&typeof window<"u"&&(this.vid=document.createElement("video"),this.vid.src=t,this.vid.autoplay=!0,this.vid.loop=!0,this.vid.muted=!0,this.vid.style.position="fixed",this.vid.style.top="0",this.vid.style.left="0",this.vid.style.width="100%",this.vid.style.height="100%",this.vid.style.objectFit="cover",this.vid.style.zIndex="-1",document.body.appendChild(this.vid))}resize(){}update(t,e){return!1}dispose(){this.vid&&this.vid.parentNode&&(this.vid.parentNode.removeChild(this.vid),this.vid=null)}}const A=new u("ShaderEffect");class _t{constructor(t){this.container=null,this.shaderConfig=t,A.debug(`ShaderEffect created with config: ${this.shaderConfig}`)}mount(t){this.container=t;const e=document.createElement("div");e.style.width="100%",e.style.height="100%",e.style.backgroundColor="rgba(50, 0, 50, 0.8)",e.textContent=`Shader Effect: ${this.shaderConfig}`,e.style.color="white",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",this.container.appendChild(e),A.debug("ShaderEffect mounted. Config:",this.shaderConfig)}unmount(){if(this.container){for(;this.container.firstChild;)this.container.removeChild(this.container.firstChild);A.debug("ShaderEffect unmounted.")}this.container=null}resize(t,e,i){A.debug(`ShaderEffect resize called: ${t}x${e} @ ${i}x`)}update(t,e){return A.debug(`ShaderEffect update called with dt: ${t}`),!1}}const nt=Object.assign({"../assets/themes/pastel-pond/theme.json":At}),Mt=Object.assign({"../assets/themes/pastel-pond/palette.json":Lt});function jt(r){const t="/kana-pop/";return t?t+r.replace(/^\/+/,""):r}class Kt{async load(t){const e=`../${t.endsWith("/")?t:t+"/"}theme.json`.replace(/^\.\.\/\/+/,"../"),i=nt[e];if(!i)throw new Error(`Theme manifest not embedded for base '${t}'. Tried key '${e}'. Available MANIFESTS keys: ${Object.keys(nt).join(", ")}`);const s=i.assets.palette.startsWith("/")?i.assets.palette.substring(1):i.assets.palette,o=`../${t.endsWith("/")?t:t+"/"}${s}`.replace(/^\.\.\/\/+/,"../"),n=Mt[o]??["#ffffff"],a=await this.makeEffect(i.effect,t);return this.current={name:i.name,palette:n,effect:a},Zt(n),this.current}get theme(){return this.current}async makeEffect(t,e){const i=e.replace(/^assets\/themes\//,"").replace(/\/$/,"");if(t.type==="image"){const s=`../${e}${t.file}`,o=new URL(s,import.meta.url).href;return new H(o)}else if(t.type==="video"){const s=new URL(Object.assign({"../main.ts":kt})[`../${e}${t.file}`],import.meta.url).href;try{return new st(s)}catch(o){console.warn(`ThemeService: Failed to import video asset "${t.file}" with ?url. Error:`,o);const n=jt(`assets/themes/${i}/${t.file}`);return console.warn(`ThemeService: Falling back to unhashed path for video: "${n}"`),new st(n)}}else if(t.type==="script")try{const n=(await import(`/src/assets/themes/${i}/${t.file}`))[t.export];if(typeof n=="function")return new n(e);throw new Error(`Export "${t.export}" from script "${t.file}" is not a constructor.`)}catch(s){throw console.error(`Failed to load script effect "${t.file}":`,s),s}else{if(t.type==="shader")return new _t(t.shader);if(t.type==="css")return new Ut(t.class);{const s=t;throw new Error(`ThemeService: unknown effect type: ${JSON.stringify(s)}`)}}}}const z=new Kt;class Jt{constructor(t){this.canvas=t,this.time=0;const e=t.getContext("2d");if(!e)throw new Error("2-D context not available");this.ctx=e,I.watchCanvas(t),I.subscribe(()=>this.paint(0))}paint(t){var s,o,n;this.time+=t,_(this.ctx);const e=window.devicePixelRatio||1;if(this.ctx.save(),this.ctx.scale(1/e,1/e),!((o=(s=z.theme)==null?void 0:s.effect)==null?void 0:o.update(t,this.ctx))){const{w:a,h:c}=b(this.canvas);this.ctx.fillStyle=((n=z.theme)==null?void 0:n.palette[2])??"#c7ceea",this.ctx.fillRect(0,0,a,c)}this.ctx.restore()}}const Dt=new u("SM");class Qt{constructor(){this.states=new Map,this.stack=[]}add(t,e){return this.states.set(t,e),this}async change(t){var e,i;Dt.info("→ change",{from:this.currentName,to:t}),(e=this.current)!=null&&e.exit&&this.current.exit(),this.current=this.states.get(t),this.currentName=t,(i=this.current)!=null&&i.enter&&await this.current.enter()}update(t){var e,i;(i=(e=this.current)==null?void 0:e.update)==null||i.call(e,t)}get currentStateName(){return this.currentName}async push(t){var e;this.current&&(this.stack.push(this.current),this.current.exit&&this.current.exit()),this.current=this.states.get(t),this.currentName=t,(e=this.current)!=null&&e.enter&&await this.current.enter()}async pop(){var t,e,i;this.stack.length&&((t=this.current)!=null&&t.exit&&this.current.exit(),this.current=this.stack.pop(),this.currentName=this.current?(e=[...this.states.entries()].find(([,s])=>s===this.current))==null?void 0:e[0]:void 0,(i=this.current)!=null&&i.enter&&await this.current.enter())}}class ft{constructor(t,e){this.resizeHandler=this.paint.bind(this),this.sm=t,this.ctx=e}async enter(){I.subscribe(this.resizeHandler),this.paint()}update(t){}exit(){I.unsubscribe(this.resizeHandler)}clear(){const{w:t,h:e}=b(this.ctx.canvas);return this.ctx.clearRect(0,0,t,e),_(this.ctx),{w:t,h:e}}}const qt={pop:50,error:[50,100,50],success:[50,50,50,50,100],gameOver:[100,50,100,50,300]},P=new u("Storage");class te{constructor(){this.isNative=!1,this.storage=this.detectStorage()}detectStorage(){if(typeof window<"u"&&typeof localStorage=="object")try{const t="__storage_test__";return localStorage.setItem(t,t),localStorage.removeItem(t),P.debug("Using native localStorage"),this.isNative=!0,localStorage}catch(t){P.warn("localStorage detected but unavailable (Safari private mode?), using memory storage",t)}else P.info("No localStorage available (Node/test environment), using memory storage");return new Map}get(t){if(this.isNative)return this.storage.getItem(t);const e=this.storage;return e.has(t)?e.get(t):null}set(t,e){this.isNative?this.storage.setItem(t,e):this.storage.set(t,e)}remove(t){this.isNative?this.storage.removeItem(t):this.storage.delete(t)}clear(){this.isNative?this.storage.clear():this.storage.clear()}}const L=new te,p=new u("Haptics");class ee{constructor(){if(this.enabled=L.get("kanaPop.haptics")!=="false"&&$t,this.debugElement=null,this.lastVibration=0,this.patternArraysOkay=null,!(typeof window>"u"||typeof navigator>"u")){if(window.matchMedia("(prefers-reduced-motion: reduce)").matches){p.info("Haptics disabled due to reduced-motion preference.");return}if(typeof navigator.vibrate=="function"){this.enabled=!0,p.info("Haptic feedback enabled.");const t=()=>{this.updateDebugStatus("Activation gesture received (resume only)")};window.addEventListener("pointerdown",t,{once:!0,passive:!0})}else p.info("Haptic feedback not supported on this device.")}}async vibrate(t=50,e=2){if(!this.enabled)return Promise.resolve(!1);if(this.patternArraysOkay===null)try{navigator.vibrate([1,1])?(navigator.vibrate(0),this.patternArraysOkay=!0,this.updateDebugStatus("Array patterns seem supported.")):(this.patternArraysOkay=!1,this.updateDebugStatus("Array patterns rejected (vibrate returned false)."))}catch(a){this.patternArraysOkay=!1,this.updateDebugStatus(`Array patterns rejected (vibrate threw error: ${a instanceof Error?a.message:String(a)}).`)}const i=Date.now(),s=Array.isArray(t),o=s?Ot:Yt;if(i-this.lastVibration<o)return this.updateDebugStatus(`Throttled (gap: ${o}ms)`),Promise.resolve(!1);let n;if(s)n=t.map(a=>Math.max(a,N)),!this.patternArraysOkay&&n.length>0&&(n=Math.max(...n,N),this.updateDebugStatus("Collapsed array to single max pulse for compatibility."));else{const a=Math.max(t,N),c=zt;switch(e){case 1:n=a;break;case 2:n=Math.min(a*1.5,150);break;case 3:n=this.patternArraysOkay?[a,c,a]:a*2;break;default:return p.warn(`Invalid intensity: ${e} for numeric pattern.`),Promise.resolve(!1)}}try{return Array.isArray(n)&&n.length===0?(p.warn("Attempted to vibrate with an empty pattern array."),Promise.resolve(!1)):typeof n=="number"&&n===0&&t!==0?(p.warn("Calculated vibration duration is zero, skipping."),Promise.resolve(!1)):navigator.vibrate(n)?(this.lastVibration=i,this.updateDebugStatus(`Vibrated: ${JSON.stringify(n)}`),p.info("Vibrating with:",{originalPattern:t,intensity:e,actualVibration:n}),Promise.resolve(!0)):(this.updateDebugStatus("navigator.vibrate() returned false."),p.warn("navigator.vibrate() returned false for pattern:",n),Promise.resolve(!1))}catch(a){return p.warn("Vibration failed with error:",a),this.updateDebugStatus(`Failed: ${a instanceof Error?a.message:String(a)}`),Array.isArray(n)&&this.patternArraysOkay&&(this.patternArraysOkay=!1,this.updateDebugStatus("Error with array vibration, marked arrays as not okay for future.")),Promise.resolve(!1)}}isSupported(){return this.enabled}createDebugElement(){var e;if(typeof document>"u")return;const t=`${Ht}Haptics`;(e=document.getElementById(t))==null||e.remove(),this.debugElement=document.createElement("div"),this.debugElement.id=t,this.debugElement.style.position="fixed",this.debugElement.style.bottom="30px",this.debugElement.style.left="10px",this.debugElement.style.background="rgba(0,0,0,0.5)",this.debugElement.style.color="white",this.debugElement.style.padding="5px",this.debugElement.style.fontSize="12px",this.debugElement.style.zIndex="9999",this.debugElement.style.pointerEvents="none",document.body.appendChild(this.debugElement)}updateDebugStatus(t){this.debugElement&&(this.debugElement.textContent=`Haptics: ${t}`)}vibratePattern(t){const e=qt[t];return typeof e=="number"?this.vibrate(e):this.vibrate([...e])}setEnabled(t){this.enabled=t,L.set("kanaPop.haptics",String(t)),t||navigator.vibrate(0)}isEnabled(){return this.enabled}}const Y=new ee;class ie{constructor(t){this.onClose=t,this.overlay=document.createElement("div"),this.overlay.style.cssText=`
      position:fixed;inset:0;background:rgba(0,0,0,.6);
      color:${M};display:flex;flex-direction:column;
      align-items:center;justify-content:center;
      font:18px sans-serif;z-index:50`,this.overlay.innerHTML=`
      <h2 style="margin:0 0 20px">Settings</h2>
      <label style="margin-bottom:15px;display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="hapticsToggle">
        Haptics
      </label>
      <button id="close">Close</button>`,this.overlay.querySelector("#close").addEventListener("click",()=>this.toggle());const e=this.overlay.querySelector("#hapticsToggle");e.addEventListener("change",()=>{Y.setEnabled(e.checked)})}toggle(){document.body.contains(this.overlay)?this.hide():this.show()}show(){document.body.appendChild(this.overlay);const t=this.overlay.querySelector("#hapticsToggle");t.checked=Y.isEnabled()}hide(){this.overlay.remove(),this.onClose()}}class se extends ft{constructor(){super(...arguments),this.settings=new ie(()=>{}),this.enter=async()=>{document.body.dataset.scene="home",await super.enter(),window.addEventListener("pointerdown",this.onTap)},this.exit=()=>{window.removeEventListener("pointerdown",this.onTap),this.settings.hide(),delete document.body.dataset.scene,super.exit()},this.onTap=t=>{const{w:e,h:i}=b(this.ctx.canvas),{offsetX:s,offsetY:o}=t;s>e-60&&o>i-60?this.settings.toggle():this.sm.change("play")}}paint(){const{w:t,h:e}=this.clear();this.ctx.fillStyle=M,this.ctx.textAlign="center",this.ctx.font="32px sans-serif",this.ctx.fillText("Tap to Start",t/2,e/2),this.ctx.font="20px sans-serif",this.ctx.fillText("⚙︎",t-30,e-30)}}function ne(){if(typeof navigator>"u")return!1;const r=typeof navigator>"u"?"":navigator.userAgent;return/iPad|iPhone|iPod/.test(r)&&!(typeof window<"u"&&window.MSStream)}function ae(){if(typeof navigator>"u")return!1;const r=typeof navigator>"u"?"":navigator.userAgent;return/iPad/.test(r)||typeof navigator<"u"&&navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1}function O(){if(typeof navigator>"u")return!1;if(ne()||ae())return!0;const r=typeof navigator>"u"?"":navigator.userAgent;return!!(/iPad|iPhone|iPod/.test(r)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>0)}const w=new u("Audio");class re{constructor(){this.bank=new Map}async ensureContext(){const t=()=>{const e=globalThis,i=e.AudioContext??e.webkitAudioContext;if(!i)throw new Error("Web Audio API not supported");const s=new i;return w.info(`Created new AudioContext: ${s.state}`),s};if((!this.ctx||this.ctx.state==="closed")&&(this.ctx=t()),this.ctx.state==="suspended"||this.ctx.state==="interrupted"){w.info(`Attempting resume() from ${this.ctx.state}`);try{await this.ctx.resume()}catch(e){w.warn("resume() threw",e)}}if(this.ctx.state!=="running"){w.warn(`AudioContext stuck in '${this.ctx.state}', recreating…`);try{await this.ctx.close()}catch{}this.ctx=t(),await this.ctx.resume()}return this.ctx}async fetch(t){if(this.bank.has(t))return this.bank.get(t);try{const e=await(await fetch(t)).arrayBuffer(),s=await(await this.ensureContext()).decodeAudioData(e);return this.bank.set(t,s),s}catch(e){throw w.error(`decodeAudioData failed for ${t}`,e),e}}async play(t){const e=await this.ensureContext(),i=e.createBufferSource();i.buffer=t,i.connect(e.destination),i.start(),i.onended=()=>i.disconnect()}async resume(){try{const t=await this.ensureContext();if(O()){w.info("iOS/iPadOS detected, playing silent buffer to unlock audio");const e=t.sampleRate||44100,i=t.createBuffer(2,e*.5,e);for(let a=0;a<2;a++){const c=i.getChannelData(a);for(let l=0;l<c.length;l++)c[l]=0}const s=O()?.5:.1,o=t.createGain();o.gain.value=.001;const n=t.createBufferSource();n.buffer=i,n.connect(o),o.connect(t.destination),n.start(0),n.stop(t.currentTime+s),n.onended=()=>{n.disconnect(),o.disconnect()},w.info(`Silent buffer played (duration: ${s}s)`)}return t}catch(t){throw w.error("Resume failed",t),t}}}class oe{constructor(){this.tasks=[]}add(t){this.tasks.push(t)}async run(t,e=!0){if(this.tasks.length===0){t(1);return}if(e){let i=0;await Promise.all(this.tasks.map(s=>s().then(()=>{t(++i/this.tasks.length)})))}else for(let i=0;i<this.tasks.length;i++){const s=this.tasks[i];await s(),t((i+1)/this.tasks.length)}this.tasks=[]}}const j=new oe,le="modulepreload",ce=function(r){return"/kana-pop/"+r},at={},rt=function(t,e,i){let s=Promise.resolve();if(e&&e.length>0){let n=function(l){return Promise.all(l.map(h=>Promise.resolve(h).then(g=>({status:"fulfilled",value:g}),g=>({status:"rejected",reason:g}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),c=(a==null?void 0:a.nonce)||(a==null?void 0:a.getAttribute("nonce"));s=n(e.map(l=>{if(l=ce(l),l in at)return;at[l]=!0;const h=l.endsWith(".css"),g=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${g}`))return;const y=document.createElement("link");if(y.rel=h?"stylesheet":le,h||(y.as="script"),y.crossOrigin="",y.href=l,c&&y.setAttribute("nonce",c),document.head.appendChild(y),h)return new Promise((yt,wt)=>{y.addEventListener("load",yt),y.addEventListener("error",()=>wt(new Error(`Unable to preload CSS for ${l}`)))})}))}function o(n){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=n,window.dispatchEvent(a),!a.defaultPrevented)throw n}return s.then(n=>{for(const a of n||[])a.status==="rejected"&&o(a.reason);return t().catch(o)})},S=class S{static async manifest(){if(!this.manifestPromise){if(!S.loadManifest)throw new Error("Manifest loader not found. Check glob pattern and file existence.");this.manifestPromise=S.loadManifest()}return this.manifestPromise}static async language(t){const e=`../data/lang/${t}.json`,i=S.langFiles[e];if(!i)throw new Error(`No language data file for '${t}'`);return i()}};S.manifestPromise=null,S.langFiles=Object.assign({"../data/lang/ja.json":()=>rt(()=>import("./ja-DEJkL8aw.js"),[]).then(t=>t.default)}),S.loadManifest=Object.assign({"../data/lang/index.json":()=>rt(()=>import("./index-BJLXKDTG.js"),[]).then(t=>t.default)})["../data/lang/index.json"];let W=S;const x=new u("Lang");class de{constructor(){var i;const t=L.get("kanaPop.lang"),e=typeof navigator<"u"?(i=navigator.language)==null?void 0:i.slice(0,2):void 0;this.defaultCode=t||e||"ja",this.lang={code:this.defaultCode,name:"loading…",symbols:[],direction:"ltr"},this.initialLoadPromise=new Promise(s=>{this.initialLoadResolve=s}),j.add(async()=>{x.info(`LanguageService: Starting initial load for language code '${this.defaultCode}'...`),await this.load(this.defaultCode),x.info("LanguageService: Initial load completed.")})}async load(t=this.defaultCode){const e=await W.manifest(),i=e.find(n=>n.code===t)??e.find(n=>n.code===this.defaultCode);if(!i)throw new Error("LanguageService: manifest empty");const s=await W.language(i.code);i.direction||x.warn(`'${i.code}' lacks "direction"; defaulting to 'ltr'`);const o=i.direction??"ltr";this.lang={code:i.code,name:i.name,symbols:s.symbols??[],direction:o},this.persistLang(this.lang.code),this.initialLoadResolve&&this.initialLoadResolve()}get symbols(){return this.lang.symbols}get currentCode(){return this.lang.code}get direction(){return this.lang.direction}randomGlyph(t){const e=Object.values(t.glyphs);return e.length===0?(x.warn(`Symbol with roman='${t.roman}' (category: ${t.category}, lang: ${this.lang.code}) has no glyphs defined. Returning '?' as fallback.`),"?"):e[Math.floor(Math.random()*e.length)]}persistLang(t){L.set("kanaPop.lang",t)}ready(){return this.initialLoadPromise}}const m=new de,d=new u("Sound"),G=class G{constructor(){this.bank=new re,this.isGestureArmed=!1,this.assetLoadCompletedPromise=new Promise(t=>{this.assetLoadCompletedResolve=t}),j.add(async()=>{d.info("SoundService: Waiting for LanguageService to be ready..."),await m.ready(),d.info("SoundService: LanguageService is ready. Starting sound preload...");const t=m.symbols.map(e=>`${m.currentCode}/${e.audio}`);if(t.length>0)try{await this.preloadAll(t),d.info(`SoundService: Successfully preloaded ${t.length} sounds for language '${m.currentCode}'.`)}catch(e){d.error("SoundService: Error during sound preloading.",e)}else d.info(`SoundService: No sounds to preload for language '${m.currentCode}'.`);this.assetLoadCompletedResolve()}),this.ready=new Promise(t=>this.triggerReady=t),typeof document<"u"&&document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&(d.debug("Page became visible – poking AudioContext"),this.bank.ensureContext().catch(()=>{}))})}async armFirstGesture(t=window){if(this.isGestureArmed)return;this.isGestureArmed=!0,d.info("First gesture handler armed");const e=O(),i=[],s=(a,c)=>{a.addEventListener(c,n,{passive:!0}),i.push({target:a,type:c})},o=()=>{d.info("Trimming audio unlock listeners (keeping one for re-unlock)");let a=!1;i.forEach(({target:c,type:l})=>{if(!a&&c===window&&l==="pointerdown"){a=!0;return}c.removeEventListener(l,n)})},n=async()=>{d.info("User gesture detected, unlocking audio");let a=!1;try{await this.bank.resume(),d.info("Audio context unlocked successfully"),a=!0}catch(c){d.warn("AudioContext unlock failed, trying HTML Audio fallback",c);try{const l=new Audio(G.SILENT);l.autoplay=!0,l.muted=!1,l.volume=.001,l.setAttribute("playsinline",""),d.info("Playing fallback HTML audio");const h=l.play();if(h instanceof Promise){await h,d.info("Fallback audio played successfully");try{await this.bank.resume(),d.info("Audio context unlocked after HTML audio fallback"),a=!0}catch(g){d.warn("Audio context still locked after HTML audio fallback",g)}}else d.warn("Fallback audio play() returned no promise")}catch(l){d.error("All audio unlock attempts failed",l)}}this.triggerReady(),a?o():d.warn("Audio still locked – listeners stay armed for another try")};d.info("Registering audio unlock gesture handlers"),s(t,"pointerdown"),s(t,"touchstart"),s(t,"click"),e&&(d.info("Adding extra handlers for iOS/iPadOS"),s(document.body,"pointerdown"),s(document.body,"touchstart"),s(document.body,"click"),s(document,"pointerdown"),s(document,"touchstart"),s(document,"click"),s(window,"pointerdown"),s(window,"touchstart"),s(window,"click"))}async play(t){if(await this.ready,t.endsWith("fallback.mp3"))return;const e=ot(`/kana-pop/audio/${t}`);try{const i=await this.bank.fetch(e);await this.bank.play(i)}catch(i){d.warn(`Web Audio playback failed for ${e}, using HTMLAudioElement fallback`,i),new Audio(e).play().catch(s=>{d.error(`HTMLAudioElement fallback also failed for ${e}`,s)})}}playRoman(t){var i;const e=(i=m.symbols.find(s=>s.roman===t))==null?void 0:i.audio;e&&this.play(`${m.currentCode}/${e}`)}async preloadAll(t){await this.ready,d.info(`Preloading ${t.length} audio files`),await Promise.all(t.map(e=>{if(e.endsWith("fallback.mp3"))return Promise.resolve();const i=ot(`/kana-pop/audio/${e}`);return this.bank.fetch(i).catch(s=>{d.warn(`Failed to preload audio: ${e}`,s)})})),d.info("Audio preloading complete")}assetsReady(){return this.assetLoadCompletedPromise}};G.SILENT="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAIlYAACJWAAABAAgAZGF0YQAAAAA=";let $=G;const pt=new $;function ot(r){return r.startsWith("data:")?r:`${r}?v=mbkpujis`}const lt=new u("Bubble");class he{constructor(t,e,i,s,o,n){this.x=t,this.y=e,this.color=i,this.glyph=s,this.romaji=o,this.active=!0,this.speed=.2,this._scale=1,this.animPhase="none",this.animTime=0,this.textScale=1,this.textOpacity=1,this.isTextTransitioning=!1,this.textTransitionTime=0,this.flashTimer=0,this.showingRomaji=!1,this.lastSpoken=-1/0,this.r=n,lt.debug("spawn",{x:this.x.toFixed(2),color:i,glyph:this.glyph})}handleClick(t){t-this.lastSpoken<Rt||(this.lastSpoken=t,Y.vibratePattern("pop").catch(()=>{}),this.triggerTapAnimation(),this.startTextTransition(),pt.playRoman(this.romaji),this.flashTimer=tt,lt.debug("toggle",{romaji:this.showingRomaji}))}triggerTapAnimation(){this.animPhase="squash",this.animTime=0,this.scale=1,this.textScale=T}startTextTransition(){this.isTextTransitioning=!0,this.textTransitionTime=et,this.textOpacity=0}step(t){switch(this.y-=this.speed*t,this.y<-.05&&(this.active=!1),this.animPhase){case"squash":if(this.animTime+=t,this.animTime>=D)this.animTime=0,this.animPhase="stretch",this.scale=T;else{const e=this.animTime/D;this.scale=R(1,T,V(e))}break;case"stretch":if(this.animTime+=t,this.animTime>=Q)this.animTime=0,this.animPhase="settle",this.scale=F;else{const e=this.animTime/Q;this.scale=R(T,F,V(e))}break;case"settle":if(this.animTime+=t,this.animTime>=q)this.animTime=0,this.animPhase="none",this.scale=1;else{const e=this.animTime/q;this.scale=R(F,1,V(e))}break}this.flashTimer>0&&(this.flashTimer-=t,this.flashTimer<0&&(this.flashTimer=0)),this.isTextTransitioning?(this.textTransitionTime-=t,this.textTransitionTime<=0?(this.showingRomaji=!this.showingRomaji,this.isTextTransitioning=!1,this.textOpacity=1,this.textScale=1):this.textOpacity=Math.max(0,this.textTransitionTime/et)):this.textScale<1&&(this.textScale=Math.min(1,this.textScale+t*5))}contains(t,e,i,s){if(!this.active)return!1;const o=this.x*i,n=this.y*s,a=t-o,c=e-n,l=a*a+c*c,h=this.r*this.scale;return l<=h*h}get flashAlpha(){return this.flashTimer>0?this.flashTimer/tt:0}get currentTextOpacity(){return this.textOpacity}get currentTextScale(){return this.textScale}get scale(){return this._scale}set scale(t){this._scale=t}}function R(r,t,e){return r+(t-r)*e}function V(r){return r<1?1-(1-r)*(1-r):1}function ct(r,t){return Math.min(r,t)*Nt}const ue=new u("BubbleMgr"),bt=r=>Math.floor(Math.random()*r),ge=()=>{const r=Wt();return r.length===0?"#ffffff":r[bt(r.length)]??"#ffffff"};class me{constructor(t){this.canvas=t,this.bubbles=[],this.spawnTimer=0,this.rPx=0;const{w:e,h:i}=b(t);this.rPx=ct(e,i)}get entities(){return this.bubbles}update(t){this.spawnTimer-=t,this.spawnTimer<=0&&(this.spawn(),this.spawnTimer=Et),this.bubbles.forEach(e=>e.step(t)),this.bubbles.some(e=>!e.active)&&(this.bubbles=this.bubbles.filter(e=>e.active))}handleResize(){const{w:t,h:e}=b(this.canvas);this.rPx=ct(t,e),this.bubbles.forEach(i=>i.r=this.rPx)}hitTest(t,e){const{w:i,h:s}=b(this.canvas);for(let o=this.bubbles.length-1;o>=0;o--){const n=this.bubbles[o];if(n&&n.contains(t,e,i,s))return n}}clear(){this.bubbles=[]}spawn(){var a;if(!((a=m.symbols)!=null&&a.length))return;const t=m.symbols[bt(m.symbols.length)],e=m.randomGlyph(t),{w:i}=b(this.canvas),s=this.rPx/i,o=s+Math.random()*(1-2*s),n=1+s;this.bubbles.push(new he(o,n,ge(),e,t.roman,this.rPx)),ue.debug("spawn",{total:this.bubbles.length,roman:t.roman})}}class fe{render(t,e,i,s,o){const n=e.x*i,a=e.y*s,c=e.r*e.scale;t.save(),t.globalAlpha=Tt,t.fillStyle=e.color,t.beginPath(),t.beginPath(),t.arc(n,a,c,0,Math.PI*2),t.fill(),t.restore();const l=e.showingRomaji?e.romaji:e.glyph,h=e.showingRomaji?Pt:Ft,g=Math.round(e.r*e.currentTextScale*h);t.save(),t.fillStyle=Bt,t.globalAlpha=e.currentTextOpacity,t.textAlign="center",t.textBaseline="middle",t.font=`${g}px ${Gt}`,t.fillText(l,n,a),t.restore(),e.flashAlpha>0&&(t.save(),t.globalAlpha=e.flashAlpha*Vt,t.lineWidth=it,t.strokeStyle="#ffffff",t.beginPath(),t.arc(n,a,c+it*.5,0,Math.PI*2),t.stroke(),t.restore())}}const pe=new u("Pointer");class be{constructor(t,e){this.canvas=t,this.bubbles=e,this.bound=this.onDown.bind(this)}attach(){this.canvas.addEventListener("pointerdown",this.bound)}detach(){this.canvas.removeEventListener("pointerdown",this.bound)}onDown(t){var n,a;const e=this.canvas.getBoundingClientRect(),i="clientX"in t?t.clientX:((n=t.touches[0])==null?void 0:n.clientX)??0,s="clientY"in t?t.clientY:((a=t.touches[0])==null?void 0:a.clientY)??0,o=this.bubbles.hitTest(i-e.left,s-e.top);o&&(o.handleClick(performance.now()/1e3),pe.debug("hit",{roman:o.romaji}))}}class ye extends ft{constructor(){super(...arguments),this.bubbles=new me(this.ctx.canvas),this.renderer=new fe,this.input=new be(this.ctx.canvas,this.bubbles)}async enter(){await super.enter(),this.bubbles.handleResize(),this.input.attach()}update(t){const{w:e,h:i}=b(this.ctx.canvas);this.ctx.clearRect(0,0,e,i),_(this.ctx),this.bubbles.update(t),this.bubbles.entities.forEach(s=>this.renderer.render(this.ctx,s,e,i))}exit(){this.input.detach(),this.bubbles.clear(),super.exit()}paint(){}}let f=null,Z=null;const K=document.querySelector("#game");if(!K)throw new Error("#game canvas not found");const X=K.getContext("2d");if(!X)throw new Error("2-D context not available");const J=document.createElement("canvas");J.id="bg";document.body.prepend(J);function U(){document.documentElement.style.setProperty("--app-height",`${window.innerHeight}px`)}document.readyState==="loading"?window.addEventListener("DOMContentLoaded",U,{once:!0}):U();window.addEventListener("resize",U);pt.armFirstGesture(window);I.watchCanvas(K);(async()=>{const r=L.get("kanaPop.theme")??"assets/themes/pastel-pond/";await z.load(r),f=new Qt,f.add("home",new se(f,X)).add("play",new ye(f,X)),Z=new Jt(J),await f.change("home"),j.run(()=>{}).catch(console.error),E=performance.now(),k=requestAnimationFrame(B)})();let k=0,E=performance.now();function B(r){const t=(r-E)/1e3;E=r,Z==null||Z.paint(t),f==null||f.update(t),k=requestAnimationFrame(B)}document.addEventListener("visibilitychange",()=>{document.hidden?cancelAnimationFrame(k):(E=performance.now(),k=requestAnimationFrame(B))});document.addEventListener("scenechange",r=>{const{nextScene:t}=r.detail;f&&f.change(t),E=performance.now(),k=requestAnimationFrame(B)});
