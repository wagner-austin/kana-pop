(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}})();function y(o){const{clientWidth:t,clientHeight:e}=o;return{w:t,h:e}}function ft(){return window.devicePixelRatio||1}function q(o){const t=ft();o.setTransform(1,0,0,1,0,0),o.scale(t,t)}function xt(o){const t=ft(),{w:e,h:s}=y(o);return o.width=Math.round(e*t),o.height=Math.round(s*t),{w:e,h:s,dpr:t}}class kt{constructor(){this.listeners=new Set,this.watchedCanvases=new Map,this.mediaQuery=null,this.boundTrigger=this.trigger.bind(this),this.dprCallback=null,this.metrics={w:0,h:0,dpr:1}}subscribe(t){this.listeners.add(t),t(),this.listeners.size===1&&this.attachWindowListeners()}unsubscribe(t){this.listeners.delete(t),this.listeners.size===0&&this.detachWindowListeners()}watchCanvas(t){const e=()=>{const s=xt(t);this.metrics=s};this.watchedCanvases.set(t,e),this.subscribe(e)}unwatchCanvas(t){const e=this.watchedCanvases.get(t);e&&(this.unsubscribe(e),this.watchedCanvases.delete(t))}trigger(){this.listeners.forEach(t=>t())}attachWindowListeners(){typeof window<"u"&&(window.addEventListener("resize",this.boundTrigger),this.addDprListener())}detachWindowListeners(){var t;typeof window<"u"&&window.removeEventListener("resize",this.boundTrigger),this.dprCallback&&((t=this.mediaQuery)==null||t.removeEventListener("change",this.dprCallback)),this.mediaQuery=null,this.dprCallback=null}addDprListener(){var t;typeof window>"u"||typeof window.matchMedia>"u"||(this.dprCallback&&((t=this.mediaQuery)==null||t.removeEventListener("change",this.dprCallback)),this.mediaQuery=matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`),this.dprCallback=()=>{this.boundTrigger(),this.addDprListener()},this.mediaQuery.addEventListener("change",this.dprCallback,{once:!0}))}get cssWidth(){return this.metrics.w}get cssHeight(){return this.metrics.h}get dpr(){return this.metrics.dpr}}const x=new kt,Ct="/kana-pop/assets/background-D-U8xQFM.png",Pt="/kana-pop/assets/background1-Bjf-n90B.png",Lt="/kana-pop/assets/background-D-U8xQFM.png",_t="/kana-pop/assets/background_vertical-3wb079fu.png",It="data:application/json;base64,WyIjRkZEMURDIiwgIiNCNUVBRDciLCAiI0M3Q0VFQSIsICIjRkZEQUMxIiwgIiNFMkYwQ0IiXQo=",$t="data:application/json;base64,ewogICJuYW1lIjogIlBhc3RlbCBQb25kIiwKICAiYXNzZXRzIjogeyAicGFsZXR0ZSI6ICJwYWxldHRlLmpzb24iIH0sCiAgImVmZmVjdCI6IHsKICAgICJ0eXBlIjogImltYWdlIiwKICAgICJob3Jpem9udGFsIjogImJhY2tncm91bmRfaG9yaXpvbnRhbC5wbmciLAogICAgInZlcnRpY2FsIjogImJhY2tncm91bmRfdmVydGljYWwucG5nIgogIH0KfQo=",gt="Pastel Pond",mt={palette:"palette.json"},pt={type:"image",horizontal:"background_horizontal.png",vertical:"background_vertical.png"},Rt={name:gt,assets:mt,effect:pt},Mt=Object.freeze(Object.defineProperty({__proto__:null,assets:mt,default:Rt,effect:pt,name:gt},Symbol.toStringTag,{value:"Module"})),Ot=["#FFD1DC","#B5EAD7","#C7CEEA","#FFDAC1","#E2F0CB"],Bt=Object.freeze(Object.defineProperty({__proto__:null,default:Ot},Symbol.toStringTag,{value:"Module"})),Ht=1.2,jt=.36,zt=["#ffaaa5","#ffd3b6","#c7ceea","#e2f0cb","#b5ead7"];let bt=null;function Dt(o){bt=o}function Nt(){return bt??zt}const K="#222",Ft="Noto Sans JP, sans-serif",Ut=K,Wt=.1,Vt=.85,Gt=.65,Qt=.4,H=50,et=.08,st=.1,it=.14,L=.85,j=1.2,nt=0,at=.15,Yt=.6,z=4,Xt="__kanaPopDebug_",qt=40,Kt=60,Jt=250,Zt=!0,S=class S{constructor(t,e=S.bootLevel){this.scope=t,this.level=e}out(t,...e){}debug(...t){this.out("debug",...t)}info(...t){this.out("info",...t)}warn(...t){this.out("warn",...t)}error(...t){this.out("error",...t)}};S.bootLevel=(()=>{if(typeof globalThis>"u"||!("localStorage"in globalThis))return"info";const t=localStorage.getItem("logLevel");return t&&["debug","info","warn","error","off"].includes(t)?t:"info"})(),S.isDebug=S.bootLevel==="debug",S.levelOrder={debug:0,info:1,warn:2,error:3,off:4};let f=S;function te(){return{setLevel(o){localStorage.setItem("logLevel",o),location.reload()}}}typeof window<"u"&&(window.logger=te());const A=class A{constructor(t){this.ready=!1,this.imgHorizontal=null,this.imgVertical=null,this.loadedHorizontal=!1,this.loadedVertical=!1,typeof window<"u"?(this.imgHorizontal=new Image,this.imgHorizontal.onload=()=>{var e;A.log.debug(`Loaded horizontal image: ${(e=this.imgHorizontal)==null?void 0:e.src}`),this.loadedHorizontal=!0,this.updateReadyState()},this.imgHorizontal.onerror=()=>{var e;this.loadedHorizontal=!1,A.log.error(`Failed to load horizontal image: ${(e=this.imgHorizontal)==null?void 0:e.src}`),this.updateReadyState()},this.imgHorizontal.src=t.horizontal,this.imgVertical=new Image,this.imgVertical.onload=()=>{var e;A.log.debug(`Loaded vertical image: ${(e=this.imgVertical)==null?void 0:e.src}`),this.loadedVertical=!0,this.updateReadyState()},this.imgVertical.onerror=()=>{var e;this.loadedVertical=!1,A.log.error(`Failed to load vertical image: ${(e=this.imgVertical)==null?void 0:e.src}`),this.updateReadyState()},this.imgVertical.src=t.vertical):this.ready=!0}resize(){}updateReadyState(){this.ready=this.loadedHorizontal||this.loadedVertical}update(t,e){if(!this.ready)return!1;const s=e.canvas.width,i=e.canvas.height,r=s/i;let n=null;if(r>=1?n=this.loadedHorizontal?this.imgHorizontal:this.imgVertical:n=this.loadedVertical?this.imgVertical:this.imgHorizontal,!n||!n.complete||n.naturalWidth===0)return!1;const a=n.naturalWidth/n.naturalHeight;let l,c,d=0,u=0;return a>r?(c=i,l=c*a,d=(s-l)/2):(l=s,c=l/a,u=(i-c)/2),e.drawImage(n,d,u,l,c),!0}};A.log=new f("ImageEffect");let U=A;class ee{constructor(t){this.vid=null,typeof document<"u"&&typeof window<"u"&&(this.vid=document.createElement("video"),this.vid.src=t,this.vid.autoplay=!0,this.vid.loop=!0,this.vid.muted=!0,this.vid.style.position="fixed",this.vid.style.top="0",this.vid.style.left="0",this.vid.style.width="100%",this.vid.style.height="100%",this.vid.style.objectFit="cover",this.vid.style.zIndex="-1",document.body.appendChild(this.vid))}resize(){}update(t,e){return!1}dispose(){this.vid&&this.vid.parentNode&&(this.vid.parentNode.removeChild(this.vid),this.vid=null)}}const T=new f("ShaderEffect");class se{constructor(t){this.container=null,this.shaderConfig=t,T.debug(`ShaderEffect created with config: ${this.shaderConfig}`)}mount(t){this.container=t;const e=document.createElement("div");e.style.width="100%",e.style.height="100%",e.style.backgroundColor="rgba(50, 0, 50, 0.8)",e.textContent=`Shader Effect: ${this.shaderConfig}`,e.style.color="white",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",this.container.appendChild(e),T.debug("ShaderEffect mounted. Config:",this.shaderConfig)}unmount(){if(this.container){for(;this.container.firstChild;)this.container.removeChild(this.container.firstChild);T.debug("ShaderEffect unmounted.")}this.container=null}resize(t,e,s){T.debug(`ShaderEffect resize called: ${t}x${e} @ ${s}x`)}update(t,e){return T.debug(`ShaderEffect update called with dt: ${t}`),!1}}class ie{constructor(t){this.cls=t,document.body.classList.add(t)}resize(){}update(){return!1}dispose(){document.body.classList.remove(this.cls)}}const rt=Object.assign({"../assets/themes/pastel-pond/background.png":Ct,"../assets/themes/pastel-pond/background1.png":Pt,"../assets/themes/pastel-pond/background_horizontal.png":Lt,"../assets/themes/pastel-pond/background_vertical.png":_t,"../assets/themes/pastel-pond/palette.json":It,"../assets/themes/pastel-pond/theme.json":$t}),ot=Object.assign({"../assets/themes/pastel-pond/theme.json":Mt}),ne=Object.assign({"../assets/themes/pastel-pond/palette.json":Bt});class ae{async load(t){const e=`../${t.endsWith("/")?t:t+"/"}theme.json`.replace(/^\.\.\/\/+/,"../"),s=ot[e];if(!s)throw new Error(`Theme manifest not embedded for base '${t}'. Tried key '${e}'. Available MANIFESTS keys: ${Object.keys(ot).join(", ")}`);const i=s.assets.palette.startsWith("/")?s.assets.palette.substring(1):s.assets.palette,r=`../${t.endsWith("/")?t:t+"/"}${i}`.replace(/^\.\.\/\/+/,"../"),n=ne[r]??["#ffffff"],a=await this.makeEffect(s.effect,t);return this.current={name:s.name,palette:n,effect:a},Dt(n),this.current}get theme(){return this.current}async makeEffect(t,e){const s=e.replace(/^assets\/themes\//,"").replace(/\/$/,"");function i(r){const n=`../assets/themes/${s}/${r}`,a=rt[n];if(a===void 0)throw console.error(`[ThemeService] Asset URL not found for key: ${n}`),console.error("[ThemeService] Attempted to load file:",r,"from theme folder:",s),console.error("[ThemeService] Available keys from glob:",Object.keys(rt)),new Error(`Asset URL not found by viteAssetUrl: ${n}. Check theme.json and asset paths.`);return a}if(t.type==="image"){const r=i(t.horizontal),n=i(t.vertical);return new U({horizontal:r,vertical:n})}else if(t.type==="video"){const r=i(t.file);return new ee(r)}else if(t.type==="script")try{const a=(await import(`/src/assets/themes/${s}/${t.file}`))[t.export];if(typeof a=="function")return new a(e);throw new Error(`Export "${t.export}" from script "${t.file}" is not a constructor.`)}catch(r){throw console.error(`Failed to load script effect "${t.file}":`,r),r}else{if(t.type==="shader")return new se(t.shader);if(t.type==="css")return new ie(t.class);{const r=t;throw new Error(`ThemeService: unknown effect type: ${JSON.stringify(r)}`)}}}}const W=new ae;class re{constructor(t){this.canvas=t,this.time=0;const e=t.getContext("2d");if(!e)throw new Error("2-D context not available");this.ctx=e,x.watchCanvas(t),x.subscribe(()=>this.paint(0))}paint(t){var i,r,n;this.time+=t,q(this.ctx);const e=window.devicePixelRatio||1;if(this.ctx.save(),this.ctx.scale(1/e,1/e),!((r=(i=W.theme)==null?void 0:i.effect)==null?void 0:r.update(t,this.ctx))){const{w:a,h:l}=y(this.canvas);this.ctx.fillStyle=((n=W.theme)==null?void 0:n.palette[2])??"#c7ceea",this.ctx.fillRect(0,0,a,l)}this.ctx.restore()}}const oe=new f("SM");class le{constructor(){this.states=new Map,this.stack=[]}add(t,e){return this.states.set(t,e),this}async change(t){var e,s;oe.info("→ change",{from:this.currentName,to:t}),(e=this.current)!=null&&e.exit&&this.current.exit(),this.current=this.states.get(t),this.currentName=t,(s=this.current)!=null&&s.enter&&await this.current.enter()}update(t){var e,s;(s=(e=this.current)==null?void 0:e.update)==null||s.call(e,t)}get currentStateName(){return this.currentName}async push(t){var e;this.current&&(this.stack.push(this.current),this.current.exit&&this.current.exit()),this.current=this.states.get(t),this.currentName=t,(e=this.current)!=null&&e.enter&&await this.current.enter()}async pop(){var t,e,s;this.stack.length&&((t=this.current)!=null&&t.exit&&this.current.exit(),this.current=this.stack.pop(),this.currentName=this.current?(e=[...this.states.entries()].find(([,i])=>i===this.current))==null?void 0:e[0]:void 0,(s=this.current)!=null&&s.enter&&await this.current.enter())}}class yt{constructor(t,e){this.resizeHandler=this.paint.bind(this),this.sm=t,this.ctx=e}async enter(){x.subscribe(this.resizeHandler),this.paint()}update(t){}exit(){x.unsubscribe(this.resizeHandler)}clear(){const{w:t,h:e}=y(this.ctx.canvas);return this.ctx.clearRect(0,0,t,e),q(this.ctx),{w:t,h:e}}}const ce={pop:50,error:[50,100,50],success:[50,50,50,50,100],gameOver:[100,50,100,50,300]},D=new f("Storage");class he{constructor(){this.isNative=!1,this.storage=this.detectStorage()}detectStorage(){if(typeof window<"u"&&typeof localStorage=="object")try{const t="__storage_test__";return localStorage.setItem(t,t),localStorage.removeItem(t),D.debug("Using native localStorage"),this.isNative=!0,localStorage}catch(t){D.warn("localStorage detected but unavailable (Safari private mode?), using memory storage",t)}else D.info("No localStorage available (Node/test environment), using memory storage");return new Map}get(t){if(this.isNative)return this.storage.getItem(t);const e=this.storage;return e.has(t)?e.get(t):null}set(t,e){this.isNative?this.storage.setItem(t,e):this.storage.set(t,e)}remove(t){this.isNative?this.storage.removeItem(t):this.storage.delete(t)}clear(){this.isNative?this.storage.clear():this.storage.clear()}}const k=new he,b=new f("Haptics");class de{constructor(){if(this.enabled=k.get("kanaPop.haptics")!=="false"&&Zt,this.debugElement=null,this.lastVibration=0,this.patternArraysOkay=null,!(typeof window>"u"||typeof navigator>"u")){if(window.matchMedia("(prefers-reduced-motion: reduce)").matches){b.info("Haptics disabled due to reduced-motion preference.");return}if(typeof navigator.vibrate=="function"){this.enabled=!0,b.info("Haptic feedback enabled.");const t=()=>{this.updateDebugStatus("Activation gesture received (resume only)")};window.addEventListener("pointerdown",t,{once:!0,passive:!0})}else b.info("Haptic feedback not supported on this device.")}}async vibrate(t=50,e=2){if(!this.enabled)return Promise.resolve(!1);if(this.patternArraysOkay===null)try{navigator.vibrate([1,1])?(navigator.vibrate(0),this.patternArraysOkay=!0,this.updateDebugStatus("Array patterns seem supported.")):(this.patternArraysOkay=!1,this.updateDebugStatus("Array patterns rejected (vibrate returned false)."))}catch(a){this.patternArraysOkay=!1,this.updateDebugStatus(`Array patterns rejected (vibrate threw error: ${a instanceof Error?a.message:String(a)}).`)}const s=Date.now(),i=Array.isArray(t),r=i?Jt:Kt;if(s-this.lastVibration<r)return this.updateDebugStatus(`Throttled (gap: ${r}ms)`),Promise.resolve(!1);let n;if(i)n=t.map(a=>Math.max(a,H)),!this.patternArraysOkay&&n.length>0&&(n=Math.max(...n,H),this.updateDebugStatus("Collapsed array to single max pulse for compatibility."));else{const a=Math.max(t,H),l=qt;switch(e){case 1:n=a;break;case 2:n=Math.min(a*1.5,150);break;case 3:n=this.patternArraysOkay?[a,l,a]:a*2;break;default:return b.warn(`Invalid intensity: ${e} for numeric pattern.`),Promise.resolve(!1)}}try{return Array.isArray(n)&&n.length===0?(b.warn("Attempted to vibrate with an empty pattern array."),Promise.resolve(!1)):typeof n=="number"&&n===0&&t!==0?(b.warn("Calculated vibration duration is zero, skipping."),Promise.resolve(!1)):navigator.vibrate(n)?(this.lastVibration=s,this.updateDebugStatus(`Vibrated: ${JSON.stringify(n)}`),b.info("Vibrating with:",{originalPattern:t,intensity:e,actualVibration:n}),Promise.resolve(!0)):(this.updateDebugStatus("navigator.vibrate() returned false."),b.warn("navigator.vibrate() returned false for pattern:",n),Promise.resolve(!1))}catch(a){return b.warn("Vibration failed with error:",a),this.updateDebugStatus(`Failed: ${a instanceof Error?a.message:String(a)}`),Array.isArray(n)&&this.patternArraysOkay&&(this.patternArraysOkay=!1,this.updateDebugStatus("Error with array vibration, marked arrays as not okay for future.")),Promise.resolve(!1)}}isSupported(){return this.enabled}createDebugElement(){var e;if(typeof document>"u")return;const t=`${Xt}Haptics`;(e=document.getElementById(t))==null||e.remove(),this.debugElement=document.createElement("div"),this.debugElement.id=t,this.debugElement.style.position="fixed",this.debugElement.style.bottom="30px",this.debugElement.style.left="10px",this.debugElement.style.background="rgba(0,0,0,0.5)",this.debugElement.style.color="white",this.debugElement.style.padding="5px",this.debugElement.style.fontSize="12px",this.debugElement.style.zIndex="9999",this.debugElement.style.pointerEvents="none",document.body.appendChild(this.debugElement)}updateDebugStatus(t){this.debugElement&&(this.debugElement.textContent=`Haptics: ${t}`)}vibratePattern(t){const e=ce[t];return typeof e=="number"?this.vibrate(e):this.vibrate([...e])}setEnabled(t){this.enabled=t,k.set("kanaPop.haptics",String(t)),t||navigator.vibrate(0)}isEnabled(){return this.enabled}}const V=new de;class ue{constructor(t){this.onClose=t,this.overlay=document.createElement("div"),this.overlay.style.cssText=`
      position:fixed;inset:0;background:rgba(0,0,0,.6);
      color:${K};display:flex;flex-direction:column;
      align-items:center;justify-content:center;
      font:18px sans-serif;z-index:50`,this.overlay.innerHTML=`
      <h2 style="margin:0 0 20px">Settings</h2>
      <label style="margin-bottom:15px;display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="hapticsToggle">
        Haptics
      </label>
      <button id="close">Close</button>`,this.overlay.querySelector("#close").addEventListener("click",()=>this.toggle());const e=this.overlay.querySelector("#hapticsToggle");e.addEventListener("change",()=>{V.setEnabled(e.checked)})}toggle(){document.body.contains(this.overlay)?this.hide():this.show()}show(){document.body.appendChild(this.overlay);const t=this.overlay.querySelector("#hapticsToggle");t.checked=V.isEnabled()}hide(){this.overlay.remove(),this.onClose()}}class fe extends yt{constructor(){super(...arguments),this.settings=new ue(()=>{}),this.enter=async()=>{document.body.dataset.scene="home",await super.enter(),window.addEventListener("pointerdown",this.onTap)},this.exit=()=>{window.removeEventListener("pointerdown",this.onTap),this.settings.hide(),delete document.body.dataset.scene,super.exit()},this.onTap=t=>{const{w:e,h:s}=y(this.ctx.canvas),{offsetX:i,offsetY:r}=t;i>e-60&&r>s-60?this.settings.toggle():this.sm.change("play")}}paint(){const{w:t,h:e}=this.clear();this.ctx.fillStyle=K,this.ctx.textAlign="center",this.ctx.font="32px sans-serif",this.ctx.fillText("Tap to Start",t/2,e/2),this.ctx.font="20px sans-serif",this.ctx.fillText("⚙︎",t-30,e-30)}}function ge(){if(typeof navigator>"u")return!1;const o=typeof navigator>"u"?"":navigator.userAgent;return/iPad|iPhone|iPod/.test(o)&&!(typeof window<"u"&&window.MSStream)}function me(){if(typeof navigator>"u")return!1;const o=typeof navigator>"u"?"":navigator.userAgent;return/iPad/.test(o)||typeof navigator<"u"&&navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1}function G(){if(typeof navigator>"u")return!1;if(ge()||me())return!0;const o=typeof navigator>"u"?"":navigator.userAgent;return!!(/iPad|iPhone|iPod/.test(o)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>0)}const w=new f("Audio");class pe{constructor(){this.bank=new Map}async ensureContext(){const t=()=>{const e=globalThis,s=e.AudioContext??e.webkitAudioContext;if(!s)throw new Error("Web Audio API not supported");const i=new s;return w.info(`Created new AudioContext: ${i.state}`),i};if((!this.ctx||this.ctx.state==="closed")&&(this.ctx=t()),this.ctx.state==="suspended"||this.ctx.state==="interrupted"){w.info(`Attempting resume() from ${this.ctx.state}`);try{await this.ctx.resume()}catch(e){w.warn("resume() threw",e)}}if(this.ctx.state!=="running"){w.warn(`AudioContext stuck in '${this.ctx.state}', recreating…`);try{await this.ctx.close()}catch{}this.ctx=t(),await this.ctx.resume()}return this.ctx}async fetch(t){if(this.bank.has(t))return this.bank.get(t);try{const e=await(await fetch(t)).arrayBuffer(),i=await(await this.ensureContext()).decodeAudioData(e);return this.bank.set(t,i),i}catch(e){throw w.error(`decodeAudioData failed for ${t}`,e),e}}async play(t){const e=await this.ensureContext(),s=e.createBufferSource();s.buffer=t,s.connect(e.destination),s.start(),s.onended=()=>s.disconnect()}async resume(){try{const t=await this.ensureContext();if(G()){w.info("iOS/iPadOS detected, playing silent buffer to unlock audio");const e=t.sampleRate||44100,s=t.createBuffer(2,e*.5,e);for(let a=0;a<2;a++){const l=s.getChannelData(a);for(let c=0;c<l.length;c++)l[c]=0}const i=G()?.5:.1,r=t.createGain();r.gain.value=.001;const n=t.createBufferSource();n.buffer=s,n.connect(r),r.connect(t.destination),n.start(0),n.stop(t.currentTime+i),n.onended=()=>{n.disconnect(),r.disconnect()},w.info(`Silent buffer played (duration: ${i}s)`)}return t}catch(t){throw w.error("Resume failed",t),t}}}class be{constructor(){this.tasks=[]}add(t){this.tasks.push(t)}async run(t,e=!0){if(this.tasks.length===0){t(1);return}if(e){let s=0;await Promise.all(this.tasks.map(i=>i().then(()=>{t(++s/this.tasks.length)})))}else for(let s=0;s<this.tasks.length;s++){const i=this.tasks[s];await i(),t((s+1)/this.tasks.length)}this.tasks=[]}}const J=new be,ye="modulepreload",we=function(o){return"/kana-pop/"+o},lt={},ct=function(t,e,s){let i=Promise.resolve();if(e&&e.length>0){let n=function(c){return Promise.all(c.map(d=>Promise.resolve(d).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),l=(a==null?void 0:a.nonce)||(a==null?void 0:a.getAttribute("nonce"));i=n(e.map(c=>{if(c=we(c),c in lt)return;lt[c]=!0;const d=c.endsWith(".css"),u=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${u}`))return;const g=document.createElement("link");if(g.rel=d?"stylesheet":ye,d||(g.as="script"),g.crossOrigin="",g.href=c,l&&g.setAttribute("nonce",l),document.head.appendChild(g),d)return new Promise((E,O)=>{g.addEventListener("load",E),g.addEventListener("error",()=>O(new Error(`Unable to preload CSS for ${c}`)))})}))}function r(n){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=n,window.dispatchEvent(a),!a.defaultPrevented)throw n}return i.then(n=>{for(const a of n||[])a.status==="rejected"&&r(a.reason);return t().catch(r)})},v=class v{static async manifest(){if(!this.manifestPromise){if(!v.loadManifest)throw new Error("Manifest loader not found. Check glob pattern and file existence.");this.manifestPromise=v.loadManifest()}return this.manifestPromise}static async language(t){const e=`../data/lang/${t}.json`,s=v.langFiles[e];if(!s)throw new Error(`No language data file for '${t}'`);return s()}};v.manifestPromise=null,v.langFiles=Object.assign({"../data/lang/ja.json":()=>ct(()=>import("./ja-DEJkL8aw.js"),[]).then(t=>t.default)}),v.loadManifest=Object.assign({"../data/lang/index.json":()=>ct(()=>import("./index-BJLXKDTG.js"),[]).then(t=>t.default)})["../data/lang/index.json"];let $=v;const _=new f("Lang");class ve{constructor(){var s;const t=k.get("kanaPop.lang"),e=typeof navigator<"u"?(s=navigator.language)==null?void 0:s.slice(0,2):void 0;this.defaultCode=t||e||"ja",this.lang={code:this.defaultCode,name:"loading…",symbols:[],direction:"ltr"},this.initialLoadPromise=new Promise(i=>{this.initialLoadResolve=i}),J.add(async()=>{_.info(`LanguageService: Starting initial load for language code '${this.defaultCode}'...`),await this.load(this.defaultCode),_.info("LanguageService: Initial load completed.")})}async load(t=this.defaultCode){const e=await $.manifest(),s=e.find(n=>n.code===t)??e.find(n=>n.code===this.defaultCode);if(!s)throw new Error("LanguageService: manifest empty");const i=await $.language(s.code);s.direction||_.warn(`'${s.code}' lacks "direction"; defaulting to 'ltr'`);const r=s.direction??"ltr";this.lang={code:s.code,name:s.name,symbols:i.symbols??[],direction:r},this.persistLang(this.lang.code),this.initialLoadResolve&&this.initialLoadResolve()}get symbols(){return this.lang.symbols}get currentCode(){return this.lang.code}get direction(){return this.lang.direction}randomGlyph(t){const e=Object.values(t.glyphs);return e.length===0?(_.warn(`Symbol with roman='${t.roman}' (category: ${t.category}, lang: ${this.lang.code}) has no glyphs defined. Returning '?' as fallback.`),"?"):e[Math.floor(Math.random()*e.length)]}persistLang(t){k.set("kanaPop.lang",t)}ready(){return this.initialLoadPromise}}const m=new ve,h=new f("Sound"),R=class R{constructor(){this.bank=new pe,this.isGestureArmed=!1,this.assetLoadCompletedPromise=new Promise(t=>{this.assetLoadCompletedResolve=t}),J.add(async()=>{h.info("SoundService: Waiting for LanguageService to be ready..."),await m.ready(),h.info("SoundService: LanguageService is ready. Starting sound preload...");const t=m.symbols.map(e=>`${m.currentCode}/${e.audio}`);if(t.length>0)try{await this.preloadAll(t),h.info(`SoundService: Successfully preloaded ${t.length} sounds for language '${m.currentCode}'.`)}catch(e){h.error("SoundService: Error during sound preloading.",e)}else h.info(`SoundService: No sounds to preload for language '${m.currentCode}'.`);this.assetLoadCompletedResolve()}),this.ready=new Promise(t=>this.triggerReady=t),typeof document<"u"&&document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&(h.debug("Page became visible – poking AudioContext"),this.bank.ensureContext().catch(()=>{}))})}async armFirstGesture(t=window){if(this.isGestureArmed)return;this.isGestureArmed=!0,h.info("First gesture handler armed");const e=G(),s=[],i=(a,l)=>{a.addEventListener(l,n,{passive:!0}),s.push({target:a,type:l})},r=()=>{h.info("Trimming audio unlock listeners (keeping one for re-unlock)");let a=!1;s.forEach(({target:l,type:c})=>{if(!a&&l===window&&c==="pointerdown"){a=!0;return}l.removeEventListener(c,n)})},n=async()=>{h.info("User gesture detected, unlocking audio");let a=!1;try{await this.bank.resume(),h.info("Audio context unlocked successfully"),a=!0}catch(l){h.warn("AudioContext unlock failed, trying HTML Audio fallback",l);try{const c=new Audio(R.SILENT);c.autoplay=!0,c.muted=!1,c.volume=.001,c.setAttribute("playsinline",""),h.info("Playing fallback HTML audio");const d=c.play();if(d instanceof Promise){await d,h.info("Fallback audio played successfully");try{await this.bank.resume(),h.info("Audio context unlocked after HTML audio fallback"),a=!0}catch(u){h.warn("Audio context still locked after HTML audio fallback",u)}}else h.warn("Fallback audio play() returned no promise")}catch(c){h.error("All audio unlock attempts failed",c)}}this.triggerReady(),a?r():h.warn("Audio still locked – listeners stay armed for another try")};h.info("Registering audio unlock gesture handlers"),i(t,"pointerdown"),i(t,"touchstart"),i(t,"click"),e&&(h.info("Adding extra handlers for iOS/iPadOS"),i(document.body,"pointerdown"),i(document.body,"touchstart"),i(document.body,"click"),i(document,"pointerdown"),i(document,"touchstart"),i(document,"click"),i(window,"pointerdown"),i(window,"touchstart"),i(window,"click"))}async play(t){if(await this.ready,t.endsWith("fallback.mp3"))return;const e=ht(`/kana-pop/audio/${t}`);try{const s=await this.bank.fetch(e);await this.bank.play(s)}catch(s){h.warn(`Web Audio playback failed for ${e}, using HTMLAudioElement fallback`,s),new Audio(e).play().catch(i=>{h.error(`HTMLAudioElement fallback also failed for ${e}`,i)})}}playRoman(t){var s;const e=(s=m.symbols.find(i=>i.roman===t))==null?void 0:s.audio;e&&this.play(`${m.currentCode}/${e}`)}async preloadAll(t){await this.ready,h.info(`Preloading ${t.length} audio files`),await Promise.all(t.map(e=>{if(e.endsWith("fallback.mp3"))return Promise.resolve();const s=ht(`/kana-pop/audio/${e}`);return this.bank.fetch(s).catch(i=>{h.warn(`Failed to preload audio: ${e}`,i)})})),h.info("Audio preloading complete")}assetsReady(){return this.assetLoadCompletedPromise}};R.SILENT="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAIlYAACJWAAABAAgAZGF0YQAAAAA=";let Q=R;const wt=new Q;function ht(o){return o.startsWith("data:")?o:`${o}?v=mbkstthv`}const dt=new f("Bubble");class Se{constructor(t,e,s,i,r,n){this.x=t,this.y=e,this.color=s,this.glyph=i,this.romaji=r,this.active=!0,this.speed=.2,this._scale=1,this.animPhase="none",this.animTime=0,this.textScale=1,this.textOpacity=1,this.isTextTransitioning=!1,this.textTransitionTime=0,this.flashTimer=0,this.showingRomaji=!1,this.lastSpoken=-1/0,this.r=n,dt.debug("spawn",{x:this.x.toFixed(2),color:s,glyph:this.glyph})}handleClick(t){t-this.lastSpoken<Qt||(this.lastSpoken=t,V.vibratePattern("pop").catch(()=>{}),this.triggerTapAnimation(),this.startTextTransition(),wt.playRoman(this.romaji),this.flashTimer=nt,dt.debug("toggle",{romaji:this.showingRomaji}))}triggerTapAnimation(){this.animPhase="squash",this.animTime=0,this.scale=1,this.textScale=L}startTextTransition(){this.isTextTransitioning=!0,this.textTransitionTime=at,this.textOpacity=0}step(t){switch(this.y-=this.speed*t,this.y<-.05&&(this.active=!1),this.animPhase){case"squash":if(this.animTime+=t,this.animTime>=et)this.animTime=0,this.animPhase="stretch",this.scale=L;else{const e=this.animTime/et;this.scale=N(1,L,F(e))}break;case"stretch":if(this.animTime+=t,this.animTime>=st)this.animTime=0,this.animPhase="settle",this.scale=j;else{const e=this.animTime/st;this.scale=N(L,j,F(e))}break;case"settle":if(this.animTime+=t,this.animTime>=it)this.animTime=0,this.animPhase="none",this.scale=1;else{const e=this.animTime/it;this.scale=N(j,1,F(e))}break}this.flashTimer>0&&(this.flashTimer-=t,this.flashTimer<0&&(this.flashTimer=0)),this.isTextTransitioning?(this.textTransitionTime-=t,this.textTransitionTime<=0?(this.showingRomaji=!this.showingRomaji,this.isTextTransitioning=!1,this.textOpacity=1,this.textScale=1):this.textOpacity=Math.max(0,this.textTransitionTime/at)):this.textScale<1&&(this.textScale=Math.min(1,this.textScale+t*5))}contains(t,e,s,i){if(!this.active)return!1;const r=this.x*s,n=this.y*i,a=t-r,l=e-n,c=a*a+l*l,d=this.r*this.scale;return c<=d*d}get flashAlpha(){return this.flashTimer>0?this.flashTimer/nt:0}get currentTextOpacity(){return this.textOpacity}get currentTextScale(){return this.textScale}get scale(){return this._scale}set scale(t){this._scale=t}}function N(o,t,e){return o+(t-o)*e}function F(o){return o<1?1-(1-o)*(1-o):1}function ut(o,t){return Math.min(o,t)*Wt}const Ae=new f("BubbleMgr"),vt=o=>Math.floor(Math.random()*o),Ee=()=>{const o=Nt();return o.length===0?"#ffffff":o[vt(o.length)]??"#ffffff"};class Te{constructor(t){this.canvas=t,this.bubbles=[],this.spawnTimer=0,this.rPx=0;const{w:e,h:s}=y(t);this.rPx=ut(e,s)}get entities(){return this.bubbles}update(t){this.spawnTimer-=t,this.spawnTimer<=0&&(this.spawn(),this.spawnTimer=Ht),this.bubbles.forEach(e=>e.step(t)),this.bubbles.some(e=>!e.active)&&(this.bubbles=this.bubbles.filter(e=>e.active))}handleResize(){const{w:t,h:e}=y(this.canvas);this.rPx=ut(t,e),this.bubbles.forEach(s=>s.r=this.rPx)}hitTest(t,e){const{w:s,h:i}=y(this.canvas);for(let r=this.bubbles.length-1;r>=0;r--){const n=this.bubbles[r];if(n&&n.contains(t,e,s,i))return n}}clear(){this.bubbles=[]}spawn(){var a;if(!((a=m.symbols)!=null&&a.length))return;const t=m.symbols[vt(m.symbols.length)],e=m.randomGlyph(t),{w:s}=y(this.canvas),i=this.rPx/s,r=i+Math.random()*(1-2*i),n=1+i;this.bubbles.push(new Se(r,n,Ee(),e,t.roman,this.rPx)),Ae.debug("spawn",{total:this.bubbles.length,roman:t.roman})}}class xe{pastelDarken(t,e,s=1){const i=this.extractRGB(t),r=Math.floor(i.r*(1-e*.7)+30),n=Math.floor(i.g*(1-e)+20),a=Math.floor(i.b*(1-e*.5)+40);return`rgba(${Math.min(r,255)}, ${Math.min(n,255)}, ${Math.min(a,255)}, ${s})`}pastelLighten(t,e,s=1){const i=this.extractRGB(t),r=Math.floor(i.r+(255-i.r)*e),n=Math.floor(i.g+(255-i.g)*e),a=Math.floor(i.b+(255-i.b)*e);return`rgba(${r}, ${n}, ${a}, ${s})`}extractRGB(t){let e=100,s=100,i=100;if(t.startsWith("#")){const r=t.substring(1);e=parseInt(r.substring(0,2),16),s=parseInt(r.substring(2,4),16),i=parseInt(r.substring(4,6),16)}else if(t.startsWith("rgb")){const r=t.match(/\d+/g);r&&r.length>=3&&(e=parseInt(r[0]||"0"),s=parseInt(r[1]||"0"),i=parseInt(r[2]||"0"))}return{r:e,g:s,b:i,toRGBA:r=>`rgba(${e}, ${s}, ${i}, ${r})`}}render(t,e,s,i,r){const n=e.x*s,a=e.y*i,l=e.r*e.scale;t.save();const c=n-l*.3,d=a-l*.3,u=t.createRadialGradient(Number(c)||0,Number(d)||0,Math.max(1,l*.1),Number(n)||0,Number(a)||0,Math.max(1,l*1.2)),g=e.color||"#cccccc",E=jt;u.addColorStop(0,`rgba(255, 255, 255, ${E})`),u.addColorStop(.1,this.pastelLighten(g,.4,E)),u.addColorStop(.7,this.extractRGB(g).toRGBA(E));const O=this.pastelDarken(g,.15,E);u.addColorStop(.92,O),u.addColorStop(1,"rgba(0,0,0,0)"),t.fillStyle=u,t.beginPath(),t.arc(n,a,l,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(n,a,l*.96,0,Math.PI*2),t.shadowColor="rgba(255, 255, 255, 0.3)",t.shadowBlur=l*.15,t.shadowOffsetX=0,t.shadowOffsetY=0,t.fill(),t.beginPath(),t.fillStyle="rgba(255, 255, 255, 0.3)",t.arc(n-l*.43,a-l*.49,l*.2,0,Math.PI*2),t.fill(),t.beginPath(),t.fillStyle="rgba(255, 255, 255, 0.25)",t.arc(n-l*.1,a-l*.66,l*.1,0,Math.PI*2),t.fill(),t.restore();const St=e.showingRomaji?e.romaji:e.glyph,At=e.showingRomaji?Gt:Vt,Et=Math.round(e.r*e.currentTextScale*At);t.save();const B=this.extractRGB(Ut);if(t.fillStyle=`rgba(${B.r}, ${B.g}, ${B.b}, ${e.currentTextOpacity})`,t.textAlign="center",t.textBaseline="middle",t.font=`${Et}px ${Ft}`,t.fillText(St,n,a),t.restore(),e.flashAlpha>0){t.save();const Tt=e.flashAlpha*Yt;t.lineWidth=z,t.strokeStyle=`rgba(255, 255, 255, ${Tt})`,t.shadowColor="rgba(255, 235, 245, 0.9)",t.shadowBlur=z*2.5,t.beginPath(),t.arc(n,a,l+z*.5,0,Math.PI*2),t.stroke(),t.restore()}}}const ke=new f("Pointer");class Ce{constructor(t,e){this.canvas=t,this.bubbles=e,this.bound=this.onDown.bind(this)}attach(){this.canvas.addEventListener("pointerdown",this.bound)}detach(){this.canvas.removeEventListener("pointerdown",this.bound)}onDown(t){var n,a;const e=this.canvas.getBoundingClientRect(),s="clientX"in t?t.clientX:((n=t.touches[0])==null?void 0:n.clientX)??0,i="clientY"in t?t.clientY:((a=t.touches[0])==null?void 0:a.clientY)??0,r=this.bubbles.hitTest(s-e.left,i-e.top);r&&(r.handleClick(performance.now()/1e3),ke.debug("hit",{roman:r.romaji}))}}class Pe extends yt{constructor(){super(...arguments),this.bubbles=new Te(this.ctx.canvas),this.renderer=new xe,this.input=new Ce(this.ctx.canvas,this.bubbles)}async enter(){await super.enter(),this.bubbles.handleResize(),this.input.attach()}update(t){const{w:e,h:s}=y(this.ctx.canvas);this.ctx.clearRect(0,0,e,s),q(this.ctx),this.bubbles.update(t),this.bubbles.entities.forEach(i=>this.renderer.render(this.ctx,i,e,s))}exit(){this.input.detach(),this.bubbles.clear(),super.exit()}paint(){}}let p=null,I=null;const Z=document.querySelector("#game");if(!Z)throw new Error("#game canvas not found");const Y=Z.getContext("2d");if(!Y)throw new Error("2-D context not available");const tt=document.createElement("canvas");tt.id="bg";document.body.prepend(tt);function X(){document.documentElement.style.setProperty("--app-height",`${window.innerHeight}px`)}document.readyState==="loading"?window.addEventListener("DOMContentLoaded",X,{once:!0}):X();window.addEventListener("resize",X);wt.armFirstGesture(window);x.watchCanvas(Z);(async()=>{const o=k.get("kanaPop.theme")??"assets/themes/pastel-pond/";await W.load(o),p=new le,p.add("home",new fe(p,Y)).add("play",new Pe(p,Y)),I=new re(tt),await p.change("home"),J.run(()=>{}).catch(console.error),P=performance.now(),C=requestAnimationFrame(M)})();let C=0,P=performance.now();function M(o){const t=(o-P)/1e3;P=o,I==null||I.paint(t),p==null||p.update(t),C=requestAnimationFrame(M)}document.addEventListener("visibilitychange",()=>{document.hidden?cancelAnimationFrame(C):(P=performance.now(),C=requestAnimationFrame(M))});document.addEventListener("scenechange",o=>{const{nextScene:t}=o.detail;p&&p.change(t),P=performance.now(),C=requestAnimationFrame(M)});
