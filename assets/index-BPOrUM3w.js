(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();function b(o){const{clientWidth:t,clientHeight:e}=o;return{w:t,h:e}}function bt(){return window.devicePixelRatio||1}function Z(o){const t=bt();o.setTransform(1,0,0,1,0,0),o.scale(t,t)}function $t(o){const t=bt(),{w:e,h:s}=b(o);return o.width=Math.round(e*t),o.height=Math.round(s*t),{w:e,h:s,dpr:t}}class Mt{constructor(){this.listeners=new Set,this.watchedCanvases=new Map,this.mediaQuery=null,this.boundTrigger=this.trigger.bind(this),this.dprCallback=null,this.metrics={w:0,h:0,dpr:1}}subscribe(t){this.listeners.add(t),t(),this.listeners.size===1&&this.attachWindowListeners()}unsubscribe(t){this.listeners.delete(t),this.listeners.size===0&&this.detachWindowListeners()}watchCanvas(t){const e=()=>{const s=$t(t);this.metrics=s};this.watchedCanvases.set(t,e),this.subscribe(e)}unwatchCanvas(t){const e=this.watchedCanvases.get(t);e&&(this.unsubscribe(e),this.watchedCanvases.delete(t))}trigger(){this.listeners.forEach(t=>t())}attachWindowListeners(){typeof window<"u"&&(window.addEventListener("resize",this.boundTrigger),this.addDprListener())}detachWindowListeners(){var t;typeof window<"u"&&window.removeEventListener("resize",this.boundTrigger),this.dprCallback&&((t=this.mediaQuery)==null||t.removeEventListener("change",this.dprCallback)),this.mediaQuery=null,this.dprCallback=null}addDprListener(){var t;typeof window>"u"||typeof window.matchMedia>"u"||(this.dprCallback&&((t=this.mediaQuery)==null||t.removeEventListener("change",this.dprCallback)),this.mediaQuery=matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`),this.dprCallback=()=>{this.boundTrigger(),this.addDprListener()},this.mediaQuery.addEventListener("change",this.dprCallback,{once:!0}))}get cssWidth(){return this.metrics.w}get cssHeight(){return this.metrics.h}get dpr(){return this.metrics.dpr}}const k=new Mt,Rt="/kana-pop/assets/background-D-U8xQFM.png",Bt="/kana-pop/assets/background1-Bjf-n90B.png",Ot="/kana-pop/assets/background-D-U8xQFM.png",Dt="/kana-pop/assets/background_vertical-3wb079fu.png",Ht="data:application/json;base64,WyIjRkZEMURDIiwgIiNCNUVBRDciLCAiI0M3Q0VFQSIsICIjRkZEQUMxIiwgIiNFMkYwQ0IiXQo=",jt="data:application/json;base64,ewogICJuYW1lIjogIlBhc3RlbCBQb25kIiwKICAiYXNzZXRzIjogeyAicGFsZXR0ZSI6ICJwYWxldHRlLmpzb24iIH0sCiAgImVmZmVjdCI6IHsKICAgICJ0eXBlIjogImltYWdlIiwKICAgICJob3Jpem9udGFsIjogImJhY2tncm91bmRfaG9yaXpvbnRhbC5wbmciLAogICAgInZlcnRpY2FsIjogImJhY2tncm91bmRfdmVydGljYWwucG5nIgogIH0KfQo=",yt="Pastel Pond",wt={palette:"palette.json"},vt={type:"image",horizontal:"background_horizontal.png",vertical:"background_vertical.png"},Ft={name:yt,assets:wt,effect:vt},Nt=Object.freeze(Object.defineProperty({__proto__:null,assets:wt,default:Ft,effect:vt,name:yt},Symbol.toStringTag,{value:"Module"})),zt=["#FFD1DC","#B5EAD7","#C7CEEA","#FFDAC1","#E2F0CB"],Ut=Object.freeze(Object.defineProperty({__proto__:null,default:zt},Symbol.toStringTag,{value:"Module"})),Wt=2,Vt=.11,j=3,Gt=5,Yt=5,Xt=1,Qt=.14,qt=.4,Jt=.36,Kt=["#ffaaa5","#ffd3b6","#c7ceea","#e2f0cb","#b5ead7"];let St=null;function Zt(o){o&&o.length>0&&(St=o)}function Et(){return St??Kt}const tt="#222",te="Noto Sans JP, sans-serif",ee=tt,xt=.1,se=.85,ie=.65,ne=.4,F=50,nt=.08,at=.1,rt=.14,L=.85,N=1.2,ot=0,ct=.15,ae=.6,z=4,re="__kanaPopDebug_",oe=40,ce=60,le=250,he=!0,lt="sfx/Pop/",I=["pop1.mp3","pop2.mp3","pop3.mp3","pop4.mp3","pop5.mp3"],S=class S{constructor(t,e=S.bootLevel){this.scope=t,this.level=e}out(t,...e){}debug(...t){this.out("debug",...t)}info(...t){this.out("info",...t)}warn(...t){this.out("warn",...t)}error(...t){this.out("error",...t)}};S.bootLevel=(()=>{if(typeof globalThis>"u"||!("localStorage"in globalThis))return"info";const t=localStorage.getItem("logLevel");return t&&["debug","info","warn","error","off"].includes(t)?t:"info"})(),S.isDebug=S.bootLevel==="debug",S.levelOrder={debug:0,info:1,warn:2,error:3,off:4};let m=S;function de(){return{setLevel(o){localStorage.setItem("logLevel",o),location.reload()}}}typeof window<"u"&&(window.logger=de());const E=class E{constructor(t){this.ready=!1,this.imgHorizontal=null,this.imgVertical=null,this.loadedHorizontal=!1,this.loadedVertical=!1,typeof window<"u"?(this.imgHorizontal=new Image,this.imgHorizontal.onload=()=>{var e;E.log.debug(`Loaded horizontal image: ${(e=this.imgHorizontal)==null?void 0:e.src}`),this.loadedHorizontal=!0,this.updateReadyState()},this.imgHorizontal.onerror=()=>{var e;this.loadedHorizontal=!1,E.log.error(`Failed to load horizontal image: ${(e=this.imgHorizontal)==null?void 0:e.src}`),this.updateReadyState()},this.imgHorizontal.src=t.horizontal,this.imgVertical=new Image,this.imgVertical.onload=()=>{var e;E.log.debug(`Loaded vertical image: ${(e=this.imgVertical)==null?void 0:e.src}`),this.loadedVertical=!0,this.updateReadyState()},this.imgVertical.onerror=()=>{var e;this.loadedVertical=!1,E.log.error(`Failed to load vertical image: ${(e=this.imgVertical)==null?void 0:e.src}`),this.updateReadyState()},this.imgVertical.src=t.vertical):this.ready=!0}resize(){}updateReadyState(){this.ready=this.loadedHorizontal||this.loadedVertical}update(t,e){if(!this.ready)return!1;const s=e.canvas.width,i=e.canvas.height,n=s/i;let a=null;if(n>=1?a=this.loadedHorizontal?this.imgHorizontal:this.imgVertical:a=this.loadedVertical?this.imgVertical:this.imgHorizontal,!a||!a.complete||a.naturalWidth===0)return!1;const r=a.naturalWidth/a.naturalHeight;let c,l,u=0,d=0;return r>n?(l=i,c=l*r,u=(s-c)/2):(c=s,l=c/r,d=(i-l)/2),e.drawImage(a,u,d,c,l),!0}};E.log=new m("ImageEffect");let G=E;class ue{constructor(t){this.vid=null,typeof document<"u"&&typeof window<"u"&&(this.vid=document.createElement("video"),this.vid.src=t,this.vid.autoplay=!0,this.vid.loop=!0,this.vid.muted=!0,this.vid.style.position="fixed",this.vid.style.top="0",this.vid.style.left="0",this.vid.style.width="100%",this.vid.style.height="100%",this.vid.style.objectFit="cover",this.vid.style.zIndex="-1",document.body.appendChild(this.vid))}resize(){}update(t,e){return!1}dispose(){this.vid&&this.vid.parentNode&&(this.vid.parentNode.removeChild(this.vid),this.vid=null)}}const T=new m("ShaderEffect");class fe{constructor(t){this.container=null,this.shaderConfig=t,T.debug(`ShaderEffect created with config: ${this.shaderConfig}`)}mount(t){this.container=t;const e=document.createElement("div");e.style.width="100%",e.style.height="100%",e.style.backgroundColor="rgba(50, 0, 50, 0.8)",e.textContent=`Shader Effect: ${this.shaderConfig}`,e.style.color="white",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",this.container.appendChild(e),T.debug("ShaderEffect mounted. Config:",this.shaderConfig)}unmount(){if(this.container){for(;this.container.firstChild;)this.container.removeChild(this.container.firstChild);T.debug("ShaderEffect unmounted.")}this.container=null}resize(t,e,s){T.debug(`ShaderEffect resize called: ${t}x${e} @ ${s}x`)}update(t,e){return T.debug(`ShaderEffect update called with dt: ${t}`),!1}}class pe{constructor(t){this.cls=t,document.body.classList.add(t)}resize(){}update(){return!1}dispose(){document.body.classList.remove(this.cls)}}const ht=Object.assign({"../assets/themes/pastel-pond/background.png":Rt,"../assets/themes/pastel-pond/background1.png":Bt,"../assets/themes/pastel-pond/background_horizontal.png":Ot,"../assets/themes/pastel-pond/background_vertical.png":Dt,"../assets/themes/pastel-pond/palette.json":Ht,"../assets/themes/pastel-pond/theme.json":jt}),dt=Object.assign({"../assets/themes/pastel-pond/theme.json":Nt}),me=Object.assign({"../assets/themes/pastel-pond/palette.json":Ut});class ge{async load(t){const e=`../${t.endsWith("/")?t:t+"/"}theme.json`.replace(/^\.\.\/\/+/,"../"),s=dt[e];if(!s)throw new Error(`Theme manifest not embedded for base '${t}'. Tried key '${e}'. Available MANIFESTS keys: ${Object.keys(dt).join(", ")}`);const i=s.assets.palette.startsWith("/")?s.assets.palette.substring(1):s.assets.palette,n=`../${t.endsWith("/")?t:t+"/"}${i}`.replace(/^\.\.\/\/+/,"../"),a=me[n]??["#ffffff"],r=await this.makeEffect(s.effect,t);return this.current={name:s.name,palette:a,effect:r},Zt(a),this.current}get theme(){return this.current}async makeEffect(t,e){const s=e.replace(/^assets\/themes\//,"").replace(/\/$/,"");function i(n){const a=`../assets/themes/${s}/${n}`,r=ht[a];if(r===void 0)throw console.error(`[ThemeService] Asset URL not found for key: ${a}`),console.error("[ThemeService] Attempted to load file:",n,"from theme folder:",s),console.error("[ThemeService] Available keys from glob:",Object.keys(ht)),new Error(`Asset URL not found by viteAssetUrl: ${a}. Check theme.json and asset paths.`);return r}if(t.type==="image"){const n=i(t.horizontal),a=i(t.vertical);return new G({horizontal:n,vertical:a})}else if(t.type==="video"){const n=i(t.file);return new ue(n)}else if(t.type==="script")try{const r=(await import(`/src/assets/themes/${s}/${t.file}`))[t.export];if(typeof r=="function")return new r(e);throw new Error(`Export "${t.export}" from script "${t.file}" is not a constructor.`)}catch(n){throw console.error(`Failed to load script effect "${t.file}":`,n),n}else{if(t.type==="shader")return new fe(t.shader);if(t.type==="css")return new pe(t.class);{const n=t;throw new Error(`ThemeService: unknown effect type: ${JSON.stringify(n)}`)}}}}const Y=new ge;class be{constructor(t){this.canvas=t,this.time=0;const e=t.getContext("2d");if(!e)throw new Error("2-D context not available");this.ctx=e,k.watchCanvas(t),k.subscribe(()=>this.paint(0))}paint(t){var i,n,a;this.time+=t,Z(this.ctx);const e=window.devicePixelRatio||1;if(this.ctx.save(),this.ctx.scale(1/e,1/e),!((n=(i=Y.theme)==null?void 0:i.effect)==null?void 0:n.update(t,this.ctx))){const{w:r,h:c}=b(this.canvas);this.ctx.fillStyle=((a=Y.theme)==null?void 0:a.palette[2])??"#c7ceea",this.ctx.fillRect(0,0,r,c)}this.ctx.restore()}}const ye=new m("SM");class we{constructor(){this.states=new Map,this.stack=[]}add(t,e){return this.states.set(t,e),this}async change(t){var e,s;ye.info("â†’ change",{from:this.currentName,to:t}),(e=this.current)!=null&&e.exit&&this.current.exit(),this.current=this.states.get(t),this.currentName=t,(s=this.current)!=null&&s.enter&&await this.current.enter()}update(t){var e,s;(s=(e=this.current)==null?void 0:e.update)==null||s.call(e,t)}get currentStateName(){return this.currentName}async push(t){var e;this.current&&(this.stack.push(this.current),this.current.exit&&this.current.exit()),this.current=this.states.get(t),this.currentName=t,(e=this.current)!=null&&e.enter&&await this.current.enter()}async pop(){var t,e,s;this.stack.length&&((t=this.current)!=null&&t.exit&&this.current.exit(),this.current=this.stack.pop(),this.currentName=this.current?(e=[...this.states.entries()].find(([,i])=>i===this.current))==null?void 0:e[0]:void 0,(s=this.current)!=null&&s.enter&&await this.current.enter())}}class At{constructor(t,e){this.resizeHandler=this.paint.bind(this),this.sm=t,this.ctx=e}async enter(){k.subscribe(this.resizeHandler),this.paint()}update(t){}exit(){k.unsubscribe(this.resizeHandler)}clear(){const{w:t,h:e}=b(this.ctx.canvas);return this.ctx.clearRect(0,0,t,e),Z(this.ctx),{w:t,h:e}}}const ve={pop:50,error:[50,100,50],success:[50,50,50,50,100],gameOver:[100,50,100,50,300]},U=new m("Storage");class Se{constructor(){this.isNative=!1,this.storage=this.detectStorage()}detectStorage(){if(typeof window<"u"&&typeof localStorage=="object")try{const t="__storage_test__";return localStorage.setItem(t,t),localStorage.removeItem(t),U.debug("Using native localStorage"),this.isNative=!0,localStorage}catch(t){U.warn("localStorage detected but unavailable (Safari private mode?), using memory storage",t)}else U.info("No localStorage available (Node/test environment), using memory storage");return new Map}get(t){if(this.isNative)return this.storage.getItem(t);const e=this.storage;return e.has(t)?e.get(t):null}set(t,e){this.isNative?this.storage.setItem(t,e):this.storage.set(t,e)}remove(t){this.isNative?this.storage.removeItem(t):this.storage.delete(t)}clear(){this.isNative?this.storage.clear():this.storage.clear()}}const C=new Se,y=new m("Haptics");class Ee{constructor(){if(this.enabled=C.get("kanaPop.haptics")!=="false"&&he,this.debugElement=null,this.lastVibration=0,this.patternArraysOkay=null,!(typeof window>"u"||typeof navigator>"u")){if(window.matchMedia("(prefers-reduced-motion: reduce)").matches){y.info("Haptics disabled due to reduced-motion preference.");return}if(typeof navigator.vibrate=="function"){this.enabled=!0,y.info("Haptic feedback enabled.");const t=()=>{this.updateDebugStatus("Activation gesture received (resume only)")};window.addEventListener("pointerdown",t,{once:!0,passive:!0})}else y.info("Haptic feedback not supported on this device.")}}async vibrate(t=50,e=2){if(!this.enabled)return Promise.resolve(!1);if(this.patternArraysOkay===null)try{navigator.vibrate([1,1])?(navigator.vibrate(0),this.patternArraysOkay=!0,this.updateDebugStatus("Array patterns seem supported.")):(this.patternArraysOkay=!1,this.updateDebugStatus("Array patterns rejected (vibrate returned false)."))}catch(r){this.patternArraysOkay=!1,this.updateDebugStatus(`Array patterns rejected (vibrate threw error: ${r instanceof Error?r.message:String(r)}).`)}const s=Date.now(),i=Array.isArray(t),n=i?le:ce;if(s-this.lastVibration<n)return this.updateDebugStatus(`Throttled (gap: ${n}ms)`),Promise.resolve(!1);let a;if(i)a=t.map(r=>Math.max(r,F)),!this.patternArraysOkay&&a.length>0&&(a=Math.max(...a,F),this.updateDebugStatus("Collapsed array to single max pulse for compatibility."));else{const r=Math.max(t,F),c=oe;switch(e){case 1:a=r;break;case 2:a=Math.min(r*1.5,150);break;case 3:a=this.patternArraysOkay?[r,c,r]:r*2;break;default:return y.warn(`Invalid intensity: ${e} for numeric pattern.`),Promise.resolve(!1)}}try{return Array.isArray(a)&&a.length===0?(y.warn("Attempted to vibrate with an empty pattern array."),Promise.resolve(!1)):typeof a=="number"&&a===0&&t!==0?(y.warn("Calculated vibration duration is zero, skipping."),Promise.resolve(!1)):navigator.vibrate(a)?(this.lastVibration=s,this.updateDebugStatus(`Vibrated: ${JSON.stringify(a)}`),y.info("Vibrating with:",{originalPattern:t,intensity:e,actualVibration:a}),Promise.resolve(!0)):(this.updateDebugStatus("navigator.vibrate() returned false."),y.warn("navigator.vibrate() returned false for pattern:",a),Promise.resolve(!1))}catch(r){return y.warn("Vibration failed with error:",r),this.updateDebugStatus(`Failed: ${r instanceof Error?r.message:String(r)}`),Array.isArray(a)&&this.patternArraysOkay&&(this.patternArraysOkay=!1,this.updateDebugStatus("Error with array vibration, marked arrays as not okay for future.")),Promise.resolve(!1)}}isSupported(){return this.enabled}createDebugElement(){var e;if(typeof document>"u")return;const t=`${re}Haptics`;(e=document.getElementById(t))==null||e.remove(),this.debugElement=document.createElement("div"),this.debugElement.id=t,this.debugElement.style.position="fixed",this.debugElement.style.bottom="30px",this.debugElement.style.left="10px",this.debugElement.style.background="rgba(0,0,0,0.5)",this.debugElement.style.color="white",this.debugElement.style.padding="5px",this.debugElement.style.fontSize="12px",this.debugElement.style.zIndex="9999",this.debugElement.style.pointerEvents="none",document.body.appendChild(this.debugElement)}updateDebugStatus(t){this.debugElement&&(this.debugElement.textContent=`Haptics: ${t}`)}vibratePattern(t){const e=ve[t];return typeof e=="number"?this.vibrate(e):this.vibrate([...e])}setEnabled(t){this.enabled=t,C.set("kanaPop.haptics",String(t)),t||navigator.vibrate(0)}isEnabled(){return this.enabled}}const X=new Ee;class xe{constructor(t){this.onClose=t,this.overlay=document.createElement("div"),this.overlay.style.cssText=`
      position:fixed;inset:0;background:rgba(0,0,0,.6);
      color:${tt};display:flex;flex-direction:column;
      align-items:center;justify-content:center;
      font:18px sans-serif;z-index:50`,this.overlay.innerHTML=`
      <h2 style="margin:0 0 20px">Settings</h2>
      <label style="margin-bottom:15px;display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="hapticsToggle">
        Haptics
      </label>
      <button id="close">Close</button>`,this.overlay.querySelector("#close").addEventListener("click",()=>this.toggle());const e=this.overlay.querySelector("#hapticsToggle");e.addEventListener("change",()=>{X.setEnabled(e.checked)})}toggle(){document.body.contains(this.overlay)?this.hide():this.show()}show(){document.body.appendChild(this.overlay);const t=this.overlay.querySelector("#hapticsToggle");t.checked=X.isEnabled()}hide(){this.overlay.remove(),this.onClose()}}class Ae extends At{constructor(){super(...arguments),this.settings=new xe(()=>{}),this.enter=async()=>{document.body.dataset.scene="home",await super.enter(),window.addEventListener("pointerdown",this.onTap)},this.exit=()=>{window.removeEventListener("pointerdown",this.onTap),this.settings.hide(),delete document.body.dataset.scene,super.exit()},this.onTap=t=>{const{w:e,h:s}=b(this.ctx.canvas),{offsetX:i,offsetY:n}=t;i>e-60&&n>s-60?this.settings.toggle():this.sm.change("play")}}paint(){const{w:t,h:e}=this.clear();this.ctx.fillStyle=tt,this.ctx.textAlign="center",this.ctx.font="32px sans-serif",this.ctx.fillText("Tap to Start",t/2,e/2),this.ctx.font="20px sans-serif",this.ctx.fillText("âš™ï¸Ž",t-30,e-30)}}function Te(){if(typeof navigator>"u")return!1;const o=typeof navigator>"u"?"":navigator.userAgent;return/iPad|iPhone|iPod/.test(o)&&!(typeof window<"u"&&window.MSStream)}function ke(){if(typeof navigator>"u")return!1;const o=typeof navigator>"u"?"":navigator.userAgent;return/iPad/.test(o)||typeof navigator<"u"&&navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1}function Q(){if(typeof navigator>"u")return!1;if(Te()||ke())return!0;const o=typeof navigator>"u"?"":navigator.userAgent;return!!(/iPad|iPhone|iPod/.test(o)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>0)}const w=new m("Audio");class Ce{constructor(){this.bank=new Map}async ensureContext(){const t=()=>{const e=globalThis,s=e.AudioContext??e.webkitAudioContext;if(!s)throw new Error("Web Audio API not supported");const i=new s;return w.info(`Created new AudioContext: ${i.state}`),i};if((!this.ctx||this.ctx.state==="closed")&&(this.ctx=t()),this.ctx.state==="suspended"||this.ctx.state==="interrupted"){w.info(`Attempting resume() from ${this.ctx.state}`);try{await this.ctx.resume()}catch(e){w.warn("resume() threw",e)}}if(this.ctx.state!=="running"){w.warn(`AudioContext stuck in '${this.ctx.state}', recreatingâ€¦`);try{await this.ctx.close()}catch{}this.ctx=t(),await this.ctx.resume()}return this.ctx}async fetch(t){var e;if(this.bank.has(t))return this.bank.get(t);try{const s=await fetch(t,{cache:"force-cache"});if(!s.ok)throw new Error(`HTTP ${s.status} ${s.statusText}`);const i=((e=s.headers.get("content-type"))==null?void 0:e.toLowerCase())??"";if(!i.startsWith("audio/"))throw new Error(`Non-audio response (${i||"no Content-Type"})`);const n=await s.arrayBuffer(),r=await(await this.ensureContext()).decodeAudioData(n);return this.bank.set(t,r),r}catch(s){throw w.error(`AudioBufferBank.fetch failed for ${t}`,s),s}}async play(t){const e=await this.ensureContext(),s=e.createBufferSource();s.buffer=t,s.connect(e.destination),s.start(),s.onended=()=>s.disconnect()}async resume(){try{const t=await this.ensureContext();if(Q()){w.info("iOS/iPadOS detected, playing silent buffer to unlock audio");const e=t.sampleRate||44100,s=t.createBuffer(2,e*.5,e);for(let r=0;r<2;r++){const c=s.getChannelData(r);for(let l=0;l<c.length;l++)c[l]=0}const i=Q()?.5:.1,n=t.createGain();n.gain.value=.001;const a=t.createBufferSource();a.buffer=s,a.connect(n),n.connect(t.destination),a.start(0),a.stop(t.currentTime+i),a.onended=()=>{a.disconnect(),n.disconnect()},w.info(`Silent buffer played (duration: ${i}s)`)}return t}catch(t){throw w.error("Resume failed",t),t}}}class Pe{constructor(){this.tasks=[]}add(t){this.tasks.push(t)}async run(t,e=!0){if(this.tasks.length===0){t(1);return}if(e){let s=0;await Promise.all(this.tasks.map(i=>i().then(()=>{t(++s/this.tasks.length)})))}else for(let s=0;s<this.tasks.length;s++){const i=this.tasks[s];await i(),t((s+1)/this.tasks.length)}this.tasks=[]}}const et=new Pe,_e="modulepreload",Le=function(o){return"/kana-pop/"+o},ut={},ft=function(t,e,s){let i=Promise.resolve();if(e&&e.length>0){let a=function(l){return Promise.all(l.map(u=>Promise.resolve(u).then(d=>({status:"fulfilled",value:d}),d=>({status:"rejected",reason:d}))))};document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),c=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));i=a(e.map(l=>{if(l=Le(l),l in ut)return;ut[l]=!0;const u=l.endsWith(".css"),d=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${d}`))return;const p=document.createElement("link");if(p.rel=u?"stylesheet":_e,u||(p.as="script"),p.crossOrigin="",p.href=l,c&&p.setAttribute("nonce",c),document.head.appendChild(p),u)return new Promise((x,A)=>{p.addEventListener("load",x),p.addEventListener("error",()=>A(new Error(`Unable to preload CSS for ${l}`)))})}))}function n(a){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=a,window.dispatchEvent(r),!r.defaultPrevented)throw a}return i.then(a=>{for(const r of a||[])r.status==="rejected"&&n(r.reason);return t().catch(n)})},v=class v{static async manifest(){if(!this.manifestPromise){if(!v.loadManifest)throw new Error("Manifest loader not found. Check glob pattern and file existence.");this.manifestPromise=v.loadManifest()}return this.manifestPromise}static async language(t){const e=`../data/lang/${t}.json`,s=v.langFiles[e];if(!s)throw new Error(`No language data file for '${t}'`);return s()}};v.manifestPromise=null,v.langFiles=Object.assign({"../data/lang/ja.json":()=>ft(()=>import("./ja-DEJkL8aw.js"),[]).then(t=>t.default)}),v.loadManifest=Object.assign({"../data/lang/index.json":()=>ft(()=>import("./index-BJLXKDTG.js"),[]).then(t=>t.default)})["../data/lang/index.json"];let R=v;const $=new m("Lang");class Ie{constructor(){var s;const t=C.get("kanaPop.lang"),e=typeof navigator<"u"?(s=navigator.language)==null?void 0:s.slice(0,2):void 0;this.defaultCode=t||e||"ja",this.lang={code:this.defaultCode,name:"loadingâ€¦",symbols:[],direction:"ltr"},this.initialLoadPromise=new Promise(i=>{this.initialLoadResolve=i}),et.add(async()=>{$.info(`LanguageService: Starting initial load for language code '${this.defaultCode}'...`),await this.load(this.defaultCode),$.info("LanguageService: Initial load completed.")})}async load(t=this.defaultCode){const e=await R.manifest(),s=e.find(a=>a.code===t)??e.find(a=>a.code===this.defaultCode);if(!s)throw new Error("LanguageService: manifest empty");const i=await R.language(s.code);s.direction||$.warn(`'${s.code}' lacks "direction"; defaulting to 'ltr'`);const n=s.direction??"ltr";this.lang={code:s.code,name:s.name,symbols:i.symbols??[],direction:n},this.persistLang(this.lang.code),this.initialLoadResolve&&this.initialLoadResolve()}get symbols(){return this.lang.symbols}get currentCode(){return this.lang.code}get direction(){return this.lang.direction}randomGlyph(t){const e=Object.values(t.glyphs);return e.length===0?($.warn(`Symbol with roman='${t.roman}' (category: ${t.category}, lang: ${this.lang.code}) has no glyphs defined. Returning '?' as fallback.`),"?"):e[Math.floor(Math.random()*e.length)]}persistLang(t){C.set("kanaPop.lang",t)}ready(){return this.initialLoadPromise}}const f=new Ie,h=new m("Sound"),O=class O{constructor(){this.bank=new Ce,this.isGestureArmed=!1,this.assetLoadCompletedPromise=new Promise(t=>{this.assetLoadCompletedResolve=t}),et.add(async()=>{h.info("SoundService: Waiting for LanguageService to be ready..."),await f.ready(),h.info("SoundService: LanguageService is ready. Starting sound preload...");const t=f.symbols.map(i=>`${f.currentCode}/${i.audio}`),e=I.map(i=>`${lt}${i}`),s=[...t,...e];if(s.length>0)try{await this.preloadAll(s),h.info(`SoundService: Successfully preloaded ${s.length} sounds for language '${f.currentCode}'.`)}catch(i){h.error("SoundService: Error during sound preloading.",i)}else h.info(`SoundService: No sounds to preload for language '${f.currentCode}'.`);this.assetLoadCompletedResolve()}),this.ready=new Promise(t=>this.triggerReady=t),typeof document<"u"&&document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&(h.debug("Page became visible â€“ poking AudioContext"),this.bank.ensureContext().catch(()=>{}))})}async armFirstGesture(t=window){if(this.isGestureArmed)return;this.isGestureArmed=!0,h.info("First gesture handler armed");const e=Q(),s=[],i=(r,c)=>{r.addEventListener(c,a,{passive:!0}),s.push({target:r,type:c})},n=()=>{h.info("Trimming audio unlock listeners (keeping one for re-unlock)");let r=!1;s.forEach(({target:c,type:l})=>{if(!r&&c===window&&l==="pointerdown"){r=!0;return}c.removeEventListener(l,a)})},a=async()=>{h.info("User gesture detected, unlocking audio");let r=!1;try{await this.bank.resume(),h.info("Audio context unlocked successfully"),r=!0}catch(c){h.warn("AudioContext unlock failed, trying HTML Audio fallback",c);try{const l=new Audio(O.SILENT);l.autoplay=!0,l.muted=!1,l.volume=.001,l.setAttribute("playsinline",""),h.info("Playing fallback HTML audio");const u=l.play();if(u instanceof Promise){await u,h.info("Fallback audio played successfully");try{await this.bank.resume(),h.info("Audio context unlocked after HTML audio fallback"),r=!0}catch(d){h.warn("Audio context still locked after HTML audio fallback",d)}}else h.warn("Fallback audio play() returned no promise")}catch(l){h.error("All audio unlock attempts failed",l)}}this.triggerReady(),r?n():h.warn("Audio still locked â€“ listeners stay armed for another try")};h.info("Registering audio unlock gesture handlers"),i(t,"pointerdown"),i(t,"touchstart"),i(t,"click"),e&&(h.info("Adding extra handlers for iOS/iPadOS"),i(document.body,"pointerdown"),i(document.body,"touchstart"),i(document.body,"click"),i(document,"pointerdown"),i(document,"touchstart"),i(document,"click"),i(window,"pointerdown"),i(window,"touchstart"),i(window,"click"))}async play(t){if(await this.ready,t.endsWith("fallback.mp3"))return;const e=pt(`/kana-pop/audio/${t}`);try{const s=await this.bank.fetch(e);await this.bank.play(s)}catch(s){h.warn(`Web Audio playback failed for ${e}, using HTMLAudioElement fallback`,s),new Audio(e).play().catch(i=>{h.error(`HTMLAudioElement fallback also failed for ${e}`,i)})}}playRoman(t){var s;const e=(s=f.symbols.find(i=>i.roman===t))==null?void 0:s.audio;e&&this.play(`${f.currentCode}/${e}`)}playPop(){const t=I[Math.floor(Math.random()*I.length)]??I[0];this.play(`${lt}${t}`)}async preloadAll(t){await this.ready,h.info(`Preloading ${t.length} audio files`),await Promise.all(t.map(e=>{if(e.endsWith("fallback.mp3"))return Promise.resolve();const s=pt(`/kana-pop/audio/${e}`);return this.bank.fetch(s).catch(i=>{h.warn(`Failed to preload audio: ${e}`,i)})})),h.info("Audio preloading complete")}assetsReady(){return this.assetLoadCompletedPromise}};O.SILENT="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAIlYAACJWAAABAAgAZGF0YQAAAAA=";let q=O;const B=new q;function pt(o){return o.startsWith("data:")?o:`${o}?v=mbstdcau`}const mt=new m("Bubble");class Tt{constructor(t,e,s,i,n,a){this.x=t,this.y=e,this.color=s,this.glyph=i,this.romaji=n,this.active=!0,this.speed=Vt,this._scale=1,this.animPhase="none",this.animTime=0,this.textScale=1,this.textOpacity=1,this.isTextTransitioning=!1,this.textTransitionTime=0,this.flashTimer=0,this.showingRomaji=!1,this.lastSpoken=-1/0,this.r=a,mt.debug("spawn",{x:this.x.toFixed(2),color:s,glyph:this.glyph})}handleClick(t){t-this.lastSpoken<ne||(this.lastSpoken=t,X.vibratePattern("pop").catch(()=>{}),this.triggerTapAnimation(),this.startTextTransition(),B.playRoman(this.romaji),this.flashTimer=ot,mt.debug("toggle",{romaji:this.showingRomaji}))}triggerTapAnimation(){this.animPhase="squash",this.animTime=0,this.scale=1,this.textScale=L}startTextTransition(){this.isTextTransitioning=!0,this.textTransitionTime=ct,this.textOpacity=0}step(t){switch(this.y+=this.speed*t*-1,this.y<-.05&&(this.active=!1),this.animPhase){case"squash":if(this.animTime+=t,this.animTime>=nt)this.animTime=0,this.animPhase="stretch",this.scale=L;else{const s=this.animTime/nt;this.scale=W(1,L,V(s))}break;case"stretch":if(this.animTime+=t,this.animTime>=at)this.animTime=0,this.animPhase="settle",this.scale=N;else{const s=this.animTime/at;this.scale=W(L,N,V(s))}break;case"settle":if(this.animTime+=t,this.animTime>=rt)this.animTime=0,this.animPhase="none",this.scale=1;else{const s=this.animTime/rt;this.scale=W(N,1,V(s))}break}this.flashTimer>0&&(this.flashTimer-=t,this.flashTimer<0&&(this.flashTimer=0)),this.isTextTransitioning?(this.textTransitionTime-=t,this.textTransitionTime<=0?(this.showingRomaji=!this.showingRomaji,this.isTextTransitioning=!1,this.textOpacity=1,this.textScale=1):this.textOpacity=Math.max(0,this.textTransitionTime/ct)):this.textScale<1&&(this.textScale=Math.min(1,this.textScale+t*5))}contains(t,e,s,i){if(!this.active)return!1;const n=this.x*s,a=this.y*i,r=t-n,c=e-a,l=r*r+c*c,u=this.r*this.scale;return l<=u*u}get flashAlpha(){return this.flashTimer>0?this.flashTimer/ot:0}get currentTextOpacity(){return this.textOpacity}get currentTextScale(){return this.textScale}get scale(){return this._scale}set scale(t){this._scale=t}}function W(o,t,e){return o+(t-o)*e}function V(o){return o<1?1-(1-o)*(1-o):1}function gt(o,t){return Math.min(o,t)*xt}const $e=new m("BubbleMgr"),kt=o=>Math.floor(Math.random()*o),Me=()=>{const o=Et();if(o.length===0)return"#FFD1DC";const t=kt(o.length);return o[t]??o[0]??"#FFD1DC"};class Re{constructor(t){this.canvas=t,this.bubbles=[],this.spawnTimer=0,this.rPx=0,this.difficulty=1;const{w:e,h:s}=b(t);this.rPx=gt(e,s)}get entities(){return this.bubbles}setDifficulty(t){const e=Math.min(this.difficulty,j),i=Math.min(t,j)/e;this.difficulty=t,this.bubbles.forEach(n=>n.speed*=i)}update(t){for(this.spawnTimer-=t;this.spawnTimer<=0;){const e=Math.min(1+Math.floor(this.difficulty),Xt);for(let s=0;s<e;s++)this.spawn();this.spawnTimer+=Wt/this.difficulty}this.bubbles.forEach(e=>e.step(t)),this.bubbles.some(e=>!e.active)&&(this.bubbles=this.bubbles.filter(e=>e.active))}handleResize(){const{w:t,h:e}=b(this.canvas);this.rPx=gt(t,e),this.bubbles.forEach(s=>s.r=this.rPx)}hitTest(t,e){const{w:s,h:i}=b(this.canvas);for(let n=this.bubbles.length-1;n>=0;n--){const a=this.bubbles[n];if(a&&a.contains(t,e,s,i))return a}}clear(){this.bubbles=[]}spawn(t){var d;if(!((d=f.symbols)!=null&&d.length))return;const e=t??f.symbols[kt(f.symbols.length)],s=f.randomGlyph(e),{w:i}=b(this.canvas),n=this.rPx/i,a=n+Math.random()*(1-2*n),r=1+n,c=new Tt(a,r,Me(),s,e.roman,this.rPx),l=Math.min(this.difficulty,j),u=1+(Math.random()*2-1)*Qt;c.speed*=l*u,Math.random()<qt&&(c.showingRomaji=!0),this.bubbles.push(c),$e.debug("spawn",{total:this.bubbles.length,roman:e.roman})}guarantee(t){this.spawn(t)}}class Be{pastelDarken(t,e,s=1){const i=this.extractRGB(t),n=Math.floor(i.r*(1-e*.7)+30),a=Math.floor(i.g*(1-e)+20),r=Math.floor(i.b*(1-e*.5)+40);return`rgba(${Math.min(n,255)}, ${Math.min(a,255)}, ${Math.min(r,255)}, ${s})`}pastelLighten(t,e,s=1){const i=this.extractRGB(t),n=Math.floor(i.r+(255-i.r)*e),a=Math.floor(i.g+(255-i.g)*e),r=Math.floor(i.b+(255-i.b)*e);return`rgba(${n}, ${a}, ${r}, ${s})`}extractRGB(t){let e=100,s=100,i=100;if(t.startsWith("#")){const n=t.substring(1);e=parseInt(n.substring(0,2),16),s=parseInt(n.substring(2,4),16),i=parseInt(n.substring(4,6),16)}else if(t.startsWith("rgb")){const n=t.match(/\d+/g);n&&n.length>=3&&(e=parseInt(n[0]||"0"),s=parseInt(n[1]||"0"),i=parseInt(n[2]||"0"))}return{r:e,g:s,b:i,toRGBA:n=>`rgba(${e}, ${s}, ${i}, ${n})`}}render(t,e,s,i,n){const a=e.x*s,r=e.y*i,c=e.r*e.scale;t.save();const l=a-c*.3,u=r-c*.3,d=t.createRadialGradient(Number(l)||0,Number(u)||0,Math.max(1,c*.1),Number(a)||0,Number(r)||0,Math.max(1,c*1.2)),p=e.color||"#cccccc",x=Jt;let A=p;!p.startsWith("#")&&!p.startsWith("rgb")&&(A="#"+p),d.addColorStop(0,`rgba(255, 255, 255, ${x})`),d.addColorStop(.1,this.pastelLighten(A,.4,x)),d.addColorStop(.7,this.extractRGB(A).toRGBA(x));const Ct=this.pastelDarken(A,.15,x);d.addColorStop(.92,Ct),d.addColorStop(1,"rgba(0,0,0,0)"),t.fillStyle=d,t.beginPath(),t.arc(a,r,c,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(a,r,c*.96,0,Math.PI*2),t.shadowColor="rgba(255, 255, 255, 0.3)",t.shadowBlur=c*.15,t.shadowOffsetX=0,t.shadowOffsetY=0,t.fill(),t.beginPath(),t.fillStyle="rgba(255, 255, 255, 0.2)",t.arc(a-c*.43,r-c*.49,c*.2,0,Math.PI*2),t.fill(),t.beginPath(),t.fillStyle="rgba(255, 255, 255, 0.25)",t.arc(a-c*.1,r-c*.66,c*.1,0,Math.PI*2),t.fill(),t.restore();const Pt=e.showingRomaji?e.romaji:e.glyph,_t=e.showingRomaji?ie:se,Lt=Math.round(e.r*e.currentTextScale*_t);t.save();const H=this.extractRGB(ee);if(t.fillStyle=`rgba(${H.r}, ${H.g}, ${H.b}, ${e.currentTextOpacity})`,t.textAlign="center",t.textBaseline="middle",t.font=`${Lt}px ${te}`,t.fillText(Pt,a,r),t.restore(),e.flashAlpha>0){t.save();const It=e.flashAlpha*ae;t.lineWidth=z,t.strokeStyle=`rgba(255, 255, 255, ${It})`,t.shadowColor="rgba(255, 235, 245, 0.9)",t.shadowBlur=z*2.5,t.beginPath(),t.arc(a,r,c+z*.5,0,Math.PI*2),t.stroke(),t.restore()}}}class Oe extends Tt{constructor(t,e,s,i,n,a){super(t,e,s,i,n,a),this.speed=0,this.showingRomaji=!0}step(t){const e=this.y;super.step(t),this.y=e}}const De=new m("Pointer");class He{constructor(t,e,s,i){this.canvas=t,this.bubbles=e,this.onTap=s,this.extraTarget=i,this.bound=this.onDown.bind(this)}attach(){this.canvas.addEventListener("pointerdown",this.bound)}detach(){this.canvas.removeEventListener("pointerdown",this.bound)}onDown(t){var a,r;const e=this.canvas.getBoundingClientRect(),s="clientX"in t?t.clientX:((a=t.touches[0])==null?void 0:a.clientX)??0,i="clientY"in t?t.clientY:((r=t.touches[0])==null?void 0:r.clientY)??0;let n=null;if(this.extraTarget){const c=this.extraTarget();c&&c.contains(s-e.left,i-e.top,e.width,e.height)&&(n=c)}n||(n=this.bubbles.hitTest(s-e.left,i-e.top)??null),n&&(n.handleClick(performance.now()/1e3),De.debug("hit",{roman:n.romaji}),this.onTap(n))}}class je{constructor(){this.el=document.createElement("div"),this.el.style.cssText=`
      position:fixed;top:12px;right:12px;z-index:40;
      padding:8px 18px;border-radius:28px;
      background:rgba(0,0,0,.7);color:#fff;
      font:700 32px/1 'Noto Sans JP',sans-serif;
      display:flex;align-items:center;gap:10px;
      pointer-events:none;user-select:none;transition:opacity .2s ease`,this.el.innerHTML='ðŸ”¥ <span id="cnt">0</span>',this.el.style.opacity="0"}mount(){document.body.contains(this.el)||document.body.appendChild(this.el)}unmount(){this.el.parentElement&&this.el.parentElement.removeChild(this.el)}set(t){const e=this.el.querySelector("#cnt");e.textContent=String(t),t>0?(this.el.style.opacity="1",this.el.animate([{transform:"scale(1.2)"},{transform:"scale(1)"}],{duration:150,easing:"ease-out"})):this.el.style.opacity="0"}}class Fe extends At{constructor(){super(...arguments),this.bubbles=new Re(this.ctx.canvas),this.renderer=new Be,this.indicator=null,this.streak=0,this.difficulty=1,this.streakUI=new je,this.onBubbleTap=t=>{this.indicator&&t!==this.indicator&&(t.romaji===this.indicator.romaji?(this.streak++,this.updateDifficulty(),this.streakUI.set(this.streak),B.playPop(),this.spawnIndicator()):(this.streak=0,this.updateDifficulty(),this.streakUI.set(this.streak),this.indicator.flashTimer=.15))},this.input=new He(this.ctx.canvas,this.bubbles,this.onBubbleTap,()=>this.indicator)}async enter(){await super.enter(),this.bubbles.handleResize(),this.spawnIndicator(),this.input.attach(),this.streakUI.mount()}update(t){var i;const{w:e,h:s}=b(this.ctx.canvas);if(this.ctx.clearRect(0,0,e,s),Z(this.ctx),this.bubbles.update(t),this.indicator){const n=this.indicator.romaji;if(!this.bubbles.entities.some(a=>a.romaji===n)){const a=(i=f.symbols)==null?void 0:i.find(r=>r.roman===n);a&&this.bubbles.guarantee(a)}}this.indicator&&this.indicator.step(t),this.bubbles.entities.forEach(n=>this.renderer.render(this.ctx,n,e,s)),this.indicator&&this.renderer.render(this.ctx,this.indicator,e,s)}exit(){this.input.detach(),this.bubbles.clear(),this.indicator=null,this.streakUI.unmount(),super.exit()}paint(){}spawnIndicator(){if(!f.symbols||!f.symbols.length)return;const{w:t,h:e}=b(this.ctx.canvas),s=f.symbols[Math.floor(Math.random()*f.symbols.length)],i=Math.min(t,e)*xt,n=Et(),a=n[Math.floor(Math.random()*n.length)]??"#FFD1DC",r=f.randomGlyph(s),c=i/e+.02;this.indicator=new Oe(.5,c,a,r,s.roman,i),this.bubbles.guarantee(s),B.playRoman(s.roman),this.streakUI.set(this.streak)}updateDifficulty(){this.difficulty=Math.min(1+this.streak/Yt,Gt),this.bubbles.setDifficulty(this.difficulty)}}if(typeof window<"u"&&window.location.search.includes("debug")){const o=document.createElement("pre");o.style.cssText="position:fixed;inset:0;z-index:99999;background:#000C;color:#0F0;padding:8px;font:12px/1.4 monospace;overflow:auto;white-space:pre-wrap;",o.textContent=`ðŸš¦ kana-pop live debug console (first error wins)

`,document.readyState!=="loading"?document.body.append(o):document.addEventListener("DOMContentLoaded",()=>document.body.append(o),{once:!0});const t=(e,s)=>{const i=s instanceof Error&&s.stack?s.stack:typeof s=="string"?s:JSON.stringify(s,null,2);o.textContent+=`ðŸ›‘ ${e}: ${i}
`};window.addEventListener("error",e=>t("error",e.error??e.message)),window.addEventListener("unhandledrejection",e=>t("promise",e.reason))}let g=null,M=null;const st=document.querySelector("#game");if(!st)throw new Error("#game canvas not found");const J=st.getContext("2d");if(!J)throw new Error("2-D context not available");const it=document.createElement("canvas");it.id="bg";document.body.prepend(it);function K(){document.documentElement.style.setProperty("--app-height",`${window.innerHeight}px`)}document.readyState==="loading"?window.addEventListener("DOMContentLoaded",K,{once:!0}):K();window.addEventListener("resize",K);B.armFirstGesture(window);k.watchCanvas(st);(async()=>{const o=C.get("kanaPop.theme")??"assets/themes/pastel-pond/";await Y.load(o),g=new we,g.add("home",new Ae(g,J)).add("play",new Fe(g,J)),M=new be(it),await g.change("home"),et.run(()=>{}).catch(console.error),_=performance.now(),P=requestAnimationFrame(D)})();let P=0,_=performance.now();function D(o){const t=(o-_)/1e3;_=o,M==null||M.paint(t),g==null||g.update(t),P=requestAnimationFrame(D)}document.addEventListener("visibilitychange",()=>{document.hidden?cancelAnimationFrame(P):(_=performance.now(),P=requestAnimationFrame(D))});document.addEventListener("scenechange",o=>{const{nextScene:t}=o.detail;g&&g.change(t),_=performance.now(),P=requestAnimationFrame(D)});
