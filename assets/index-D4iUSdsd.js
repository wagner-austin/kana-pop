(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();function b(r){const{clientWidth:e,clientHeight:t}=r;return{w:e,h:t}}function he(){return window.devicePixelRatio||1}function Q(r){const e=he();r.setTransform(1,0,0,1,0,0),r.scale(e,e)}function ve(r){const e=he(),{w:t,h:s}=b(r);return r.width=Math.round(t*e),r.height=Math.round(s*e),{w:t,h:s,dpr:e}}class Se{constructor(){this.listeners=new Set,this.watchedCanvases=new Map,this.mediaQuery=null,this.boundTrigger=this.trigger.bind(this),this.dprCallback=null,this.metrics={w:0,h:0,dpr:1}}subscribe(e){this.listeners.add(e),e(),this.listeners.size===1&&this.attachWindowListeners()}unsubscribe(e){this.listeners.delete(e),this.listeners.size===0&&this.detachWindowListeners()}watchCanvas(e){const t=()=>{const s=ve(e);this.metrics=s};this.watchedCanvases.set(e,t),this.subscribe(t)}unwatchCanvas(e){const t=this.watchedCanvases.get(e);t&&(this.unsubscribe(t),this.watchedCanvases.delete(e))}trigger(){this.listeners.forEach(e=>e())}attachWindowListeners(){typeof window<"u"&&(window.addEventListener("resize",this.boundTrigger),this.addDprListener())}detachWindowListeners(){var e;typeof window<"u"&&window.removeEventListener("resize",this.boundTrigger),this.dprCallback&&((e=this.mediaQuery)==null||e.removeEventListener("change",this.dprCallback)),this.mediaQuery=null,this.dprCallback=null}addDprListener(){var e;typeof window>"u"||typeof window.matchMedia>"u"||(this.dprCallback&&((e=this.mediaQuery)==null||e.removeEventListener("change",this.dprCallback)),this.mediaQuery=matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`),this.dprCallback=()=>{this.boundTrigger(),this.addDprListener()},this.mediaQuery.addEventListener("change",this.dprCallback,{once:!0}))}get cssWidth(){return this.metrics.w}get cssHeight(){return this.metrics.h}get dpr(){return this.metrics.dpr}}const E=new Se,Ae="/kana-pop/assets/background-D-U8xQFM.png",xe="/kana-pop/assets/background1-Bjf-n90B.png",Ee="/kana-pop/assets/background-D-U8xQFM.png",Te="/kana-pop/assets/background_vertical-3wb079fu.png",ke="data:application/json;base64,WyIjRkZEMURDIiwgIiNCNUVBRDciLCAiI0M3Q0VFQSIsICIjRkZEQUMxIiwgIiNFMkYwQ0IiXQo=",Ce="data:application/json;base64,ewogICJuYW1lIjogIlBhc3RlbCBQb25kIiwKICAiYXNzZXRzIjogeyAicGFsZXR0ZSI6ICJwYWxldHRlLmpzb24iIH0sCiAgImVmZmVjdCI6IHsKICAgICJ0eXBlIjogImltYWdlIiwKICAgICJob3Jpem9udGFsIjogImJhY2tncm91bmRfaG9yaXpvbnRhbC5wbmciLAogICAgInZlcnRpY2FsIjogImJhY2tncm91bmRfdmVydGljYWwucG5nIgogIH0KfQo=",de="Pastel Pond",ue={palette:"palette.json"},fe={type:"image",horizontal:"background_horizontal.png",vertical:"background_vertical.png"},_e={name:de,assets:ue,effect:fe},Le=Object.freeze(Object.defineProperty({__proto__:null,assets:ue,default:_e,effect:fe,name:de},Symbol.toStringTag,{value:"Module"})),Pe=["#FFD1DC","#B5EAD7","#C7CEEA","#FFDAC1","#E2F0CB"],Ie=Object.freeze(Object.defineProperty({__proto__:null,default:Pe},Symbol.toStringTag,{value:"Module"})),$e=1.2,Re=.6,Oe=["#ffaaa5","#ffd3b6","#c7ceea","#e2f0cb","#b5ead7"];let me=null;function He(r){me=r}function Be(){return me??Oe}const G="#222",Me="Noto Sans JP, sans-serif",je=G,ze=.1,De=.85,Fe=.65,Ne=.4,O=50,K=.08,J=.1,Z=.14,_=.85,H=1.2,ee=0,te=.15,Ue=.6,se=4,Ve="__kanaPopDebug_",We=40,Qe=60,Ge=250,Ye=!0,S=class S{constructor(e,t=S.bootLevel){this.scope=e,this.level=t}out(e,...t){}debug(...e){this.out("debug",...e)}info(...e){this.out("info",...e)}warn(...e){this.out("warn",...e)}error(...e){this.out("error",...e)}};S.bootLevel=(()=>{if(typeof globalThis>"u"||!("localStorage"in globalThis))return"info";const e=localStorage.getItem("logLevel");return e&&["debug","info","warn","error","off"].includes(e)?e:"info"})(),S.isDebug=S.bootLevel==="debug",S.levelOrder={debug:0,info:1,warn:2,error:3,off:4};let u=S;function Xe(){return{setLevel(r){localStorage.setItem("logLevel",r),location.reload()}}}typeof window<"u"&&(window.logger=Xe());const A=class A{constructor(e){this.ready=!1,this.imgHorizontal=null,this.imgVertical=null,this.loadedHorizontal=!1,this.loadedVertical=!1,typeof window<"u"?(this.imgHorizontal=new Image,this.imgHorizontal.onload=()=>{var t;A.log.debug(`Loaded horizontal image: ${(t=this.imgHorizontal)==null?void 0:t.src}`),this.loadedHorizontal=!0,this.updateReadyState()},this.imgHorizontal.onerror=()=>{var t;this.loadedHorizontal=!1,A.log.error(`Failed to load horizontal image: ${(t=this.imgHorizontal)==null?void 0:t.src}`),this.updateReadyState()},this.imgHorizontal.src=e.horizontal,this.imgVertical=new Image,this.imgVertical.onload=()=>{var t;A.log.debug(`Loaded vertical image: ${(t=this.imgVertical)==null?void 0:t.src}`),this.loadedVertical=!0,this.updateReadyState()},this.imgVertical.onerror=()=>{var t;this.loadedVertical=!1,A.log.error(`Failed to load vertical image: ${(t=this.imgVertical)==null?void 0:t.src}`),this.updateReadyState()},this.imgVertical.src=e.vertical):this.ready=!0}resize(){}updateReadyState(){this.ready=this.loadedHorizontal||this.loadedVertical}update(e,t){if(!this.ready)return!1;const s=t.canvas.width,i=t.canvas.height,o=s/i;let n=null;if(o>=1?n=this.loadedHorizontal?this.imgHorizontal:this.imgVertical:n=this.loadedVertical?this.imgVertical:this.imgHorizontal,!n||!n.complete||n.naturalWidth===0)return!1;const a=n.naturalWidth/n.naturalHeight;let l,c,d=0,f=0;return a>o?(c=i,l=c*a,d=(s-l)/2):(l=s,c=l/a,f=(i-c)/2),t.drawImage(n,d,f,l,c),!0}};A.log=new u("ImageEffect");let z=A;class qe{constructor(e){this.vid=null,typeof document<"u"&&typeof window<"u"&&(this.vid=document.createElement("video"),this.vid.src=e,this.vid.autoplay=!0,this.vid.loop=!0,this.vid.muted=!0,this.vid.style.position="fixed",this.vid.style.top="0",this.vid.style.left="0",this.vid.style.width="100%",this.vid.style.height="100%",this.vid.style.objectFit="cover",this.vid.style.zIndex="-1",document.body.appendChild(this.vid))}resize(){}update(e,t){return!1}dispose(){this.vid&&this.vid.parentNode&&(this.vid.parentNode.removeChild(this.vid),this.vid=null)}}const x=new u("ShaderEffect");class Ke{constructor(e){this.container=null,this.shaderConfig=e,x.debug(`ShaderEffect created with config: ${this.shaderConfig}`)}mount(e){this.container=e;const t=document.createElement("div");t.style.width="100%",t.style.height="100%",t.style.backgroundColor="rgba(50, 0, 50, 0.8)",t.textContent=`Shader Effect: ${this.shaderConfig}`,t.style.color="white",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",this.container.appendChild(t),x.debug("ShaderEffect mounted. Config:",this.shaderConfig)}unmount(){if(this.container){for(;this.container.firstChild;)this.container.removeChild(this.container.firstChild);x.debug("ShaderEffect unmounted.")}this.container=null}resize(e,t,s){x.debug(`ShaderEffect resize called: ${e}x${t} @ ${s}x`)}update(e,t){return x.debug(`ShaderEffect update called with dt: ${e}`),!1}}class Je{constructor(e){this.cls=e,document.body.classList.add(e)}resize(){}update(){return!1}dispose(){document.body.classList.remove(this.cls)}}const ie=Object.assign({"../assets/themes/pastel-pond/background.png":Ae,"../assets/themes/pastel-pond/background1.png":xe,"../assets/themes/pastel-pond/background_horizontal.png":Ee,"../assets/themes/pastel-pond/background_vertical.png":Te,"../assets/themes/pastel-pond/palette.json":ke,"../assets/themes/pastel-pond/theme.json":Ce}),ne=Object.assign({"../assets/themes/pastel-pond/theme.json":Le}),Ze=Object.assign({"../assets/themes/pastel-pond/palette.json":Ie});class et{async load(e){const t=`../${e.endsWith("/")?e:e+"/"}theme.json`.replace(/^\.\.\/\/+/,"../"),s=ne[t];if(!s)throw new Error(`Theme manifest not embedded for base '${e}'. Tried key '${t}'. Available MANIFESTS keys: ${Object.keys(ne).join(", ")}`);const i=s.assets.palette.startsWith("/")?s.assets.palette.substring(1):s.assets.palette,o=`../${e.endsWith("/")?e:e+"/"}${i}`.replace(/^\.\.\/\/+/,"../"),n=Ze[o]??["#ffffff"],a=await this.makeEffect(s.effect,e);return this.current={name:s.name,palette:n,effect:a},He(n),this.current}get theme(){return this.current}async makeEffect(e,t){const s=t.replace(/^assets\/themes\//,"").replace(/\/$/,"");function i(o){const n=`../assets/themes/${s}/${o}`,a=ie[n];if(a===void 0)throw console.error(`[ThemeService] Asset URL not found for key: ${n}`),console.error("[ThemeService] Attempted to load file:",o,"from theme folder:",s),console.error("[ThemeService] Available keys from glob:",Object.keys(ie)),new Error(`Asset URL not found by viteAssetUrl: ${n}. Check theme.json and asset paths.`);return a}if(e.type==="image"){const o=i(e.horizontal),n=i(e.vertical);return new z({horizontal:o,vertical:n})}else if(e.type==="video"){const o=i(e.file);return new qe(o)}else if(e.type==="script")try{const a=(await import(`/src/assets/themes/${s}/${e.file}`))[e.export];if(typeof a=="function")return new a(t);throw new Error(`Export "${e.export}" from script "${e.file}" is not a constructor.`)}catch(o){throw console.error(`Failed to load script effect "${e.file}":`,o),o}else{if(e.type==="shader")return new Ke(e.shader);if(e.type==="css")return new Je(e.class);{const o=e;throw new Error(`ThemeService: unknown effect type: ${JSON.stringify(o)}`)}}}}const D=new et;class tt{constructor(e){this.canvas=e,this.time=0;const t=e.getContext("2d");if(!t)throw new Error("2-D context not available");this.ctx=t,E.watchCanvas(e),E.subscribe(()=>this.paint(0))}paint(e){var i,o,n;this.time+=e,Q(this.ctx);const t=window.devicePixelRatio||1;if(this.ctx.save(),this.ctx.scale(1/t,1/t),!((o=(i=D.theme)==null?void 0:i.effect)==null?void 0:o.update(e,this.ctx))){const{w:a,h:l}=b(this.canvas);this.ctx.fillStyle=((n=D.theme)==null?void 0:n.palette[2])??"#c7ceea",this.ctx.fillRect(0,0,a,l)}this.ctx.restore()}}const st=new u("SM");class it{constructor(){this.states=new Map,this.stack=[]}add(e,t){return this.states.set(e,t),this}async change(e){var t,s;st.info("→ change",{from:this.currentName,to:e}),(t=this.current)!=null&&t.exit&&this.current.exit(),this.current=this.states.get(e),this.currentName=e,(s=this.current)!=null&&s.enter&&await this.current.enter()}update(e){var t,s;(s=(t=this.current)==null?void 0:t.update)==null||s.call(t,e)}get currentStateName(){return this.currentName}async push(e){var t;this.current&&(this.stack.push(this.current),this.current.exit&&this.current.exit()),this.current=this.states.get(e),this.currentName=e,(t=this.current)!=null&&t.enter&&await this.current.enter()}async pop(){var e,t,s;this.stack.length&&((e=this.current)!=null&&e.exit&&this.current.exit(),this.current=this.stack.pop(),this.currentName=this.current?(t=[...this.states.entries()].find(([,i])=>i===this.current))==null?void 0:t[0]:void 0,(s=this.current)!=null&&s.enter&&await this.current.enter())}}class ge{constructor(e,t){this.resizeHandler=this.paint.bind(this),this.sm=e,this.ctx=t}async enter(){E.subscribe(this.resizeHandler),this.paint()}update(e){}exit(){E.unsubscribe(this.resizeHandler)}clear(){const{w:e,h:t}=b(this.ctx.canvas);return this.ctx.clearRect(0,0,e,t),Q(this.ctx),{w:e,h:t}}}const nt={pop:50,error:[50,100,50],success:[50,50,50,50,100],gameOver:[100,50,100,50,300]},B=new u("Storage");class at{constructor(){this.isNative=!1,this.storage=this.detectStorage()}detectStorage(){if(typeof window<"u"&&typeof localStorage=="object")try{const e="__storage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),B.debug("Using native localStorage"),this.isNative=!0,localStorage}catch(e){B.warn("localStorage detected but unavailable (Safari private mode?), using memory storage",e)}else B.info("No localStorage available (Node/test environment), using memory storage");return new Map}get(e){if(this.isNative)return this.storage.getItem(e);const t=this.storage;return t.has(e)?t.get(e):null}set(e,t){this.isNative?this.storage.setItem(e,t):this.storage.set(e,t)}remove(e){this.isNative?this.storage.removeItem(e):this.storage.delete(e)}clear(){this.isNative?this.storage.clear():this.storage.clear()}}const T=new at,p=new u("Haptics");class rt{constructor(){if(this.enabled=T.get("kanaPop.haptics")!=="false"&&Ye,this.debugElement=null,this.lastVibration=0,this.patternArraysOkay=null,!(typeof window>"u"||typeof navigator>"u")){if(window.matchMedia("(prefers-reduced-motion: reduce)").matches){p.info("Haptics disabled due to reduced-motion preference.");return}if(typeof navigator.vibrate=="function"){this.enabled=!0,p.info("Haptic feedback enabled.");const e=()=>{this.updateDebugStatus("Activation gesture received (resume only)")};window.addEventListener("pointerdown",e,{once:!0,passive:!0})}else p.info("Haptic feedback not supported on this device.")}}async vibrate(e=50,t=2){if(!this.enabled)return Promise.resolve(!1);if(this.patternArraysOkay===null)try{navigator.vibrate([1,1])?(navigator.vibrate(0),this.patternArraysOkay=!0,this.updateDebugStatus("Array patterns seem supported.")):(this.patternArraysOkay=!1,this.updateDebugStatus("Array patterns rejected (vibrate returned false)."))}catch(a){this.patternArraysOkay=!1,this.updateDebugStatus(`Array patterns rejected (vibrate threw error: ${a instanceof Error?a.message:String(a)}).`)}const s=Date.now(),i=Array.isArray(e),o=i?Ge:Qe;if(s-this.lastVibration<o)return this.updateDebugStatus(`Throttled (gap: ${o}ms)`),Promise.resolve(!1);let n;if(i)n=e.map(a=>Math.max(a,O)),!this.patternArraysOkay&&n.length>0&&(n=Math.max(...n,O),this.updateDebugStatus("Collapsed array to single max pulse for compatibility."));else{const a=Math.max(e,O),l=We;switch(t){case 1:n=a;break;case 2:n=Math.min(a*1.5,150);break;case 3:n=this.patternArraysOkay?[a,l,a]:a*2;break;default:return p.warn(`Invalid intensity: ${t} for numeric pattern.`),Promise.resolve(!1)}}try{return Array.isArray(n)&&n.length===0?(p.warn("Attempted to vibrate with an empty pattern array."),Promise.resolve(!1)):typeof n=="number"&&n===0&&e!==0?(p.warn("Calculated vibration duration is zero, skipping."),Promise.resolve(!1)):navigator.vibrate(n)?(this.lastVibration=s,this.updateDebugStatus(`Vibrated: ${JSON.stringify(n)}`),p.info("Vibrating with:",{originalPattern:e,intensity:t,actualVibration:n}),Promise.resolve(!0)):(this.updateDebugStatus("navigator.vibrate() returned false."),p.warn("navigator.vibrate() returned false for pattern:",n),Promise.resolve(!1))}catch(a){return p.warn("Vibration failed with error:",a),this.updateDebugStatus(`Failed: ${a instanceof Error?a.message:String(a)}`),Array.isArray(n)&&this.patternArraysOkay&&(this.patternArraysOkay=!1,this.updateDebugStatus("Error with array vibration, marked arrays as not okay for future.")),Promise.resolve(!1)}}isSupported(){return this.enabled}createDebugElement(){var t;if(typeof document>"u")return;const e=`${Ve}Haptics`;(t=document.getElementById(e))==null||t.remove(),this.debugElement=document.createElement("div"),this.debugElement.id=e,this.debugElement.style.position="fixed",this.debugElement.style.bottom="30px",this.debugElement.style.left="10px",this.debugElement.style.background="rgba(0,0,0,0.5)",this.debugElement.style.color="white",this.debugElement.style.padding="5px",this.debugElement.style.fontSize="12px",this.debugElement.style.zIndex="9999",this.debugElement.style.pointerEvents="none",document.body.appendChild(this.debugElement)}updateDebugStatus(e){this.debugElement&&(this.debugElement.textContent=`Haptics: ${e}`)}vibratePattern(e){const t=nt[e];return typeof t=="number"?this.vibrate(t):this.vibrate([...t])}setEnabled(e){this.enabled=e,T.set("kanaPop.haptics",String(e)),e||navigator.vibrate(0)}isEnabled(){return this.enabled}}const F=new rt;class ot{constructor(e){this.onClose=e,this.overlay=document.createElement("div"),this.overlay.style.cssText=`
      position:fixed;inset:0;background:rgba(0,0,0,.6);
      color:${G};display:flex;flex-direction:column;
      align-items:center;justify-content:center;
      font:18px sans-serif;z-index:50`,this.overlay.innerHTML=`
      <h2 style="margin:0 0 20px">Settings</h2>
      <label style="margin-bottom:15px;display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="hapticsToggle">
        Haptics
      </label>
      <button id="close">Close</button>`,this.overlay.querySelector("#close").addEventListener("click",()=>this.toggle());const t=this.overlay.querySelector("#hapticsToggle");t.addEventListener("change",()=>{F.setEnabled(t.checked)})}toggle(){document.body.contains(this.overlay)?this.hide():this.show()}show(){document.body.appendChild(this.overlay);const e=this.overlay.querySelector("#hapticsToggle");e.checked=F.isEnabled()}hide(){this.overlay.remove(),this.onClose()}}class ct extends ge{constructor(){super(...arguments),this.settings=new ot(()=>{}),this.enter=async()=>{document.body.dataset.scene="home",await super.enter(),window.addEventListener("pointerdown",this.onTap)},this.exit=()=>{window.removeEventListener("pointerdown",this.onTap),this.settings.hide(),delete document.body.dataset.scene,super.exit()},this.onTap=e=>{const{w:t,h:s}=b(this.ctx.canvas),{offsetX:i,offsetY:o}=e;i>t-60&&o>s-60?this.settings.toggle():this.sm.change("play")}}paint(){const{w:e,h:t}=this.clear();this.ctx.fillStyle=G,this.ctx.textAlign="center",this.ctx.font="32px sans-serif",this.ctx.fillText("Tap to Start",e/2,t/2),this.ctx.font="20px sans-serif",this.ctx.fillText("⚙︎",e-30,t-30)}}function lt(){if(typeof navigator>"u")return!1;const r=typeof navigator>"u"?"":navigator.userAgent;return/iPad|iPhone|iPod/.test(r)&&!(typeof window<"u"&&window.MSStream)}function ht(){if(typeof navigator>"u")return!1;const r=typeof navigator>"u"?"":navigator.userAgent;return/iPad/.test(r)||typeof navigator<"u"&&navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1}function N(){if(typeof navigator>"u")return!1;if(lt()||ht())return!0;const r=typeof navigator>"u"?"":navigator.userAgent;return!!(/iPad|iPhone|iPod/.test(r)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>0)}const w=new u("Audio");class dt{constructor(){this.bank=new Map}async ensureContext(){const e=()=>{const t=globalThis,s=t.AudioContext??t.webkitAudioContext;if(!s)throw new Error("Web Audio API not supported");const i=new s;return w.info(`Created new AudioContext: ${i.state}`),i};if((!this.ctx||this.ctx.state==="closed")&&(this.ctx=e()),this.ctx.state==="suspended"||this.ctx.state==="interrupted"){w.info(`Attempting resume() from ${this.ctx.state}`);try{await this.ctx.resume()}catch(t){w.warn("resume() threw",t)}}if(this.ctx.state!=="running"){w.warn(`AudioContext stuck in '${this.ctx.state}', recreating…`);try{await this.ctx.close()}catch{}this.ctx=e(),await this.ctx.resume()}return this.ctx}async fetch(e){if(this.bank.has(e))return this.bank.get(e);try{const t=await(await fetch(e)).arrayBuffer(),i=await(await this.ensureContext()).decodeAudioData(t);return this.bank.set(e,i),i}catch(t){throw w.error(`decodeAudioData failed for ${e}`,t),t}}async play(e){const t=await this.ensureContext(),s=t.createBufferSource();s.buffer=e,s.connect(t.destination),s.start(),s.onended=()=>s.disconnect()}async resume(){try{const e=await this.ensureContext();if(N()){w.info("iOS/iPadOS detected, playing silent buffer to unlock audio");const t=e.sampleRate||44100,s=e.createBuffer(2,t*.5,t);for(let a=0;a<2;a++){const l=s.getChannelData(a);for(let c=0;c<l.length;c++)l[c]=0}const i=N()?.5:.1,o=e.createGain();o.gain.value=.001;const n=e.createBufferSource();n.buffer=s,n.connect(o),o.connect(e.destination),n.start(0),n.stop(e.currentTime+i),n.onended=()=>{n.disconnect(),o.disconnect()},w.info(`Silent buffer played (duration: ${i}s)`)}return e}catch(e){throw w.error("Resume failed",e),e}}}class ut{constructor(){this.tasks=[]}add(e){this.tasks.push(e)}async run(e,t=!0){if(this.tasks.length===0){e(1);return}if(t){let s=0;await Promise.all(this.tasks.map(i=>i().then(()=>{e(++s/this.tasks.length)})))}else for(let s=0;s<this.tasks.length;s++){const i=this.tasks[s];await i(),e((s+1)/this.tasks.length)}this.tasks=[]}}const Y=new ut,ft="modulepreload",mt=function(r){return"/kana-pop/"+r},ae={},re=function(e,t,s){let i=Promise.resolve();if(t&&t.length>0){let n=function(c){return Promise.all(c.map(d=>Promise.resolve(d).then(f=>({status:"fulfilled",value:f}),f=>({status:"rejected",reason:f}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),l=(a==null?void 0:a.nonce)||(a==null?void 0:a.getAttribute("nonce"));i=n(t.map(c=>{if(c=mt(c),c in ae)return;ae[c]=!0;const d=c.endsWith(".css"),f=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${f}`))return;const y=document.createElement("link");if(y.rel=d?"stylesheet":ft,d||(y.as="script"),y.crossOrigin="",y.href=c,l&&y.setAttribute("nonce",l),document.head.appendChild(y),d)return new Promise((ye,we)=>{y.addEventListener("load",ye),y.addEventListener("error",()=>we(new Error(`Unable to preload CSS for ${c}`)))})}))}function o(n){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=n,window.dispatchEvent(a),!a.defaultPrevented)throw n}return i.then(n=>{for(const a of n||[])a.status==="rejected"&&o(a.reason);return e().catch(o)})},v=class v{static async manifest(){if(!this.manifestPromise){if(!v.loadManifest)throw new Error("Manifest loader not found. Check glob pattern and file existence.");this.manifestPromise=v.loadManifest()}return this.manifestPromise}static async language(e){const t=`../data/lang/${e}.json`,s=v.langFiles[t];if(!s)throw new Error(`No language data file for '${e}'`);return s()}};v.manifestPromise=null,v.langFiles=Object.assign({"../data/lang/ja.json":()=>re(()=>import("./ja-DEJkL8aw.js"),[]).then(e=>e.default)}),v.loadManifest=Object.assign({"../data/lang/index.json":()=>re(()=>import("./index-BJLXKDTG.js"),[]).then(e=>e.default)})["../data/lang/index.json"];let I=v;const L=new u("Lang");class gt{constructor(){var s;const e=T.get("kanaPop.lang"),t=typeof navigator<"u"?(s=navigator.language)==null?void 0:s.slice(0,2):void 0;this.defaultCode=e||t||"ja",this.lang={code:this.defaultCode,name:"loading…",symbols:[],direction:"ltr"},this.initialLoadPromise=new Promise(i=>{this.initialLoadResolve=i}),Y.add(async()=>{L.info(`LanguageService: Starting initial load for language code '${this.defaultCode}'...`),await this.load(this.defaultCode),L.info("LanguageService: Initial load completed.")})}async load(e=this.defaultCode){const t=await I.manifest(),s=t.find(n=>n.code===e)??t.find(n=>n.code===this.defaultCode);if(!s)throw new Error("LanguageService: manifest empty");const i=await I.language(s.code);s.direction||L.warn(`'${s.code}' lacks "direction"; defaulting to 'ltr'`);const o=s.direction??"ltr";this.lang={code:s.code,name:s.name,symbols:i.symbols??[],direction:o},this.persistLang(this.lang.code),this.initialLoadResolve&&this.initialLoadResolve()}get symbols(){return this.lang.symbols}get currentCode(){return this.lang.code}get direction(){return this.lang.direction}randomGlyph(e){const t=Object.values(e.glyphs);return t.length===0?(L.warn(`Symbol with roman='${e.roman}' (category: ${e.category}, lang: ${this.lang.code}) has no glyphs defined. Returning '?' as fallback.`),"?"):t[Math.floor(Math.random()*t.length)]}persistLang(e){T.set("kanaPop.lang",e)}ready(){return this.initialLoadPromise}}const m=new gt,h=new u("Sound"),$=class ${constructor(){this.bank=new dt,this.isGestureArmed=!1,this.assetLoadCompletedPromise=new Promise(e=>{this.assetLoadCompletedResolve=e}),Y.add(async()=>{h.info("SoundService: Waiting for LanguageService to be ready..."),await m.ready(),h.info("SoundService: LanguageService is ready. Starting sound preload...");const e=m.symbols.map(t=>`${m.currentCode}/${t.audio}`);if(e.length>0)try{await this.preloadAll(e),h.info(`SoundService: Successfully preloaded ${e.length} sounds for language '${m.currentCode}'.`)}catch(t){h.error("SoundService: Error during sound preloading.",t)}else h.info(`SoundService: No sounds to preload for language '${m.currentCode}'.`);this.assetLoadCompletedResolve()}),this.ready=new Promise(e=>this.triggerReady=e),typeof document<"u"&&document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&(h.debug("Page became visible – poking AudioContext"),this.bank.ensureContext().catch(()=>{}))})}async armFirstGesture(e=window){if(this.isGestureArmed)return;this.isGestureArmed=!0,h.info("First gesture handler armed");const t=N(),s=[],i=(a,l)=>{a.addEventListener(l,n,{passive:!0}),s.push({target:a,type:l})},o=()=>{h.info("Trimming audio unlock listeners (keeping one for re-unlock)");let a=!1;s.forEach(({target:l,type:c})=>{if(!a&&l===window&&c==="pointerdown"){a=!0;return}l.removeEventListener(c,n)})},n=async()=>{h.info("User gesture detected, unlocking audio");let a=!1;try{await this.bank.resume(),h.info("Audio context unlocked successfully"),a=!0}catch(l){h.warn("AudioContext unlock failed, trying HTML Audio fallback",l);try{const c=new Audio($.SILENT);c.autoplay=!0,c.muted=!1,c.volume=.001,c.setAttribute("playsinline",""),h.info("Playing fallback HTML audio");const d=c.play();if(d instanceof Promise){await d,h.info("Fallback audio played successfully");try{await this.bank.resume(),h.info("Audio context unlocked after HTML audio fallback"),a=!0}catch(f){h.warn("Audio context still locked after HTML audio fallback",f)}}else h.warn("Fallback audio play() returned no promise")}catch(c){h.error("All audio unlock attempts failed",c)}}this.triggerReady(),a?o():h.warn("Audio still locked – listeners stay armed for another try")};h.info("Registering audio unlock gesture handlers"),i(e,"pointerdown"),i(e,"touchstart"),i(e,"click"),t&&(h.info("Adding extra handlers for iOS/iPadOS"),i(document.body,"pointerdown"),i(document.body,"touchstart"),i(document.body,"click"),i(document,"pointerdown"),i(document,"touchstart"),i(document,"click"),i(window,"pointerdown"),i(window,"touchstart"),i(window,"click"))}async play(e){if(await this.ready,e.endsWith("fallback.mp3"))return;const t=oe(`/kana-pop/audio/${e}`);try{const s=await this.bank.fetch(t);await this.bank.play(s)}catch(s){h.warn(`Web Audio playback failed for ${t}, using HTMLAudioElement fallback`,s),new Audio(t).play().catch(i=>{h.error(`HTMLAudioElement fallback also failed for ${t}`,i)})}}playRoman(e){var s;const t=(s=m.symbols.find(i=>i.roman===e))==null?void 0:s.audio;t&&this.play(`${m.currentCode}/${t}`)}async preloadAll(e){await this.ready,h.info(`Preloading ${e.length} audio files`),await Promise.all(e.map(t=>{if(t.endsWith("fallback.mp3"))return Promise.resolve();const s=oe(`/kana-pop/audio/${t}`);return this.bank.fetch(s).catch(i=>{h.warn(`Failed to preload audio: ${t}`,i)})})),h.info("Audio preloading complete")}assetsReady(){return this.assetLoadCompletedPromise}};$.SILENT="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAIlYAACJWAAABAAgAZGF0YQAAAAA=";let U=$;const pe=new U;function oe(r){return r.startsWith("data:")?r:`${r}?v=mbkr4ave`}const ce=new u("Bubble");class pt{constructor(e,t,s,i,o,n){this.x=e,this.y=t,this.color=s,this.glyph=i,this.romaji=o,this.active=!0,this.speed=.2,this._scale=1,this.animPhase="none",this.animTime=0,this.textScale=1,this.textOpacity=1,this.isTextTransitioning=!1,this.textTransitionTime=0,this.flashTimer=0,this.showingRomaji=!1,this.lastSpoken=-1/0,this.r=n,ce.debug("spawn",{x:this.x.toFixed(2),color:s,glyph:this.glyph})}handleClick(e){e-this.lastSpoken<Ne||(this.lastSpoken=e,F.vibratePattern("pop").catch(()=>{}),this.triggerTapAnimation(),this.startTextTransition(),pe.playRoman(this.romaji),this.flashTimer=ee,ce.debug("toggle",{romaji:this.showingRomaji}))}triggerTapAnimation(){this.animPhase="squash",this.animTime=0,this.scale=1,this.textScale=_}startTextTransition(){this.isTextTransitioning=!0,this.textTransitionTime=te,this.textOpacity=0}step(e){switch(this.y-=this.speed*e,this.y<-.05&&(this.active=!1),this.animPhase){case"squash":if(this.animTime+=e,this.animTime>=K)this.animTime=0,this.animPhase="stretch",this.scale=_;else{const t=this.animTime/K;this.scale=M(1,_,j(t))}break;case"stretch":if(this.animTime+=e,this.animTime>=J)this.animTime=0,this.animPhase="settle",this.scale=H;else{const t=this.animTime/J;this.scale=M(_,H,j(t))}break;case"settle":if(this.animTime+=e,this.animTime>=Z)this.animTime=0,this.animPhase="none",this.scale=1;else{const t=this.animTime/Z;this.scale=M(H,1,j(t))}break}this.flashTimer>0&&(this.flashTimer-=e,this.flashTimer<0&&(this.flashTimer=0)),this.isTextTransitioning?(this.textTransitionTime-=e,this.textTransitionTime<=0?(this.showingRomaji=!this.showingRomaji,this.isTextTransitioning=!1,this.textOpacity=1,this.textScale=1):this.textOpacity=Math.max(0,this.textTransitionTime/te)):this.textScale<1&&(this.textScale=Math.min(1,this.textScale+e*5))}contains(e,t,s,i){if(!this.active)return!1;const o=this.x*s,n=this.y*i,a=e-o,l=t-n,c=a*a+l*l,d=this.r*this.scale;return c<=d*d}get flashAlpha(){return this.flashTimer>0?this.flashTimer/ee:0}get currentTextOpacity(){return this.textOpacity}get currentTextScale(){return this.textScale}get scale(){return this._scale}set scale(e){this._scale=e}}function M(r,e,t){return r+(e-r)*t}function j(r){return r<1?1-(1-r)*(1-r):1}function le(r,e){return Math.min(r,e)*ze}const bt=new u("BubbleMgr"),be=r=>Math.floor(Math.random()*r),yt=()=>{const r=Be();return r.length===0?"#ffffff":r[be(r.length)]??"#ffffff"};class wt{constructor(e){this.canvas=e,this.bubbles=[],this.spawnTimer=0,this.rPx=0;const{w:t,h:s}=b(e);this.rPx=le(t,s)}get entities(){return this.bubbles}update(e){this.spawnTimer-=e,this.spawnTimer<=0&&(this.spawn(),this.spawnTimer=$e),this.bubbles.forEach(t=>t.step(e)),this.bubbles.some(t=>!t.active)&&(this.bubbles=this.bubbles.filter(t=>t.active))}handleResize(){const{w:e,h:t}=b(this.canvas);this.rPx=le(e,t),this.bubbles.forEach(s=>s.r=this.rPx)}hitTest(e,t){const{w:s,h:i}=b(this.canvas);for(let o=this.bubbles.length-1;o>=0;o--){const n=this.bubbles[o];if(n&&n.contains(e,t,s,i))return n}}clear(){this.bubbles=[]}spawn(){var a;if(!((a=m.symbols)!=null&&a.length))return;const e=m.symbols[be(m.symbols.length)],t=m.randomGlyph(e),{w:s}=b(this.canvas),i=this.rPx/s,o=i+Math.random()*(1-2*i),n=1+i;this.bubbles.push(new pt(o,n,yt(),t,e.roman,this.rPx)),bt.debug("spawn",{total:this.bubbles.length,roman:e.roman})}}class vt{render(e,t,s,i,o){const n=t.x*s,a=t.y*i,l=t.r*t.scale;e.save(),e.globalAlpha=Re,e.fillStyle=t.color,e.beginPath(),e.beginPath(),e.arc(n,a,l,0,Math.PI*2),e.fill(),e.restore();const c=t.showingRomaji?t.romaji:t.glyph,d=t.showingRomaji?Fe:De,f=Math.round(t.r*t.currentTextScale*d);e.save(),e.fillStyle=je,e.globalAlpha=t.currentTextOpacity,e.textAlign="center",e.textBaseline="middle",e.font=`${f}px ${Me}`,e.fillText(c,n,a),e.restore(),t.flashAlpha>0&&(e.save(),e.globalAlpha=t.flashAlpha*Ue,e.lineWidth=se,e.strokeStyle="#ffffff",e.beginPath(),e.arc(n,a,l+se*.5,0,Math.PI*2),e.stroke(),e.restore())}}const St=new u("Pointer");class At{constructor(e,t){this.canvas=e,this.bubbles=t,this.bound=this.onDown.bind(this)}attach(){this.canvas.addEventListener("pointerdown",this.bound)}detach(){this.canvas.removeEventListener("pointerdown",this.bound)}onDown(e){var n,a;const t=this.canvas.getBoundingClientRect(),s="clientX"in e?e.clientX:((n=e.touches[0])==null?void 0:n.clientX)??0,i="clientY"in e?e.clientY:((a=e.touches[0])==null?void 0:a.clientY)??0,o=this.bubbles.hitTest(s-t.left,i-t.top);o&&(o.handleClick(performance.now()/1e3),St.debug("hit",{roman:o.romaji}))}}class xt extends ge{constructor(){super(...arguments),this.bubbles=new wt(this.ctx.canvas),this.renderer=new vt,this.input=new At(this.ctx.canvas,this.bubbles)}async enter(){await super.enter(),this.bubbles.handleResize(),this.input.attach()}update(e){const{w:t,h:s}=b(this.ctx.canvas);this.ctx.clearRect(0,0,t,s),Q(this.ctx),this.bubbles.update(e),this.bubbles.entities.forEach(i=>this.renderer.render(this.ctx,i,t,s))}exit(){this.input.detach(),this.bubbles.clear(),super.exit()}paint(){}}let g=null,P=null;const X=document.querySelector("#game");if(!X)throw new Error("#game canvas not found");const V=X.getContext("2d");if(!V)throw new Error("2-D context not available");const q=document.createElement("canvas");q.id="bg";document.body.prepend(q);function W(){document.documentElement.style.setProperty("--app-height",`${window.innerHeight}px`)}document.readyState==="loading"?window.addEventListener("DOMContentLoaded",W,{once:!0}):W();window.addEventListener("resize",W);pe.armFirstGesture(window);E.watchCanvas(X);(async()=>{const r=T.get("kanaPop.theme")??"assets/themes/pastel-pond/";await D.load(r),g=new it,g.add("home",new ct(g,V)).add("play",new xt(g,V)),P=new tt(q),await g.change("home"),Y.run(()=>{}).catch(console.error),C=performance.now(),k=requestAnimationFrame(R)})();let k=0,C=performance.now();function R(r){const e=(r-C)/1e3;C=r,P==null||P.paint(e),g==null||g.update(e),k=requestAnimationFrame(R)}document.addEventListener("visibilitychange",()=>{document.hidden?cancelAnimationFrame(k):(C=performance.now(),k=requestAnimationFrame(R))});document.addEventListener("scenechange",r=>{const{nextScene:e}=r.detail;g&&g.change(e),C=performance.now(),k=requestAnimationFrame(R)});
