(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(s){if(s.ep)return;s.ep=!0;const r=t(s);fetch(s.href,r)}})();function te(i){const e=window.devicePixelRatio||1,{clientWidth:t,clientHeight:n}=i;return i.width=Math.floor(t*e),i.height=Math.floor(n*e),{w:t,h:n,dpr:e}}class ne{constructor(){this.listeners=new Set,this.watchedCanvases=new Map,this.mediaQuery=null,this.boundTrigger=this.trigger.bind(this),this.dprCallback=null,this.metrics={w:0,h:0,dpr:1}}subscribe(e){this.listeners.add(e),e(),this.listeners.size===1&&this.attachWindowListeners()}unsubscribe(e){this.listeners.delete(e),this.listeners.size===0&&this.detachWindowListeners()}watchCanvas(e){const t=()=>{const n=te(e);this.metrics=n};this.watchedCanvases.set(e,t),this.subscribe(t)}unwatchCanvas(e){const t=this.watchedCanvases.get(e);t&&(this.unsubscribe(t),this.watchedCanvases.delete(e))}trigger(){this.listeners.forEach(e=>e())}attachWindowListeners(){window.addEventListener("resize",this.boundTrigger),this.addDprListener()}detachWindowListeners(){var e;window.removeEventListener("resize",this.boundTrigger),this.dprCallback&&((e=this.mediaQuery)==null||e.removeEventListener("change",this.dprCallback)),this.mediaQuery=null,this.dprCallback=null}addDprListener(){var e;this.dprCallback&&((e=this.mediaQuery)==null||e.removeEventListener("change",this.dprCallback)),this.mediaQuery=matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`),this.dprCallback=()=>{this.boundTrigger(),this.addDprListener()},this.mediaQuery.addEventListener("change",this.dprCallback,{once:!0})}get cssWidth(){return this.metrics.w}get cssHeight(){return this.metrics.h}get dpr(){return this.metrics.dpr}}const L=new ne,se=["#FFD1DC","#B5EAD7","#C7CEEA","#FFDAC1","#E2F0CB"],ie={colors:se},re=1.2,ae=.5,$=ie.colors,z=$[2],G="#222";function B(){const i=L.cssWidth||window.innerWidth,e=L.cssHeight||window.innerHeight;return Math.min(i,e)*.06}const q="Noto Sans JP, sans-serif",Q=G,oe=.7,A=class A{constructor(e,t=A.bootLevel){this.scope=e,this.level=t}out(e,...t){}debug(...e){this.out("debug",...e)}info(...e){this.out("info",...e)}warn(...e){this.out("warn",...e)}error(...e){this.out("error",...e)}};A.bootLevel=(()=>{const e=localStorage.getItem("logLevel");return e&&["debug","info","warn","error","off"].includes(e)?e:"info"})(),A.isDebug=A.bootLevel==="debug",A.levelOrder={debug:0,info:1,warn:2,error:3,off:4};let m=A;function le(){return{setLevel(i){localStorage.setItem("logLevel",i),location.reload()}}}window.logger=le();const ce=new m("SM");class de{constructor(){this.states=new Map}add(e,t){return this.states.set(e,t),this}change(e){var t,n,s,r;ce.info("→ change",{from:this.currentName,to:e}),(n=(t=this.current)==null?void 0:t.exit)==null||n.call(t),this.current=this.states.get(e),this.currentName=e,(r=(s=this.current)==null?void 0:s.enter)==null||r.call(s)}update(e){var t,n;(n=(t=this.current)==null?void 0:t.update)==null||n.call(t,e)}get currentStateName(){return this.currentName}}function C(i){const{clientWidth:e,clientHeight:t}=i;return{w:e,h:t}}function Y(i){const e=window.devicePixelRatio||1;i.setTransform(1,0,0,1,0,0),i.scale(e,e)}function ue(i,e){const t=()=>i.change("play");function n(){Y(e);const{w:s,h:r}=C(e.canvas);e.fillStyle=z,e.fillRect(0,0,s,r),e.fillStyle=G,e.textAlign="center",e.font="32px sans-serif",e.fillText("Tap to Start",s/2,r/2)}return{enter(){L.subscribe(n),e.canvas.addEventListener("pointerdown",t),e.canvas.addEventListener("touchstart",t)},update(){n()},exit(){L.unsubscribe(n),e.canvas.removeEventListener("pointerdown",t),e.canvas.removeEventListener("touchstart",t)}}}const I=new m("Bubble");class he{constructor(e,t,n,s,r){this.x=e,this.y=t,this.color=n,this.glyph=s,this.romaji=r,this.active=!0,this.speed=.2,I.debug("spawn",{x:this.x.toFixed(2),color:n,glyph:this.glyph})}pop(){I.info("pop!"),this.active=!1}step(e){this.y-=this.speed*e,this.y<-.05&&(this.active=!1)}contains(e,t,n,s){if(!this.active)return!1;const r=this.x*n,a=this.y*s,o=e-r,p=t-a,u=o*o+p*p,f=B();return u<=f*f}}class fe{constructor(){}update(e){}draw(e){const{w:t,h:n}=C(e.canvas);e.fillStyle=z,e.fillRect(0,0,t,n)}}class ge{render(e,t){const{w:n,h:s}=C(e.canvas),r=t.x*n,a=t.y*s,o=B();e.save(),e.globalAlpha=ae,e.fillStyle=t.color,e.beginPath(),e.arc(r,a,o,0,Math.PI*2),e.fill(),e.restore(),e.fillStyle=Q,e.textAlign="center",e.textBaseline="middle",e.font=`${Math.round(o*oe)}px ${q}`,e.fillText(t.glyph,r,a)}}const me="modulepreload",pe=function(i){return"/kana-pop/"+i},_={},j=function(e,t,n){let s=Promise.resolve();if(t&&t.length>0){let a=function(u){return Promise.all(u.map(f=>Promise.resolve(f).then(c=>({status:"fulfilled",value:c}),c=>({status:"rejected",reason:c}))))};document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),p=(o==null?void 0:o.nonce)||(o==null?void 0:o.getAttribute("nonce"));s=a(t.map(u=>{if(u=pe(u),u in _)return;_[u]=!0;const f=u.endsWith(".css"),c=f?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${c}`))return;const d=document.createElement("link");if(d.rel=f?"stylesheet":me,f||(d.as="script"),d.crossOrigin="",d.href=u,p&&d.setAttribute("nonce",p),document.head.appendChild(d),f)return new Promise((l,b)=>{d.addEventListener("load",l),d.addEventListener("error",()=>b(new Error(`Unable to preload CSS for ${u}`)))})}))}function r(a){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=a,window.dispatchEvent(o),!o.defaultPrevented)throw a}return s.then(a=>{for(const o of a||[])o.status==="rejected"&&r(o.reason);return e().catch(r)})},K=[{code:"ja",name:"Japanese · Kana",direction:"ltr"},{code:"ar",name:"Arabic",direction:"rtl"}],be=Object.freeze(Object.defineProperty({__proto__:null,default:K},Symbol.toStringTag,{value:"Module"})),O=new m("Storage");class we{constructor(){this.isNative=!1,this.storage=this.detectStorage()}detectStorage(){if(typeof window<"u"&&typeof localStorage=="object")try{const e="__storage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),O.debug("Using native localStorage"),this.isNative=!0,localStorage}catch(e){O.warn("localStorage detected but unavailable (Safari private mode?), using memory storage",e)}else O.info("No localStorage available (Node/test environment), using memory storage");return new Map}get(e){if(this.isNative)return this.storage.getItem(e);const t=this.storage;return t.has(e)?t.get(e):null}set(e,t){this.isNative?this.storage.setItem(e,t):this.storage.set(e,t)}remove(e){this.isNative?this.storage.removeItem(e):this.storage.delete(e)}clear(){this.isNative?this.storage.clear():this.storage.clear()}}const D=new we,y=new m("Lang"),S=K,ye=Object.assign({"../data/lang/index.json":()=>j(()=>Promise.resolve().then(()=>be),void 0).then(i=>i.default),"../data/lang/ja.json":()=>j(()=>import("./ja-DEJkL8aw.js"),[]).then(i=>i.default)});class ve{constructor(){var s;const e=D.get("kanaPop.lang"),t=(s=navigator.language)==null?void 0:s.slice(0,2);this.defaultCode=e||t||"ja";let n=S.find(r=>r.code===this.defaultCode);n||(y.warn(`Default code '${this.defaultCode}' not in manifest. Falling back to first manifest entry or 'ja'.`),n=S.find(r=>r.code==="ja")||S[0]),n?this.lang={code:n.code,name:n.name,symbols:[],direction:n.direction}:(y.error("CRITICAL - Language manifest is empty or essential fallbacks are missing. App functionality will be severely impaired."),this.lang={code:this.defaultCode,name:"Error: Language Undefined",symbols:[],direction:"ltr"})}async load(e=this.defaultCode){const t=S.find(a=>a.code===e);if(!t){if(y.error(`Language code '${e}' not found in manifest. Attempting to fall back.`),e!==this.defaultCode&&S.find(o=>o.code===this.defaultCode))return y.warn(`Falling back to default language '${this.defaultCode}'.`),this.load(this.defaultCode);throw new Error(`LanguageService: Language code '${e}' (and default '${this.defaultCode}') not found in manifest.`)}if(e==="index")throw new Error("LanguageService: index.json is the manifest, not a language data file.");const n=`../data/lang/${e}.json`,s=ye[n];if(!s)throw y.error(`No data file loader found for code '${e}' (path: '${n}'). Check glob pattern and file existence.`),new Error(`LanguageService: No data file loader for '${e}'.`);let r;try{r=await s()}catch(a){throw y.error(`Failed to load language data file for code '${e}' from '${n}'.`,a),new Error(`LanguageService: Failed to load data for '${e}'.`)}this.lang={symbols:r.symbols||[],code:t.code||r.code,name:t.name,direction:t.direction},r.code&&r.code!==t.code&&(y.warn(`Mismatch! Requested/Manifest code '${t.code}', but file contains code '${r.code}'. Prioritizing manifest code.`),this.lang.code=t.code),this.persistLang(this.lang.code)}get symbols(){return this.lang.symbols}get currentCode(){return this.lang.code}get direction(){return this.lang.direction}randomGlyph(e){const t=Object.values(e.glyphs);return t.length===0?(y.warn(`Symbol with roman='${e.roman}' (category: ${e.category}, lang: ${this.lang.code}) has no glyphs defined. Returning '?' as fallback.`),"?"):t[Math.floor(Math.random()*t.length)]}persistLang(e){D.set("kanaPop.lang",e)}}const g=new ve;function Ae(){if(typeof navigator>"u")return!1;const i=navigator.userAgent;return/iPad|iPhone|iPod/.test(i)&&!window.MSStream}function X(){if(typeof navigator>"u")return!1;const i=navigator.userAgent;return/iPad/.test(i)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1}function Le(){if(typeof navigator>"u")return!1;const i=navigator.userAgent;return/Safari/.test(i)&&!/Chrome/.test(i)}function J(){return Ae()||X()}const v=new m("Audio");class Ce{constructor(){this.bank=new Map}async ensureContext(){if(!this.ctx){const e=globalThis,t=e.AudioContext??e.webkitAudioContext;if(!t)throw new Error("Web Audio API not supported");this.ctx=new t,v.info(`Created new AudioContext: ${this.ctx.state}`)}if(this.ctx.state==="suspended"){v.info(`Attempting to resume AudioContext from ${this.ctx.state} state`);try{await this.ctx.resume(),v.info(`AudioContext resumed: ${this.ctx.state}`)}catch(e){throw v.error("Failed to resume AudioContext",e),e}}return this.ctx}async fetch(e){if(this.bank.has(e))return this.bank.get(e);try{const t=await(await fetch(e)).arrayBuffer(),s=await(await this.ensureContext()).decodeAudioData(t);return this.bank.set(e,s),s}catch(t){throw v.error(`decodeAudioData failed for ${e}`,t),t}}async play(e){const t=await this.ensureContext(),n=t.createBufferSource();n.buffer=e,n.connect(t.destination),n.start(),n.onended=()=>n.disconnect()}async resume(){try{const e=await this.ensureContext();if(J()){v.info("iOS/iPadOS detected, playing silent buffer to unlock audio");const t=e.sampleRate||44100,n=e.createBuffer(1,t*.1,t),s=X()&&Le()?.05:.001,r=e.createGain();r.gain.value=0;const a=e.createBufferSource();a.buffer=n,a.connect(r),r.connect(e.destination),a.start(0),a.stop(e.currentTime+s),a.onended=()=>{a.disconnect(),r.disconnect()},v.info(`Silent buffer played (duration: ${s}s)`)}return e}catch(e){throw v.error("Resume failed",e),e}}}const h=new m("Sound"),F=class F{constructor(){this.bank=new Ce,this.isGestureArmed=!1,this.ready=new Promise(e=>this.triggerReady=e)}async armFirstGesture(e=window){if(this.isGestureArmed)return;this.isGestureArmed=!0,h.info("First gesture handler armed");const t=async()=>{h.info("User gesture detected, unlocking audio");try{await this.bank.resume(),h.info("Audio context unlocked successfully"),this.triggerReady(),["pointerdown","touchstart"].forEach(n=>{e.removeEventListener(n,t),document.removeEventListener(n,t)})}catch(n){h.warn("AudioContext unlock failed, trying HTML Audio fallback",n);try{const s=new Audio(F.SILENT);s.muted=!0,s.setAttribute("playsinline",""),s.setAttribute("autoplay","");const r=s.play();r instanceof Promise?(await r,h.info("Fallback audio played successfully")):h.warn("Fallback audio play() returned no promise"),await this.bank.resume(),this.triggerReady()}catch(s){h.error("All audio unlock attempts failed",s),this.triggerReady()}}};h.info("Registering audio unlock gesture handlers"),e.addEventListener("pointerdown",t,{once:!0,passive:!0}),e.addEventListener("touchstart",t,{once:!0,passive:!0}),J()&&document.addEventListener("touchstart",t,{once:!0,passive:!0})}async play(e){if(await this.ready,e.endsWith("fallback.mp3"))return;const t=W(`/kana-pop/audio/${e}`);try{const n=await this.bank.fetch(t);await this.bank.play(n)}catch(n){h.warn(`Web Audio playback failed for ${t}, using HTMLAudioElement fallback`,n),new Audio(t).play().catch(s=>{h.error(`HTMLAudioElement fallback also failed for ${t}`,s)})}}playRoman(e){var n;const t=(n=g.symbols.find(s=>s.roman===e))==null?void 0:n.audio;t&&this.play(`${g.currentCode}/${t}`)}async preloadAll(e){await this.ready,h.info(`Preloading ${e.length} audio files`),await Promise.all(e.map(t=>{if(t.endsWith("fallback.mp3"))return Promise.resolve();const n=W(`/kana-pop/audio/${t}`);return this.bank.fetch(n).catch(s=>{h.warn(`Failed to preload audio: ${t}`,s)})})),h.info("Audio preloading complete")}};F.SILENT="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAIlYAACJWAAABAAgAZGF0YQAAAAA=";let N=F;const x=new N;function W(i){return i.startsWith("data:")?i:`${i}?v=mbj0fdmv`}class Se{constructor(e,t,n,s=.2,r=1){this.x=e,this.y=t,this.text=n,this.speed=s,this.ttl=r}step(e){this.ttl-=e,this.y-=this.speed*e}draw(e){if(this.ttl<=0)return;const{w:t,h:n}=C(e.canvas),s=B();e.save(),e.globalAlpha=Math.max(0,this.ttl),e.fillStyle=Q,e.font=`${Math.round(s*.7)}px ${q}`,e.textAlign="center",e.textBaseline="middle",e.fillText(this.text,this.x*t,this.y*n),e.restore()}}const E=new m("Play");let k=0,T=0;const Ee=i=>Math.floor(Math.random()*i),ke=()=>$.length===0?"#FFFFFF":$[Math.floor(Math.random()*$.length)]??"#FFFFFF";function $e(i){let e=[],t=i.canvas.clientWidth,n=i.canvas.clientHeight,s=0;const r=new ge,a=new fe;let o=[],p=!1;const u=()=>{const{w:c,h:d}=C(i.canvas);if(t===0||n===0){t=c,n=d;return}const l=c/t,b=d/n;if(!Number.isFinite(l)||l===0||!Number.isFinite(b)||b===0){t=c,n=d;return}t=c,n=d},f=c=>{const d=i.canvas.getBoundingClientRect(),l=c.clientX-d.left,b=c.clientY-d.top,{w:R,h:ee}=C(i.canvas);for(let M=e.length-1;M>=0;M--){const w=e[M];if(w&&w.contains(l,b,R,ee)){w.pop(),x.playRoman(w.romaji),o.push(new Se(w.x,w.y,w.romaji,w.speed));break}}};return{update(c){if(!p)return;Y(i);const d=c;if(c=Math.min(d,.1),k+=d,T++,k>=1){const l=Math.round(T/k);m.isDebug&&E.debug("fps",l),k=0,T=0}if(s-=c,s<=0&&g.symbols&&g.symbols.length>0){const l=g.symbols[Ee(g.symbols.length)],b=g.randomGlyph(l),R=new he(Math.random(),1,ke(),b,l.roman);e.push(R),E.debug("spawned bubble",e.length),s=re}e.some(l=>!l.active)&&(e=e.filter(l=>l.active)),o.some(l=>l.ttl<=0)&&(o=o.filter(l=>l.ttl>0)),a.update(c),e.forEach(l=>l.step(c)),o.forEach(l=>l.step(c)),a.draw(i),e.forEach(l=>r.render(i,l)),o.forEach(l=>l.draw(i))},async enter(){E.info("Play screen entered"),await g.load("ja"),x.preloadAll(g.symbols.map(c=>`${g.currentCode}/${c.audio}`)).catch(c=>E.warn("audio preload",c)),p=!0,L.subscribe(u),u(),i.canvas.addEventListener("pointerdown",f)},exit(){E.info("Play screen exited"),L.unsubscribe(u),i.canvas.removeEventListener("pointerdown",f),e=[],o=[]}}}const V=document.querySelector("#game"),H=V.getContext("2d");x.armFirstGesture(window);L.watchCanvas(V);const P=new de;P.add("menu",ue(P,H)).add("play",$e(H));P.change("menu");let U=performance.now();function Z(i){const e=(i-U)/1e3;U=i,P.update(e),requestAnimationFrame(Z)}requestAnimationFrame(Z);
